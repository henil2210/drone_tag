{# 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Drone Tracker Dashboard</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* ================= SIDEBAR ================= */
    .sidebar {
      width: 160px;
      height: 100vh;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 70px;
      left: 0;
      z-index: 1000;
    }

    .sidebar-header { padding: 18px; border-bottom: 1px solid #e5e7eb; }
    .sidebar-title { font-size: 18px; font-weight: 600; color: #111827; }
    .sidebar-nav { display: flex; flex-direction: column; padding: 12px 8px; flex: 1; }
    .sidebar-item {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 14px 10px; margin-bottom: 10px; cursor: pointer; border-radius: 10px;
      transition: background 0.2s ease;
    }
    .sidebar-item:hover { background: #f3f4f6; }
    .item-top { display: flex; flex-direction: column; align-items: center; gap: 6px; }
    .sidebar-icon { width: 40px; height: 40px; color: #6366f1; }
    .sidebar-item span { font-size: 13px; color: #374151; }
    .chevron { margin-top: 6px; transition: transform 0.2s ease; color: #6b7280; }
    .chevron.rotate { transform: rotate(180deg); }
    .sidebar-dropdown { display: none; margin-left: 12px; margin-bottom: 10px; }
    .dropdown-item {
      display: flex; align-items: center; gap: 12px; padding: 10px 14px;
      font-size: 15px; font-weight: 500; color: #4b5563; cursor: pointer;
      border-radius: 8px;
    }
    .dropdown-item:hover { background: #eef2ff; }

    /* ================= TAG POPUP ================= */
    .tag-popup {
      position: fixed; top: 120px; left: 190px; width: 320px;
      background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      padding: 0; z-index: 2000;
      overflow: hidden;
      transition: max-height 0.3s ease;
      max-height: 0; /* collapsed by default */
    }

    .tag-popup-header {
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; padding: 16px;
      background: #f3f4f6; border-bottom: 1px solid #e5e7eb;
    }

    .tag-popup-header h4 { margin: 0; font-size: 16px; }

    .tag-popup-body {
      padding: 16px;
    }

    .tracker-dropdown-header {
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; padding: 8px 10px; background: #f9fafb;
      border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 6px;
    }

    .tracker-dropdown.collapsible {
      display: block;
      max-height: 160px; overflow-y: auto;
      border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 10px;
    }

    .tracker-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    border-bottom: 1px solid #eee;
    font-size: 14px;
  }

  .tracker-option input[type="checkbox"] {
    transform: scale(1.1);
    cursor: pointer;
  }

  .tracker-option input[type="color"] {
    width: 28px;
    height: 28px;
    border: none;
    padding: 0;
    cursor: pointer;
  }

  .tracker-option span {
    flex: 1;
    cursor: pointer;
  }

    .tracker-option:hover { background: #eef2ff; }

    .add-tracker { padding: 8px; display: flex; gap: 6px; border-top: 1px solid #e5e7eb; }
    .tag-input-row { display: flex; gap: 6px; margin-top: 10px; }
    .tag-input-row input { flex: 1; padding: 6px; }
    .tag-input-row button {
      padding: 6px 10px; background: #6366f1; color: white;
      border: none; border-radius: 6px; cursor: pointer;
    }





    .tag-popup {
  position: fixed;
  top: 90px;

  width: 320px;
  background: white;
  border-radius: 0 10px 10px 0;
  box-shadow: 8px 0 20px rgba(0,0,0,0.15);

  z-index: 2000;
  overflow: hidden;

  max-height: 0;
  transition: max-height 0.3s ease;
}



.tag-popup.collapsed {
  max-height: 48px !important; /* header only */
}

.tag-popup-body {
  display: block;
}

.tag-popup.collapsed .tag-popup-body {
  display: none;
}


/* Attached to sidebar */
#tagPopup {
  left: 160px;
}

#groupPopup {
  left: 160px;
}

#groupDetailPopup {
  left: 500px; /* 160 + 320 + spacing */
}


    /* ================= MAIN ================= */
    main { margin-left: 170px; padding: 10px; }
    #map { height: 650px; margin-top: 10px; }

    /* ================= IMAGE GRID ================= */
    #images-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
    .image-container { width: calc(25% - 10px); position: relative; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; }
    .image-container img { width: 100%; height: 120px; object-fit: cover; display: block; }

    /* ================= GROUP TRACKERS LIST ================= */
    .group-trackers {
      margin-top: 8px; padding-left: 12px;
      font-size: 13px; color: #4b5563;
    }

    .group-trackers div { padding: 3px 0; cursor: pointer; }
    .group-trackers div:hover { background: #eef2ff; border-radius: 4px; padding-left: 6px; }
  </style>
</head>

<body>

<header>
  <div class="logo-title">
    <img src="{{ url_for('static', filename='images/logo.svg') }}" class="logo">
    <span class="site-name">DRONE TAG</span>
  </div>
</header>

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar">
  <div class="sidebar-header"><span class="sidebar-title">Drone Tag</span></div>
  <nav class="sidebar-nav">
    <div class="sidebar-item">
      <i data-lucide="layout-dashboard" class="sidebar-icon"></i>
      <span>Dashboard</span>
    </div>

    <div class="sidebar-item" id="settingsToggle">
      <div class="item-top">
        <i data-lucide="settings" class="sidebar-icon"></i>
        <span>Settings</span>
      </div>
      <i data-lucide="chevron-down" class="chevron" id="settingsChevron"></i>
    </div>

    <div class="sidebar-dropdown" id="settingsDropdown">
      <div class="dropdown-item" id="openTagPopup">
        <i data-lucide="tag"></i><span>Tag</span>
      </div>
      <div class="dropdown-item">
        <i data-lucide="cpu"></i><span>Sensor</span>
      </div>
    </div>

    <div class="sidebar-item" id="reportsToggle">
      <div class="item-top">
        <i data-lucide="file-text" class="sidebar-icon"></i><span>Reports</span>
      </div>
      <i data-lucide="chevron-down" class="chevron" id="reportsChevron"></i>
    </div>

    <div class="sidebar-dropdown" id="reportsDropdown">
      <div class="dropdown-item" id="openGroupPopup">
        <i data-lucide="folder"></i><span>Group Name</span>
      </div>
    </div>
  </nav>
</aside>

<!-- ================= TAG POPUP ================= -->
<div class="tag-popup" id="tagPopup">
  <div class="tag-popup-header" id="tagPopupHeader">
    <h4>Tracker Popup</h4>
    <i data-lucide="chevron-down" class="chevron" id="tagPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="tagPopupBody">
    <div class="tracker-dropdown-header" id="trackerDropdownHeader">
      <span>Available Trackers</span>
      <i data-lucide="chevron-down" class="chevron" id="trackerChevron"></i>
    </div>
    <div class="tracker-dropdown collapsible" id="trackerList"></div>

    <div class="add-tracker">
      <input type="text" id="newTracker" placeholder="Add tracker ID">
      <button id="addTrackerBtn">+</button>
    </div>

    <div class="tag-input-row">
      <input type="text" id="tracker-id" placeholder="Manual Tracker ID">
      <button id="fetch-btn">Fetch</button>
    </div>
  </div>
</div>

<!-- ================= GROUP POPUP ================= -->
<div class="tag-popup" id="groupPopup">
  <div class="tag-popup-header" id="groupPopupHeader">
    <h4>Tracker Groups</h4>
    <i data-lucide="chevron-down" class="chevron" id="groupPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="groupPopupBody">
    <div class="tag-input-row">
      <input type="text" id="groupNameInput" placeholder="Group Name">
      <button id="createGroupBtn">Add Group</button>
    </div>

    <div id="groupList" class="tracker-dropdown collapsible" style="margin-top:10px;"></div>

    <div class="tag-input-row">
      <input type="text" id="groupTrackerInput" placeholder="Tracker ID">
      <button id="addTrackerToGroupBtn">Add</button>
    </div>

    <div class="tag-input-row">
      <button id="fetchGroupBtn" style="width:100%">Fetch Group</button>
    </div>
  </div>
</div>





<!-- ================= GROUP DETAIL POPUP ================= -->
<!-- ================= GROUP DETAIL POPUP ================= -->
<div class="tag-popup" id="groupDetailPopup">
  <div class="tag-popup-header">
    <h4 id="groupDetailTitle">Group</h4>
    <i data-lucide="chevron-down" class="chevron"></i>
  </div>

  <div class="tag-popup-body">

    <!-- Tracker list -->
    <div id="groupTrackerList" class="tracker-dropdown collapsible">
      <!-- JS will inject rows like:
      â˜‘ [Tracker ID] ðŸŽ¨
      -->
    </div>

    <!-- Add tracker to group -->
    <div class="tag-input-row" style="margin-top:10px;">
      <input
        type="text"
        id="groupDetailTrackerInput"
        placeholder="Add Tracker ID"
      />
      <button id="addTrackerToGroupDetailBtn">Add</button>
    </div>

  </div>
</div>





<main>
  <div id="status-message"></div>
  <div class="last-updated"></div>
  <div id="map"></div>
  <div id="images-grid"></div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="{{ url_for('static', filename='js/fetchdata.js') }}"></script>

<script>
lucide.createIcons();

function makePopupCollapsible(popupId, chevronId) {
  const popup = document.getElementById(popupId);
  const chevron = document.getElementById(chevronId);

  chevron.addEventListener("click", (e) => {
    e.stopPropagation(); // prevent parent clicks
    const collapsed = popup.classList.toggle("collapsed");
    chevron.classList.toggle("rotate", !collapsed);
  });
}

/* Enable collapse for all popups */
makePopupCollapsible("tagPopup", "tagPopupChevron");
makePopupCollapsible("groupPopup", "groupPopupChevron");

/* group detail popup chevron */
document
  .querySelector("#groupDetailPopup .chevron")
  .addEventListener("click", () => {
    groupDetailPopup.classList.toggle("collapsed");
  });

/* ================= SIDEBAR DROPDOWNS ================= */
function toggleMenu(toggleBtn, dropdown, chevron) {
  toggleBtn.addEventListener("click", () => {
    const open = dropdown.style.display === "block";
    dropdown.style.display = open ? "none" : "block";
    chevron.classList.toggle("rotate", !open);
  });
}

toggleMenu(
  document.getElementById("settingsToggle"),
  document.getElementById("settingsDropdown"),
  document.getElementById("settingsChevron")
);

toggleMenu(
  document.getElementById("reportsToggle"),
  document.getElementById("reportsDropdown"),
  document.getElementById("reportsChevron")
);

/* ================= STORAGE ================= */
const STORAGE_KEY = "saved_trackers";
const GROUP_KEY = "tracker_groups";
let activeGroup = null;

const getSavedTrackers = () =>
  JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

const saveTracker = (id) => {
  const trackers = getSavedTrackers();
  if (!trackers.includes(id)) {
    trackers.push(id);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(trackers));
  }
};

const getGroups = () =>
  JSON.parse(localStorage.getItem(GROUP_KEY)) || {};

const saveGroups = (groups) =>
  localStorage.setItem(GROUP_KEY, JSON.stringify(groups));

/* ================= TAG POPUP ================= */
const tagPopup = document.getElementById("tagPopup");
const tagPopupBody = document.getElementById("tagPopupBody");

document.getElementById("openTagPopup").onclick = () => {
  tagPopup.style.maxHeight = "600px";
  tagPopupBody.style.display = "block";
  renderTrackers();
};

const trackerList = document.getElementById("trackerList");
const trackerInput = document.getElementById("tracker-id");

function renderTrackers() {
  trackerList.innerHTML = "";
  getSavedTrackers().forEach(id => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = id;
    div.onclick = () => handleFetch(id);
    trackerList.appendChild(div);
  });
}

function handleFetch(id) {
  if (!id) return;
  trackerInput.value = id;
  saveTracker(id);
  renderTrackers();
  if (typeof fetchDroneData === "function") {
    fetchDroneData();
  }
}

document.getElementById("fetch-btn").onclick = () =>
  handleFetch(trackerInput.value.trim());

document.getElementById("addTrackerBtn").onclick = () => {
  const val = document.getElementById("newTracker").value.trim();
  if (!val) return;
  saveTracker(val);
  renderTrackers();
  document.getElementById("newTracker").value = "";
};

/* ================= GROUP POPUP ================= */
const groupPopup = document.getElementById("groupPopup");
const groupPopupBody = document.getElementById("groupPopupBody");
const groupList = document.getElementById("groupList");

document.getElementById("openGroupPopup").onclick = () => {
  groupPopup.style.maxHeight = "600px";
  groupPopupBody.style.display = "block";
  renderGroups();
};

function renderGroups() {
  groupList.innerHTML = "";
  const groups = getGroups();

  Object.keys(groups).forEach(groupName => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = groupName;

    div.addEventListener("click", () => {
      openGroupDetail(groupName);          // ðŸ‘ˆ OPEN GROUP
      groupDetailPopup.style.maxHeight = "600px"; // ðŸ‘ˆ SHOW POPUP
    });

    groupList.appendChild(div);
  });
}


document.getElementById("createGroupBtn").onclick = () => {
  const name = document.getElementById("groupNameInput").value.trim();
  if (!name) return;

  const groups = getGroups();
  if (!groups[name]) groups[name] = [];

  saveGroups(groups);
  document.getElementById("groupNameInput").value = "";
  renderGroups();
};

/* ================= GROUP DETAIL POPUP ================= */
/* const groupDetailPopup = document.getElementById("groupDetailPopup");
const groupTrackerList = document.getElementById("groupTrackerList");
const groupDetailTitle = document.getElementById("groupDetailTitle");

function openGroupDetail(groupName) {
  activeGroup = groupName;
  groupDetailTitle.textContent = groupName;

  const groups = getGroups();
  groupTrackerList.innerHTML = "";

  (groups[groupName] || []).forEach(tid => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = tid;
    div.onclick = () => handleFetch(tid);
    groupTrackerList.appendChild(div);
  });

  groupDetailPopup.style.maxHeight = "600px";
}

document.getElementById("addTrackerToGroupDetailBtn").onclick = () => {
  if (!activeGroup) return;

  const tracker = document
    .getElementById("groupDetailTrackerInput")
    .value.trim();

  if (!tracker) return;

  const groups = getGroups();
  if (!groups[activeGroup].includes(tracker)) {
    groups[activeGroup].push(tracker);
    saveGroups(groups);
  }

  document.getElementById("groupDetailTrackerInput").value = "";
  openGroupDetail(activeGroup);
};


document.getElementById("fetchGroupBtn").onclick = () => {
  if (!activeGroup) {
    alert("Select a group first");
    return;
  }

  const groups = getGroups();
  const trackerIds = groups[activeGroup] || [];

  if (trackerIds.length === 0) {
    alert("No trackers in this group");
    return;
  }

  fetchMultipleTrackers(trackerIds);
};

document.getElementById("fetchGroupBtn").onclick = () => {
  if (!activeGroup) return alert("Select a group first");
  const groups = getGroups();
  fetchGroupTrackers(groups[activeGroup]);
}; */


/* ================= GROUP DETAIL POPUP ================= */
const groupDetailPopup = document.getElementById("groupDetailPopup");
const groupTrackerList = document.getElementById("groupTrackerList");
const groupDetailTitle = document.getElementById("groupDetailTitle");

// Store group settings (visibility and colors) for each group
let groupSettings = JSON.parse(localStorage.getItem('groupSettings')) || {};

// Default color palette for trackers
const defaultColors = [
    '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', 
    '#EF476F', '#9D4EDD', '#FB5607', '#3A86FF', '#8338EC'
];

function openGroupDetail(groupName) {
    // Set active group globally
    if (window.setActiveGroup) {
        window.setActiveGroup(groupName);
    }
    
    activeGroup = groupName;
    groupDetailTitle.textContent = groupName;

    const groups = getGroups();
    groupTrackerList.innerHTML = "";

    // Initialize settings for this group if not exists
    if (!groupSettings[groupName]) {
        groupSettings[groupName] = {};
    }

    (groups[groupName] || []).forEach((tid, index) => {
        // Initialize tracker settings if not exists
        if (!groupSettings[groupName][tid]) {
            groupSettings[groupName][tid] = {
                visible: true,
                color: defaultColors[index % defaultColors.length]
            };
        }

        const div = document.createElement("div");
        div.className = "tracker-option";
        div.dataset.trackerId = tid;

        // Create checkbox container
        const checkboxContainer = document.createElement("div");
        checkboxContainer.className = "checkbox-container";
        
        // Create checkbox
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "tracker-checkbox";
        checkbox.checked = groupSettings[groupName][tid].visible;
        checkbox.dataset.trackerId = tid;
        
        // Create color picker (hidden - using color preview to trigger it)
        const colorPicker = document.createElement("input");
        colorPicker.type = "color";
        colorPicker.className = "tracker-color-picker";
        colorPicker.value = groupSettings[groupName][tid].color;
        colorPicker.dataset.trackerId = tid;
        colorPicker.style.display = "none"; // Hide the actual color picker
        
        // Create color preview (visible element users click on)
        const colorPreview = document.createElement("div");
        colorPreview.className = "color-preview";
        colorPreview.style.backgroundColor = groupSettings[groupName][tid].color;
        colorPreview.style.width = "20px";
        colorPreview.style.height = "20px";
        colorPreview.style.borderRadius = "4px";
        colorPreview.style.cursor = "pointer";
        colorPreview.style.border = "2px solid rgba(255, 255, 255, 0.3)";
        
        // Create tracker ID span
        const trackerIdSpan = document.createElement("span");
        trackerIdSpan.className = "tracker-id-text";
        trackerIdSpan.textContent = tid;
        trackerIdSpan.dataset.trackerId = tid;
        
        // Add click event to tracker ID (for single fetch)
        trackerIdSpan.onclick = () => {
            if (window.handleFetch) {
                window.handleFetch(tid);
            }
        };
        
        // Add event listeners for checkbox
        checkbox.onchange = (e) => {
            const trackerId = e.target.dataset.trackerId;
            const isVisible = e.target.checked;
            groupSettings[groupName][trackerId].visible = isVisible;
            saveGroupSettings();
            
            // Update visibility on map
            if (window.updateTrackerVisibilityFromGroup) {
                window.updateTrackerVisibilityFromGroup(trackerId, isVisible);
            }
        };
        
        // Add event listeners for color picker
        colorPicker.onchange = (e) => {
            const trackerId = e.target.dataset.trackerId;
            const newColor = e.target.value;
            groupSettings[groupName][trackerId].color = newColor;
            saveGroupSettings();
            
            // Update color preview
            colorPreview.style.backgroundColor = newColor;
            
            // Update color on map
            if (window.updateTrackerColorFromGroup) {
                window.updateTrackerColorFromGroup(trackerId, newColor);
            }
        };
        
        // Add click event to color preview to trigger color picker
        colorPreview.onclick = () => colorPicker.click();

        // Append all elements
        checkboxContainer.appendChild(checkbox);
        checkboxContainer.appendChild(colorPreview);
        div.appendChild(checkboxContainer);
        div.appendChild(colorPicker);
        div.appendChild(trackerIdSpan);
        groupTrackerList.appendChild(div);
    });

    groupDetailPopup.style.maxHeight = "600px";
    saveGroupSettings();
}

function saveGroupSettings() {
    localStorage.setItem('groupSettings', JSON.stringify(groupSettings));
}

// Function to get all visible trackers in a group
function getVisibleTrackersInGroup(groupName) {
    const groups = getGroups();
    const trackers = groups[groupName] || [];
    
    return trackers.filter(tid => {
        return groupSettings[groupName] && 
               groupSettings[groupName][tid] && 
               groupSettings[groupName][tid].visible;
    });
}

// Add tracker to group
document.getElementById("addTrackerToGroupDetailBtn").onclick = () => {
    if (!activeGroup) return;

    const tracker = document
        .getElementById("groupDetailTrackerInput")
        .value.trim();

    if (!tracker) return;

    const groups = getGroups();
    if (!groups[activeGroup].includes(tracker)) {
        groups[activeGroup].push(tracker);
        saveGroups(groups);
        
        // Initialize settings for new tracker
        if (!groupSettings[activeGroup]) {
            groupSettings[activeGroup] = {};
        }
        const index = groups[activeGroup].length - 1;
        groupSettings[activeGroup][tracker] = {
            visible: true,
            color: defaultColors[index % defaultColors.length]
        };
        saveGroupSettings();
    }

    document.getElementById("groupDetailTrackerInput").value = "";
    openGroupDetail(activeGroup);
};

// Fetch group button
document.getElementById("fetchGroupBtn").onclick = () => {
    if (!activeGroup) {
        alert("Select a group first");
        return;
    }

    const groups = getGroups();
    const trackerIds = groups[activeGroup] || [];

    if (trackerIds.length === 0) {
        alert("No trackers in this group");
        return;
    }

    // Use the global fetchGroupTrackers function
    if (window.fetchGroupTrackers) {
        window.fetchGroupTrackers(trackerIds);
    }
};

// Function to reset group settings
function resetGroupSettings(groupName) {
    if (confirm(`Reset all settings for group "${groupName}"?`)) {
        delete groupSettings[groupName];
        saveGroupSettings();
        openGroupDetail(groupName);
    }
}

// Function to select all/none trackers in current group
function toggleAllTrackers(selectAll) {
    if (!activeGroup) return;
    
    const groups = getGroups();
    (groups[activeGroup] || []).forEach(tid => {
        if (groupSettings[activeGroup] && groupSettings[activeGroup][tid]) {
            groupSettings[activeGroup][tid].visible = selectAll;
            
            // Update checkbox if it exists in DOM
            const checkbox = document.querySelector(`.tracker-checkbox[data-tracker-id="${tid}"]`);
            if (checkbox) {
                checkbox.checked = selectAll;
            }
            
            // Update visibility on map
            if (window.updateTrackerVisibilityFromGroup) {
                window.updateTrackerVisibilityFromGroup(tid, selectAll);
            }
        }
    });
    saveGroupSettings();
}

// Add CSS styles for the new elements
const style = document.createElement('style');
style.textContent = `
    .tracker-option {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        margin: 5px 0;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        transition: background 0.2s;
    }
    
    .tracker-option:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .checkbox-container {
        display: flex;
        align-items: center;
        margin-right: 10px;
        gap: 8px;
    }
    
    .tracker-checkbox {
        cursor: pointer;
        width: 16px;
        height: 16px;
    }
    
    .color-preview {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        cursor: pointer;
        border: 2px solid rgba(255, 255, 255, 0.3);
        transition: border-color 0.2s;
    }
    
    .color-preview:hover {
        border-color: rgba(255, 255, 255, 0.6);
    }
    
    .tracker-color-picker {
        display: none;
    }
    
    .tracker-id-text {
        flex: 1;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background 0.2s;
    }
    
    .tracker-id-text:hover {
        background: rgba(0, 123, 255, 0.2);
    }
    
    .group-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .group-control-btn {
        padding: 6px 12px;
        background: rgba(0, 123, 255, 0.8);
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
    }
    
    .group-control-btn:hover {
        background: rgba(0, 123, 255, 1);
    }
`;

document.head.appendChild(style);

// Add control buttons to group detail
function addGroupControls() {
    // Remove existing controls if any
    const existingControls = document.querySelector('.group-controls');
    if (existingControls) {
        existingControls.remove();
    }
    
    // Create control buttons container
    const controlsContainer = document.createElement('div');
    controlsContainer.className = 'group-controls';
    controlsContainer.innerHTML = `
        <button onclick="toggleAllTrackers(true)" class="group-control-btn">Select All</button>
        <button onclick="toggleAllTrackers(false)" class="group-control-btn">Deselect All</button>
        <button onclick="resetGroupSettings('${activeGroup}')" class="group-control-btn">Reset Settings</button>
    `;
    
    // Insert controls at the beginning of group detail popup
    const groupDetailContent = document.querySelector('.group-detail-content');
    if (groupDetailContent) {
        groupDetailContent.insertBefore(controlsContainer, groupTrackerList);
    }
}

// Modify openGroupDetail to include controls
const originalOpenGroupDetail = openGroupDetail;
openGroupDetail = function(groupName) {
    originalOpenGroupDetail(groupName);
    addGroupControls();
};



/* ================= INIT ================= */
renderTrackers();
renderGroups();
</script>


</body>
</html> 
 #}






































{#recent#}
{# <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Drone Tracker Dashboard</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* ================= SIDEBAR ================= */
    .sidebar {
      width: 160px;
      height: 100vh;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 70px;
      left: 0;
      z-index: 1000;
    }

    .sidebar-header { padding: 18px; border-bottom: 1px solid #e5e7eb; }
    .sidebar-title { font-size: 18px; font-weight: 600; color: #111827; }
    .sidebar-nav { display: flex; flex-direction: column; padding: 12px 8px; flex: 1; }
    .sidebar-item {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 14px 10px; margin-bottom: 10px; cursor: pointer; border-radius: 10px;
      transition: background 0.2s ease;
    }
    .sidebar-item:hover { background: #f3f4f6; }
    .item-top { display: flex; flex-direction: column; align-items: center; gap: 6px; }
    .sidebar-icon { width: 40px; height: 40px; color: #6366f1; }
    .sidebar-item span { font-size: 13px; color: #374151; }
    .chevron { margin-top: 6px; transition: transform 0.2s ease; color: #6b7280; }
    .chevron.rotate { transform: rotate(180deg); }
    .sidebar-dropdown { display: none; margin-left: 12px; margin-bottom: 10px; }
    .dropdown-item {
      display: flex; align-items: center; gap: 12px; padding: 10px 14px;
      font-size: 15px; font-weight: 500; color: #4b5563; cursor: pointer;
      border-radius: 8px;
    }
    .dropdown-item:hover { background: #eef2ff; }

    /* ================= TAG POPUP ================= */
    .tag-popup {
      position: fixed; top: 120px; left: 190px; width: 320px;
      background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      padding: 0; z-index: 2000;
      overflow: hidden;
      transition: max-height 0.3s ease;
      max-height: 0; /* collapsed by default */
    }

    .tag-popup-header {
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; padding: 16px;
      background: #f3f4f6; border-bottom: 1px solid #e5e7eb;
    }

    .tag-popup-header h4 { margin: 0; font-size: 16px; }

    .tag-popup-body {
      padding: 16px;
    }

    .tracker-dropdown-header {
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; padding: 8px 10px; background: #f9fafb;
      border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 6px;
    }

    .tracker-dropdown.collapsible {
      display: block;
      max-height: 160px; overflow-y: auto;
      border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 10px;
    }

    .tracker-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    border-bottom: 1px solid #eee;
    font-size: 14px;
  }

  .tracker-option input[type="checkbox"] {
    transform: scale(1.1);
    cursor: pointer;
  }

  .tracker-option input[type="color"] {
    width: 28px;
    height: 28px;
    border: none;
    padding: 0;
    cursor: pointer;
  }

  .tracker-option span {
    flex: 1;
    cursor: pointer;
  }

    .tracker-option:hover { background: #eef2ff; }

    .add-tracker { padding: 8px; display: flex; gap: 6px; border-top: 1px solid #e5e7eb; }
    .tag-input-row { display: flex; gap: 6px; margin-top: 10px; }
    .tag-input-row input { flex: 1; padding: 6px; }
    .tag-input-row button {
      padding: 6px 10px; background: #6366f1; color: white;
      border: none; border-radius: 6px; cursor: pointer;
    }

    .tag-popup {
  position: fixed;
  top: 90px;

  width: 320px;
  background: white;
  border-radius: 0 10px 10px 0;
  box-shadow: 8px 0 20px rgba(0,0,0,0.15);

  z-index: 2000;
  overflow: hidden;

  max-height: 0;
  transition: max-height 0.3s ease;
}

.tag-popup.collapsed {
  max-height: 48px !important; /* header only */
}

.tag-popup-body {
  display: block;
}

.tag-popup.collapsed .tag-popup-body {
  display: none;
}

/* Attached to sidebar */
#tagPopup {
  left: 160px;
}

#groupPopup {
  left: 160px;
}

#groupDetailPopup {
  left: 500px; /* 160 + 320 + spacing */
}

#realtimePopup {
  left: 160px;
  top: 140px;
}

    /* ================= MAIN ================= */
    main { margin-left: 170px; padding: 10px; }
    #map { height: 650px; margin-top: 10px; }

    /* ================= REALTIME DATA TABLE PANEL ================= */
    #realtimeTablePanel {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: all 0.3s ease;
      max-height: 400px;
      overflow: hidden;
    }

    #realtimeTablePanel.minimized {
      max-height: 40px;
    }

    #realtimeTablePanelHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
    }

    #realtimeTablePanelHeader h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    #realtimeTablePanelChevron {
      transition: transform 0.3s ease;
    }

    #realtimeTablePanelChevron.rotated {
      transform: rotate(180deg);
    }

    #realtimeTableContainer {
      padding: 15px;
      max-height: 350px;
      overflow-y: auto;
    }

    #realtimeDataTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    #realtimeDataTable th {
      background: #f9fafb;
      padding: 8px 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 0;
    }

    #realtimeDataTable td {
      padding: 8px 12px;
      border-bottom: 1px solid #f3f4f6;
      color: #4b5563;
    }

    #realtimeDataTable tr:hover {
      background: #f9fafb;
    }

    .tracker-id-cell {
      font-weight: 600;
      color: #6366f1;
    }

    .no-data-row td {
      text-align: center;
      padding: 20px;
      color: #9ca3af;
      font-style: italic;
    }

    /* ================= IMAGE GRID ================= */
    #images-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
    .image-container { width: calc(25% - 10px); position: relative; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; }
    .image-container img { width: 100%; height: 120px; object-fit: cover; display: block; }

    /* ================= GROUP TRACKERS LIST ================= */
    .group-trackers {
      margin-top: 8px; padding-left: 12px;
      font-size: 13px; color: #4b5563;
    }

    .group-trackers div { padding: 3px 0; cursor: pointer; }
    .group-trackers div:hover { background: #eef2ff; border-radius: 4px; padding-left: 6px; }

    /* ================= REALTIME DATA STYLES ================= */
    .parameter-option {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      cursor: pointer;
    }

    .parameter-option:hover {
      background: #f9fafb;
    }

    .parameter-option input[type="checkbox"] {
      margin-right: 10px;
      cursor: pointer;
      transform: scale(1.1);
    }

    .parameter-option label {
      cursor: pointer;
      flex: 1;
      user-select: none;
    }

    .realtime-tracker-item {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .realtime-tracker-item:hover {
      background: #eef2ff;
    }

    .realtime-tracker-id {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }

    .realtime-tracker-checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .group-expand-btn {
      margin-left: 8px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .group-expand-btn.rotated {
      transform: rotate(90deg);
    }

    .realtime-group-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      background: #f9fafb;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 5px;
    }

    .realtime-group-header:hover {
      background: #f3f4f6;
    }

    .realtime-group-name {
      flex: 1;
      font-weight: 600;
      color: #374151;
    }

    .realtime-tracker-list {
      margin-left: 15px;
      border-left: 2px solid #e5e7eb;
      padding-left: 10px;
    }

    .group-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .group-control-btn {
      padding: 6px 12px;
      background: rgba(0, 123, 255, 0.8);
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    .group-control-btn:hover {
      background: rgba(0, 123, 255, 1);
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
  </style>
</head>

<body>

<header>
  <div class="logo-title">
    <img src="{{ url_for('static', filename='images/logo.svg') }}" class="logo">
    <span class="site-name">DRONE TAG</span>
  </div>
</header>

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar">
  <div class="sidebar-header"><span class="sidebar-title">Drone Tag</span></div>
  <nav class="sidebar-nav">
    <div class="sidebar-item">
      <i data-lucide="layout-dashboard" class="sidebar-icon"></i>
      <span>Dashboard</span>
    </div>

    <div class="sidebar-item" id="settingsToggle">
      <div class="item-top">
        <i data-lucide="settings" class="sidebar-icon"></i>
        <span>Settings</span>
      </div>
      <i data-lucide="chevron-down" class="chevron" id="settingsChevron"></i>
    </div>

    <div class="sidebar-dropdown" id="settingsDropdown">
      <div class="dropdown-item" id="openTagPopup">
        <i data-lucide="tag"></i><span>Tag</span>
      </div>
      <div class="dropdown-item">
        <i data-lucide="cpu"></i><span>Sensor</span>
      </div>
      <div class="dropdown-item" id="openRealtimePopup">
        <i data-lucide="activity"></i><span>Real-time Data</span>
      </div>
    </div>

    <div class="sidebar-item" id="reportsToggle">
      <div class="item-top">
        <i data-lucide="file-text" class="sidebar-icon"></i><span>Reports</span>
      </div>
      <i data-lucide="chevron-down" class="chevron" id="reportsChevron"></i>
    </div>

    <div class="sidebar-dropdown" id="reportsDropdown">
      <div class="dropdown-item" id="openGroupPopup">
        <i data-lucide="folder"></i><span>Group Name</span>
      </div>
    </div>
  </nav>
</aside>

<!-- ================= TAG POPUP ================= -->
<div class="tag-popup" id="tagPopup">
  <div class="tag-popup-header" id="tagPopupHeader">
    <h4>Tracker Popup</h4>
    <i data-lucide="chevron-down" class="chevron" id="tagPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="tagPopupBody">
    <div class="tracker-dropdown-header" id="trackerDropdownHeader">
      <span>Available Trackers</span>
      <i data-lucide="chevron-down" class="chevron" id="trackerChevron"></i>
    </div>
    <div class="tracker-dropdown collapsible" id="trackerList"></div>

    <div class="add-tracker">
      <input type="text" id="newTracker" placeholder="Add tracker ID">
      <button id="addTrackerBtn">+</button>
    </div>

    <div class="tag-input-row">
      <input type="text" id="tracker-id" placeholder="Manual Tracker ID">
      <button id="fetch-btn">Fetch</button>
    </div>
  </div>
</div>

<!-- ================= GROUP POPUP ================= -->
<div class="tag-popup" id="groupPopup">
  <div class="tag-popup-header" id="groupPopupHeader">
    <h4>Tracker Groups</h4>
    <i data-lucide="chevron-down" class="chevron" id="groupPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="groupPopupBody">
    <div class="tag-input-row">
      <input type="text" id="groupNameInput" placeholder="Group Name">
      <button id="createGroupBtn">Add Group</button>
    </div>

    <div id="groupList" class="tracker-dropdown collapsible" style="margin-top:10px;"></div>

    <div class="tag-input-row">
      <input type="text" id="groupTrackerInput" placeholder="Tracker ID">
      <button id="addTrackerToGroupBtn">Add</button>
    </div>

    <div class="tag-input-row">
      <button id="fetchGroupBtn" style="width:100%">Fetch Group</button>
    </div>
  </div>
</div>

<!-- ================= GROUP DETAIL POPUP ================= -->
<div class="tag-popup" id="groupDetailPopup">
  <div class="tag-popup-header">
    <h4 id="groupDetailTitle">Group</h4>
    <i data-lucide="chevron-down" class="chevron"></i>
  </div>

  <div class="tag-popup-body">
    <!-- Tracker list -->
    <div id="groupTrackerList" class="tracker-dropdown collapsible">
      <!-- JS will inject rows -->
    </div>

    <!-- Add tracker to group -->
    <div class="tag-input-row" style="margin-top:10px;">
      <input
        type="text"
        id="groupDetailTrackerInput"
        placeholder="Add Tracker ID"
      />
      <button id="addTrackerToGroupDetailBtn">Add</button>
    </div>
  </div>
</div>

<!-- ================= REALTIME DATA POPUP ================= -->
<div class="tag-popup" id="realtimePopup">
  <div class="tag-popup-header" id="realtimePopupHeader">
    <h4>Real-time Data Parameters</h4>
    <i data-lucide="chevron-down" class="chevron" id="realtimePopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="realtimePopupBody">
    <!-- Group dropdown -->
    <div class="tracker-dropdown-header" id="realtimeGroupHeader">
      <span>Select Group</span>
      <i data-lucide="chevron-down" class="chevron" id="realtimeGroupChevron"></i>
    </div>
    
    <div class="tracker-dropdown collapsible" id="realtimeGroupList"></div>

    <!-- Tracker parameters section (shown when tracker is selected) -->
    <div id="trackerParametersSection" style="display: none;">
      <div style="margin: 15px 0 10px 0; font-weight: 600; color: #374151;">
        Selected Tracker: <span id="selectedTrackerId">-</span>
      </div>
      
      <div id="parametersCheckboxes" class="tracker-dropdown collapsible" style="max-height: 200px;">
        <!-- Checkboxes will be added here -->
      </div>
      
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
        <button id="saveParametersBtn" style="width: 100%; padding: 8px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
          Save Parameters
        </button>
      </div>
    </div>
  </div>
</div>

<main>
  <div id="status-message"></div>
  <div class="last-updated"></div>
  <div id="map"></div>
  
  <!-- ================= REALTIME DATA TABLE PANEL ================= -->
  <div id="realtimeTablePanel" class="minimized">
    <div id="realtimeTablePanelHeader">
      <h3>Real-time Data Table</h3>
      <i data-lucide="chevron-up" id="realtimeTablePanelChevron" class="rotated"></i>
    </div>
    <div id="realtimeTableContainer" style="display: none;">
      <table id="realtimeDataTable">
        <thead>
          <tr>
            <th>Tracker ID</th>
            <!-- Dynamic headers will be added here -->
          </tr>
        </thead>
        <tbody>
          <!-- Dynamic rows will be added here -->
        </tbody>
      </table>
    </div>
  </div>
  
  <div id="images-grid"></div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="{{ url_for('static', filename='js/fetchdata.js') }}"></script>

<script>
lucide.createIcons();

function makePopupCollapsible(popupId, chevronId) {
  const popup = document.getElementById(popupId);
  const chevron = document.getElementById(chevronId);

  chevron.addEventListener("click", (e) => {
    e.stopPropagation(); // prevent parent clicks
    const collapsed = popup.classList.toggle("collapsed");
    chevron.classList.toggle("rotate", !collapsed);
  });
}

/* Enable collapse for all popups */
makePopupCollapsible("tagPopup", "tagPopupChevron");
makePopupCollapsible("groupPopup", "groupPopupChevron");
makePopupCollapsible("realtimePopup", "realtimePopupChevron");

/* group detail popup chevron */
document
  .querySelector("#groupDetailPopup .chevron")
  .addEventListener("click", () => {
    groupDetailPopup.classList.toggle("collapsed");
  });

/* ================= REALTIME TABLE PANEL ================= */
const realtimeTablePanel = document.getElementById('realtimeTablePanel');
const realtimeTablePanelHeader = document.getElementById('realtimeTablePanelHeader');
const realtimeTablePanelChevron = document.getElementById('realtimeTablePanelChevron');
const realtimeTableContainer = document.getElementById('realtimeTableContainer');
const realtimeDataTable = document.getElementById('realtimeDataTable');

// Toggle panel visibility
realtimeTablePanelHeader.addEventListener('click', () => {
  const isMinimized = realtimeTablePanel.classList.toggle('minimized');
  realtimeTablePanelChevron.classList.toggle('rotated', isMinimized);
  
  if (isMinimized) {
    realtimeTableContainer.style.display = 'none';
  } else {
    realtimeTableContainer.style.display = 'block';
    // Update table when opening
    if (window.realtimeTableData && Object.keys(window.realtimeTableData).length > 0) {
      updateRealtimeTable();
    }
  }
});

// Store real-time table data
window.realtimeTableData = {};
window.realtimeTableHeaders = ['Tracker ID'];

// Function to update the real-time data table
window.updateRealtimeTable = function(trackerId, data) {
  // Store or update data for this tracker
  if (trackerId && data) {
    window.realtimeTableData[trackerId] = data;
  }
  
  // Get all selected parameters across all trackers
  const allSelectedParams = new Set(['Tracker ID']);
  
  // Collect all parameters that are selected for any tracker
  Object.keys(window.realtimeTableData).forEach(tid => {
    const params = window.getRealtimeParameters ? window.getRealtimeParameters(tid) : null;
    if (params) {
      Object.keys(params).forEach(param => {
        if (params[param]) {
          allSelectedParams.add(param);
        }
      });
    }
  });
  
  // Update headers
  window.realtimeTableHeaders = Array.from(allSelectedParams);
  
  // Update table headers
  const thead = realtimeDataTable.querySelector('thead');
  const headerRow = thead.querySelector('tr');
  headerRow.innerHTML = '';
  
  window.realtimeTableHeaders.forEach(header => {
    const th = document.createElement('th');
    th.textContent = formatHeaderText(header);
    headerRow.appendChild(th);
  });
  
  // Update table body
  const tbody = realtimeDataTable.querySelector('tbody');
  tbody.innerHTML = '';
  
  if (Object.keys(window.realtimeTableData).length === 0) {
    const noDataRow = document.createElement('tr');
    noDataRow.className = 'no-data-row';
    const td = document.createElement('td');
    td.colSpan = window.realtimeTableHeaders.length;
    td.textContent = 'No real-time data available. Fetch a tracker first.';
    noDataRow.appendChild(td);
    tbody.appendChild(noDataRow);
    return;
  }
  
  // Create rows for each tracker
  Object.keys(window.realtimeTableData).forEach(tid => {
    const row = document.createElement('tr');
    
    window.realtimeTableHeaders.forEach(header => {
      const td = document.createElement('td');
      
      if (header === 'Tracker ID') {
        td.className = 'tracker-id-cell';
        td.textContent = tid;
      } else {
        // Get parameter settings for this tracker
        const params = window.getRealtimeParameters ? window.getRealtimeParameters(tid) : null;
        
        if (params && params[header] && window.realtimeTableData[tid][header]) {
          td.textContent = formatCellValue(header, window.realtimeTableData[tid][header]);
        } else {
          td.textContent = '-';
          td.style.color = '#9ca3af';
        }
      }
      
      row.appendChild(td);
    });
    
    tbody.appendChild(row);
  });
};

// Helper function to format header text
function formatHeaderText(header) {
  const formatMap = {
    'timestamp': 'Timestamp',
    'latitude': 'Latitude',
    'longitude': 'Longitude',
    'altitude': 'Altitude',
    'uin_no': 'UIN No',
    'application': 'Application',
    'category': 'Category',
    'Tracker ID': 'Tracker ID'
  };
  
  return formatMap[header] || header;
}

// Helper function to format cell values
function formatCellValue(header, value) {
  if (header === 'timestamp' && value) {
    try {
      return new Date(value).toLocaleString();
    } catch (e) {
      return value;
    }
  }
  
  if ((header === 'latitude' || header === 'longitude') && value) {
    return parseFloat(value).toFixed(6);
  }
  
  if (header === 'altitude' && value) {
    return `${parseFloat(value).toFixed(1)} m`;
  }
  
  return value || '-';
}

// Initialize table
window.updateRealtimeTable();

/* ================= SIDEBAR DROPDOWNS ================= */
function toggleMenu(toggleBtn, dropdown, chevron) {
  toggleBtn.addEventListener("click", () => {
    const open = dropdown.style.display === "block";
    dropdown.style.display = open ? "none" : "block";
    chevron.classList.toggle("rotate", !open);
  });
}

toggleMenu(
  document.getElementById("settingsToggle"),
  document.getElementById("settingsDropdown"),
  document.getElementById("settingsChevron")
);

toggleMenu(
  document.getElementById("reportsToggle"),
  document.getElementById("reportsDropdown"),
  document.getElementById("reportsChevron")
);

/* ================= STORAGE ================= */
const STORAGE_KEY = "saved_trackers";
const GROUP_KEY = "tracker_groups";
const REALTIME_SETTINGS_KEY = "realtime_parameters";
let activeGroup = null;
let selectedTrackerForRealtime = null;

const getSavedTrackers = () =>
  JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

const saveTracker = (id) => {
  const trackers = getSavedTrackers();
  if (!trackers.includes(id)) {
    trackers.push(id);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(trackers));
  }
};

const getGroups = () =>
  JSON.parse(localStorage.getItem(GROUP_KEY)) || {};

const saveGroups = (groups) =>
  localStorage.setItem(GROUP_KEY, JSON.stringify(groups));

/* ================= REALTIME DATA SETTINGS ================= */
const getRealtimeSettings = () => 
  JSON.parse(localStorage.getItem(REALTIME_SETTINGS_KEY)) || {};

const saveRealtimeSettings = (settings) =>
  localStorage.setItem(REALTIME_SETTINGS_KEY, JSON.stringify(settings));

// Define available parameters
const availableParameters = [
  { id: 'timestamp', label: 'Timestamp', default: true },
  { id: 'latitude', label: 'Latitude', default: true },
  { id: 'longitude', label: 'Longitude', default: true },
  { id: 'altitude', label: 'Altitude', default: true },
  { id: 'uin_no', label: 'UIN No', default: true },
  { id: 'application', label: 'Application', default: true },
  { id: 'category', label: 'Category', default: true }
];

/* ================= TAG POPUP ================= */
const tagPopup = document.getElementById("tagPopup");
const tagPopupBody = document.getElementById("tagPopupBody");

document.getElementById("openTagPopup").onclick = () => {
  tagPopup.style.maxHeight = "600px";
  tagPopupBody.style.display = "block";
  renderTrackers();
};

const trackerList = document.getElementById("trackerList");
const trackerInput = document.getElementById("tracker-id");

function renderTrackers() {
  trackerList.innerHTML = "";
  getSavedTrackers().forEach(id => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = id;
    div.onclick = () => handleFetch(id);
    trackerList.appendChild(div);
  });
}

function handleFetch(id) {
  if (!id) return;
  trackerInput.value = id;
  saveTracker(id);
  renderTrackers();
  if (typeof fetchDroneData === "function") {
    fetchDroneData();
  }
}

document.getElementById("fetch-btn").onclick = () =>
  handleFetch(trackerInput.value.trim());

document.getElementById("addTrackerBtn").onclick = () => {
  const val = document.getElementById("newTracker").value.trim();
  if (!val) return;
  saveTracker(val);
  renderTrackers();
  document.getElementById("newTracker").value = "";
};

/* ================= GROUP POPUP ================= */
const groupPopup = document.getElementById("groupPopup");
const groupPopupBody = document.getElementById("groupPopupBody");
const groupList = document.getElementById("groupList");

document.getElementById("openGroupPopup").onclick = () => {
  groupPopup.style.maxHeight = "600px";
  groupPopupBody.style.display = "block";
  renderGroups();
};

function renderGroups() {
  groupList.innerHTML = "";
  const groups = getGroups();

  Object.keys(groups).forEach(groupName => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = groupName;

    div.addEventListener("click", () => {
      openGroupDetail(groupName);          // ðŸ‘ˆ OPEN GROUP
      groupDetailPopup.style.maxHeight = "600px"; // ðŸ‘ˆ SHOW POPUP
    });

    groupList.appendChild(div);
  });
}

document.getElementById("createGroupBtn").onclick = () => {
  const name = document.getElementById("groupNameInput").value.trim();
  if (!name) return;

  const groups = getGroups();
  if (!groups[name]) groups[name] = [];

  saveGroups(groups);
  document.getElementById("groupNameInput").value = "";
  renderGroups();
};

/* ================= GROUP DETAIL POPUP ================= */
const groupDetailPopup = document.getElementById("groupDetailPopup");
const groupTrackerList = document.getElementById("groupTrackerList");
const groupDetailTitle = document.getElementById("groupDetailTitle");

// Store group settings (visibility and colors) for each group
let groupSettings = JSON.parse(localStorage.getItem('groupSettings')) || {};

// Default color palette for trackers
const defaultColors = [
    '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', 
    '#EF476F', '#9D4EDD', '#FB5607', '#3A86FF', '#8338EC'
];

function openGroupDetail(groupName) {
    // Set active group globally
    if (window.setActiveGroup) {
        window.setActiveGroup(groupName);
    }
    
    activeGroup = groupName;
    groupDetailTitle.textContent = groupName;

    const groups = getGroups();
    groupTrackerList.innerHTML = "";

    // Initialize settings for this group if not exists
    if (!groupSettings[groupName]) {
        groupSettings[groupName] = {};
    }

    (groups[groupName] || []).forEach((tid, index) => {
        // Initialize tracker settings if not exists
        if (!groupSettings[groupName][tid]) {
            groupSettings[groupName][tid] = {
                visible: true,
                color: defaultColors[index % defaultColors.length]
            };
        }

        const div = document.createElement("div");
        div.className = "tracker-option";
        div.dataset.trackerId = tid;

        // Create checkbox container
        const checkboxContainer = document.createElement("div");
        checkboxContainer.className = "checkbox-container";
        
        // Create checkbox
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "tracker-checkbox";
        checkbox.checked = groupSettings[groupName][tid].visible;
        checkbox.dataset.trackerId = tid;
        
        // Create color picker (hidden - using color preview to trigger it)
        const colorPicker = document.createElement("input");
        colorPicker.type = "color";
        colorPicker.className = "tracker-color-picker";
        colorPicker.value = groupSettings[groupName][tid].color;
        colorPicker.dataset.trackerId = tid;
        colorPicker.style.display = "none"; // Hide the actual color picker
        
        // Create color preview (visible element users click on)
        const colorPreview = document.createElement("div");
        colorPreview.className = "color-preview";
        colorPreview.style.backgroundColor = groupSettings[groupName][tid].color;
        colorPreview.style.width = "20px";
        colorPreview.style.height = "20px";
        colorPreview.style.borderRadius = "4px";
        colorPreview.style.cursor = "pointer";
        colorPreview.style.border = "2px solid rgba(255, 255, 255, 0.3)";
        
        // Create tracker ID span
        const trackerIdSpan = document.createElement("span");
        trackerIdSpan.className = "tracker-id-text";
        trackerIdSpan.textContent = tid;
        trackerIdSpan.dataset.trackerId = tid;
        
        // Add click event to tracker ID (for single fetch)
        trackerIdSpan.onclick = () => {
            if (window.handleFetch) {
                window.handleFetch(tid);
            }
        };
        
        // Add event listeners for checkbox
        checkbox.onchange = (e) => {
            const trackerId = e.target.dataset.trackerId;
            const isVisible = e.target.checked;
            groupSettings[groupName][trackerId].visible = isVisible;
            saveGroupSettings();
            
            // Update visibility on map
            if (window.updateTrackerVisibilityFromGroup) {
                window.updateTrackerVisibilityFromGroup(trackerId, isVisible);
            }
        };
        
        // Add event listeners for color picker
        colorPicker.onchange = (e) => {
            const trackerId = e.target.dataset.trackerId;
            const newColor = e.target.value;
            groupSettings[groupName][trackerId].color = newColor;
            saveGroupSettings();
            
            // Update color preview
            colorPreview.style.backgroundColor = newColor;
            
            // Update color on map
            if (window.updateTrackerColorFromGroup) {
                window.updateTrackerColorFromGroup(trackerId, newColor);
            }
        };
        
        // Add click event to color preview to trigger color picker
        colorPreview.onclick = () => colorPicker.click();

        // Append all elements
        checkboxContainer.appendChild(checkbox);
        checkboxContainer.appendChild(colorPreview);
        div.appendChild(checkboxContainer);
        div.appendChild(colorPicker);
        div.appendChild(trackerIdSpan);
        groupTrackerList.appendChild(div);
    });

    groupDetailPopup.style.maxHeight = "600px";
    saveGroupSettings();
}

function saveGroupSettings() {
    localStorage.setItem('groupSettings', JSON.stringify(groupSettings));
}

// Function to get all visible trackers in a group
function getVisibleTrackersInGroup(groupName) {
    const groups = getGroups();
    const trackers = groups[groupName] || [];
    
    return trackers.filter(tid => {
        return groupSettings[groupName] && 
               groupSettings[groupName][tid] && 
               groupSettings[groupName][tid].visible;
    });
}

// Add tracker to group
document.getElementById("addTrackerToGroupDetailBtn").onclick = () => {
    if (!activeGroup) return;

    const tracker = document
        .getElementById("groupDetailTrackerInput")
        .value.trim();

    if (!tracker) return;

    const groups = getGroups();
    if (!groups[activeGroup].includes(tracker)) {
        groups[activeGroup].push(tracker);
        saveGroups(groups);
        
        // Initialize settings for new tracker
        if (!groupSettings[activeGroup]) {
            groupSettings[activeGroup] = {};
        }
        const index = groups[activeGroup].length - 1;
        groupSettings[activeGroup][tracker] = {
            visible: true,
            color: defaultColors[index % defaultColors.length]
        };
        saveGroupSettings();
    }

    document.getElementById("groupDetailTrackerInput").value = "";
    openGroupDetail(activeGroup);
};

// Fetch group button
document.getElementById("fetchGroupBtn").onclick = () => {
    if (!activeGroup) {
        alert("Select a group first");
        return;
    }

    const groups = getGroups();
    const trackerIds = groups[activeGroup] || [];

    if (trackerIds.length === 0) {
        alert("No trackers in this group");
        return;
    }

    // Use the global fetchGroupTrackers function
    if (window.fetchGroupTrackers) {
        window.fetchGroupTrackers(trackerIds);
    }
};

/* ================= REALTIME DATA POPUP ================= */
const realtimePopup = document.getElementById("realtimePopup");
const realtimeGroupList = document.getElementById("realtimeGroupList");

// Open realtime popup
document.getElementById("openRealtimePopup").onclick = () => {
  realtimePopup.style.maxHeight = "600px";
  document.getElementById("realtimePopupBody").style.display = "block";
  renderRealtimeGroups();
};

// Render groups in realtime popup
function renderRealtimeGroups() {
  realtimeGroupList.innerHTML = "";
  const groups = getGroups();
  
  if (Object.keys(groups).length === 0) {
    realtimeGroupList.innerHTML = `
      <div style="padding: 20px; text-align: center; color: #6b7280;">
        No groups found. Create groups first.
      </div>
    `;
    return;
  }
  
  Object.keys(groups).forEach(groupName => {
    // Create group header
    const groupDiv = document.createElement("div");
    groupDiv.className = "realtime-group-header";
    groupDiv.innerHTML = `
      <i data-lucide="folder" style="width: 16px; height: 16px; margin-right: 8px; color: #6366f1;"></i>
      <span class="realtime-group-name">${groupName}</span>
      <i data-lucide="chevron-right" class="group-expand-btn" style="width: 16px; height: 16px;"></i>
    `;
    
    // Create tracker list container (hidden by default)
    const trackerList = document.createElement("div");
    trackerList.className = "realtime-tracker-list";
    trackerList.style.display = "none";
    
    // Add trackers to the group
    groups[groupName].forEach(trackerId => {
      const trackerDiv = document.createElement("div");
      trackerDiv.className = "realtime-tracker-item";
      trackerDiv.dataset.trackerId = trackerId;
      trackerDiv.dataset.groupName = groupName;
      trackerDiv.innerHTML = `
        <i data-lucide="tag" style="width: 14px; height: 14px; margin-right: 8px; color: #6b7280;"></i>
        <span class="realtime-tracker-id">${trackerId}</span>
      `;
      
      // Click handler for tracker
      trackerDiv.onclick = (e) => {
        e.stopPropagation();
        showTrackerParameters(trackerId);
      };
      
      trackerList.appendChild(trackerDiv);
    });
    
    // Toggle group expansion
    const chevron = groupDiv.querySelector(".group-expand-btn");
    groupDiv.onclick = () => {
      const isExpanded = trackerList.style.display === "block";
      trackerList.style.display = isExpanded ? "none" : "block";
      chevron.classList.toggle("rotated", !isExpanded);
      lucide.createIcons();
    };
    
    realtimeGroupList.appendChild(groupDiv);
    realtimeGroupList.appendChild(trackerList);
  });
  
  lucide.createIcons();
}

// Show parameters for selected tracker
function showTrackerParameters(trackerId) {
  selectedTrackerForRealtime = trackerId;
  document.getElementById("selectedTrackerId").textContent = trackerId;
  document.getElementById("trackerParametersSection").style.display = "block";
  
  const parametersContainer = document.getElementById("parametersCheckboxes");
  parametersContainer.innerHTML = "";
  
  const settings = getRealtimeSettings();
  const trackerSettings = settings[trackerId] || {};
  
  // Create checkboxes for each parameter
  availableParameters.forEach(param => {
    const div = document.createElement("div");
    div.className = "parameter-option";
    
    const checkboxId = `param_${trackerId}_${param.id}`;
    const isChecked = trackerSettings[param.id] !== undefined ? 
                      trackerSettings[param.id] : param.default;
    
    div.innerHTML = `
      <input type="checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}>
      <label for="${checkboxId}">${param.label}</label>
    `;
    
    // Add change handler
    const checkbox = div.querySelector('input');
    checkbox.onchange = () => {
      // Settings will be saved when user clicks "Save Parameters"
    };
    
    parametersContainer.appendChild(div);
  });
}

// Save parameters button handler
document.getElementById("saveParametersBtn").onclick = () => {
  if (!selectedTrackerForRealtime) {
    alert("Please select a tracker first");
    return;
  }
  
  const settings = getRealtimeSettings();
  settings[selectedTrackerForRealtime] = settings[selectedTrackerForRealtime] || {};
  
  // Get all checkboxes for this tracker
  availableParameters.forEach(param => {
    const checkboxId = `param_${selectedTrackerForRealtime}_${param.id}`;
    const checkbox = document.getElementById(checkboxId);
    if (checkbox) {
      settings[selectedTrackerForRealtime][param.id] = checkbox.checked;
    }
  });
  
  saveRealtimeSettings(settings);
  
  // Show confirmation
  const btn = document.getElementById("saveParametersBtn");
  const originalText = btn.textContent;
  btn.textContent = "Saved!";
  btn.style.background = "#10b981";
  
  setTimeout(() => {
    btn.textContent = originalText;
    btn.style.background = "#6366f1";
  }, 1500);
  
  // Update the real-time table with new settings
  if (window.realtimeTableData && window.realtimeTableData[selectedTrackerForRealtime]) {
    window.updateRealtimeTable();
  }
  
  // Log for debugging
  console.log("Saved real-time parameters for", selectedTrackerForRealtime, ":", settings[selectedTrackerForRealtime]);
};

// Function to get selected parameters for a tracker (for use in fetchdata.js)
window.getRealtimeParameters = function(trackerId) {
  const settings = getRealtimeSettings();
  const trackerSettings = settings[trackerId];
  
  if (!trackerSettings) {
    // Return all parameters as true if no settings saved
    return availableParameters.reduce((acc, param) => {
      acc[param.id] = param.default;
      return acc;
    }, {});
  }
  
  return trackerSettings;
};

// Function to format real-time data based on selected parameters
window.formatRealtimeData = function(data, trackerId) {
  const parameters = window.getRealtimeParameters(trackerId);
  const formatted = {};
  
  // Always include tracker ID
  formatted['Tracker ID'] = trackerId;
  
  // Only include parameters that are enabled
  Object.keys(parameters).forEach(param => {
    if (parameters[param] && data[param] !== undefined) {
      formatted[param] = data[param];
    }
  });
  
  return formatted;
};

// Make realtime group dropdown collapsible
document.getElementById("realtimeGroupHeader").onclick = () => {
  const chevron = document.getElementById("realtimeGroupChevron");
  const dropdown = document.getElementById("realtimeGroupList");
  const isCollapsed = dropdown.style.display === "none";
  dropdown.style.display = isCollapsed ? "block" : "none";
  chevron.classList.toggle("rotate", isCollapsed);
};

/* ================= INIT ================= */
renderTrackers();
renderGroups();

// Auto-open real-time table panel if there's data
window.addEventListener('load', function() {
  setTimeout(() => {
    if (Object.keys(window.realtimeTableData).length > 0) {
      realtimeTablePanel.classList.remove('minimized');
      realtimeTablePanelChevron.classList.remove('rotated');
      realtimeTableContainer.style.display = 'block';
      window.updateRealtimeTable();
    }
  }, 1000);
});
</script>

</body>
</html> #}




























{#working code #}
{# <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drone Tracker Dashboard</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* ================= BASE STYLES ================= */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      background: #f9fafb;
    }

    /* ================= HEADER ================= */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 3000;
    }

    .logo-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      height: 40px;
      width: 40px;
    }

    .site-name {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
    }

    /* ================= SIDEBAR ================= */
    .sidebar {
      position: fixed;
      top: 70px;
      left: 0;
      bottom: 0;
      width: 200px;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      z-index: 2000;
      overflow-y: auto;
      transition: transform 0.3s ease;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
      }
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      flex-shrink: 0;
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    .sidebar-nav {
      padding: 12px 8px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .sidebar-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 14px 10px;
      margin-bottom: 8px;
      cursor: pointer;
      border-radius: 10px;
      transition: background 0.2s ease;
    }

    .sidebar-item:hover {
      background: #f3f4f6;
    }

    .item-top {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .sidebar-icon {
      width: 40px;
      height: 40px;
      color: #6366f1;
    }

    .sidebar-item span {
      font-size: 13px;
      color: #374151;
    }

    .chevron {
      margin-top: 6px;
      transition: transform 0.2s ease;
      color: #6b7280;
    }

    .chevron.rotate {
      transform: rotate(180deg);
    }

    .sidebar-dropdown {
      display: none;
      margin-left: 12px;
      margin-bottom: 10px;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 500;
      color: #4b5563;
      cursor: pointer;
      border-radius: 8px;
    }

    .dropdown-item:hover {
      background: #eef2ff;
    }

    /* ================= MAIN CONTENT ================= */
    main {
      position: fixed;
      top: 70px;
      left: 200px;
      right: 0;
      bottom: 0;
      padding: 15px;
      overflow-y: auto;
      z-index: 1;
      transition: left 0.3s ease;
    }

    @media (max-width: 768px) {
      main {
        left: 0;
      }
    }

    #status-message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }

    .last-updated {
      margin-bottom: 15px;
      font-size: 13px;
      color: #6b7280;
    }

    /* ================= MAP CONTAINER ================= */
    .map-container {
      position: relative;
      height: calc(100vh - 210px);
      min-height: 400px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    #map {
      height: 100%;
      width: 100%;
    }

    /* ================= TAG POPUPS ================= */
    .tag-popup {
      position: fixed;
      top: 80px;
      left: 210px;
      width: 320px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      z-index: 2500;
      overflow: hidden;
      transition: all 0.3s ease;
      max-height: 0;
    }

    @media (max-width: 1024px) {
      .tag-popup {
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 400px;
      }
    }

    .tag-popup.collapsed {
      max-height: 48px !important;
    }

    .tag-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 16px;
      background: #f3f4f6;
      border-bottom: 1px solid #e5e7eb;
    }

    .tag-popup-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    .tag-popup-body {
      padding: 16px;
      display: block;
    }

    .tag-popup.collapsed .tag-popup-body {
      display: none;
    }

    .tracker-dropdown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 8px 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 6px;
    }

    .tracker-dropdown.collapsible {
      display: block;
      max-height: 160px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .tracker-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      cursor: pointer;
    }

    .tracker-option:hover {
      background: #eef2ff;
    }

    .tracker-option input[type="checkbox"] {
      transform: scale(1.1);
      cursor: pointer;
    }

    .tracker-option input[type="color"] {
      width: 28px;
      height: 28px;
      border: none;
      padding: 0;
      cursor: pointer;
      border-radius: 4px;
    }

    .tracker-option span {
      flex: 1;
      cursor: pointer;
    }

    .add-tracker {
      padding: 8px;
      display: flex;
      gap: 6px;
      border-top: 1px solid #e5e7eb;
    }

    .tag-input-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .tag-input-row input {
      flex: 1;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
    }

    .tag-input-row button {
      padding: 8px 12px;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .tag-input-row button:hover {
      background: #4f46e5;
    }

    /* Popup positioning */
    #tagPopup {
      left: 210px;
      top: 90px;
    }

    #groupPopup {
      left: 210px;
      top: 140px;
    }

    #groupDetailPopup {
      left: 550px;
      top: 90px;
    }

    #realtimePopup {
      left: 210px;
      top: 190px;
    }

    /* ================= REALTIME DATA TABLE PANEL ================= */
    #realtimeTablePanel {
      position: fixed;
      bottom: 15px;
      left: 215px;
      right: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1500;
      transition: all 0.3s ease;
      max-height: 400px;
      overflow: hidden;
    }

    @media (max-width: 768px) {
      #realtimeTablePanel {
        left: 15px;
      }
    }

    #realtimeTablePanel.minimized {
      max-height: 44px;
    }

    #realtimeTablePanelHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
    }

    #realtimeTablePanelHeader h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    #realtimeTablePanelChevron {
      transition: transform 0.3s ease;
    }

    #realtimeTablePanelChevron.rotated {
      transform: rotate(180deg);
    }

    #realtimeTableContainer {
      padding: 15px;
      max-height: 350px;
      overflow-y: auto;
    }

    #realtimeDataTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    #realtimeDataTable th {
      background: #f9fafb;
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 0;
      white-space: nowrap;
    }

    #realtimeDataTable td {
      padding: 10px 12px;
      border-bottom: 1px solid #f3f4f6;
      color: #4b5563;
      white-space: nowrap;
    }

    #realtimeDataTable tr:hover {
      background: #f9fafb;
    }

    .tracker-id-cell {
      font-weight: 600;
      color: #6366f1;
    }

    .no-data-row td {
      text-align: center;
      padding: 30px;
      color: #9ca3af;
      font-style: italic;
    }

    /* ================= IMAGE GRID ================= */
    #images-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding-bottom: 20px;
    }

    .image-container {
      width: calc(25% - 10px);
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }

    @media (max-width: 1200px) {
      .image-container {
        width: calc(33.333% - 10px);
      }
    }

    @media (max-width: 768px) {
      .image-container {
        width: calc(50% - 10px);
      }
    }

    .image-container img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }

    /* ================= REALTIME DATA STYLES ================= */
    .parameter-option {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      cursor: pointer;
    }

    .parameter-option:hover {
      background: #f9fafb;
    }

    .parameter-option input[type="checkbox"] {
      margin-right: 10px;
      cursor: pointer;
      transform: scale(1.1);
    }

    .parameter-option label {
      cursor: pointer;
      flex: 1;
      user-select: none;
    }

    .realtime-tracker-item {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .realtime-tracker-item:hover {
      background: #eef2ff;
    }

    .realtime-tracker-id {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }

    .group-expand-btn {
      margin-left: 8px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .group-expand-btn.rotated {
      transform: rotate(90deg);
    }

    .realtime-group-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      background: #f9fafb;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 5px;
    }

    .realtime-group-header:hover {
      background: #f3f4f6;
    }

    .realtime-group-name {
      flex: 1;
      font-weight: 600;
      color: #374151;
    }

    .realtime-tracker-list {
      margin-left: 15px;
      border-left: 2px solid #e5e7eb;
      padding-left: 10px;
    }

    /* ================= GROUP CONTROLS ================= */
    .group-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .group-control-btn {
      padding: 6px 12px;
      background: rgba(99, 102, 241, 0.8);
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }

    .group-control-btn:hover {
      background: rgba(79, 70, 229, 1);
    }

    /* ================= SCROLLBAR STYLING ================= */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    /* ================= MOBILE MENU TOGGLE ================= */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 4000;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .mobile-menu-toggle {
        display: block;
      }
    }

    /* ================= OVERLAY ================= */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
    }

    .overlay.active {
      display: block;
    }

    /* ================= STATUS MESSAGES ================= */
    .status-loading {
      background: #fef3c7;
      color: #92400e;
    }

    .status-success {
      background: #d1fae5;
      color: #065f46;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* ================= CHECKBOX CONTAINER ================= */
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-preview {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      cursor: pointer;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
  </style>
</head>

<body>

<button class="mobile-menu-toggle" id="mobileMenuToggle">
  <i data-lucide="menu"></i>
</button>

<header>
  <div class="logo-title">
    <img src="{{ url_for('static', filename='images/logo.svg') }}" class="logo">
    <span class="site-name">DRONE TAG</span>
  </div>
</header>

<div class="overlay" id="overlay"></div>

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar" id="sidebar">
  <!--<div class="sidebar-header">
    <span class="sidebar-title">Drone Tag</span>
  </div> -->
  <nav class="sidebar-nav">
    <div class="sidebar-item" onclick="scrollToTop()">
      <i data-lucide="layout-dashboard" class="sidebar-icon"></i>
      <span>Dashboard</span>
    </div>

    <div class="sidebar-item" id="settingsToggle">
      <div class="item-top">
        <i data-lucide="settings" class="sidebar-icon"></i>
        <span>Settings</span>
      </div>
      <i data-lucide="chevron-down" class="chevron" id="settingsChevron"></i>
    </div>

    <div class="sidebar-dropdown" id="settingsDropdown">
      <div class="dropdown-item" id="openTagPopup">
        <i data-lucide="tag"></i><span>Tag</span>
      </div>
      <div class="dropdown-item">
        <i data-lucide="cpu"></i><span>Sensor</span>
      </div>
      <div class="dropdown-item" id="openRealtimePopup">
        <i data-lucide="activity"></i><span>Real-time Data</span>
      </div>
    </div>

    <div class="sidebar-item" id="reportsToggle">
      <div class="item-top">
        <i data-lucide="file-text" class="sidebar-icon"></i><span>Reports</span>
      </div>
      <i data-lucide="chevron-down" class="chevron" id="reportsChevron"></i>
    </div>

    <div class="sidebar-dropdown" id="reportsDropdown">
      <div class="dropdown-item" id="openGroupPopup">
        <i data-lucide="folder"></i><span>Group Name</span>
      </div>
    </div>
  </nav>
</aside>

<!-- ================= TAG POPUP ================= -->
<div class="tag-popup" id="tagPopup">
  <div class="tag-popup-header" id="tagPopupHeader">
    <h4>Tracker Popup</h4>
    <i data-lucide="chevron-down" class="chevron" id="tagPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="tagPopupBody">
    <div class="tracker-dropdown-header" id="trackerDropdownHeader">
      <span>Available Trackers</span>
      <i data-lucide="chevron-down" class="chevron" id="trackerChevron"></i>
    </div>
    <div class="tracker-dropdown collapsible" id="trackerList"></div>

    <div class="add-tracker">
      <input type="text" id="newTracker" placeholder="Add tracker ID">
      <button id="addTrackerBtn">+</button>
    </div>

    <div class="tag-input-row">
      <input type="text" id="tracker-id" placeholder="Manual Tracker ID">
      <button id="fetch-btn">Fetch</button>
    </div>
  </div>
</div>

<!-- ================= GROUP POPUP ================= -->
<div class="tag-popup" id="groupPopup">
  <div class="tag-popup-header" id="groupPopupHeader">
    <h4>Tracker Groups</h4>
    <i data-lucide="chevron-down" class="chevron" id="groupPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="groupPopupBody">
    <div class="tag-input-row">
      <input type="text" id="groupNameInput" placeholder="Group Name">
      <button id="createGroupBtn">Add Group</button>
    </div>

    <div id="groupList" class="tracker-dropdown collapsible" style="margin-top:10px;"></div>

    <div class="tag-input-row">
      <input type="text" id="groupTrackerInput" placeholder="Tracker ID">
      <button id="addTrackerToGroupBtn">Add</button>
    </div>

    <div class="tag-input-row">
      <button id="fetchGroupBtn" style="width:100%">Fetch Group</button>
    </div>
  </div>
</div>

<!-- ================= GROUP DETAIL POPUP ================= -->
<div class="tag-popup" id="groupDetailPopup">
  <div class="tag-popup-header">
    <h4 id="groupDetailTitle">Group</h4>
    <i data-lucide="chevron-down" class="chevron"></i>
  </div>

  <div class="tag-popup-body">
    <div id="groupTrackerList" class="tracker-dropdown collapsible"></div>

    <div class="tag-input-row" style="margin-top:10px;">
      <input type="text" id="groupDetailTrackerInput" placeholder="Add Tracker ID">
      <button id="addTrackerToGroupDetailBtn">Add</button>
    </div>
  </div>
</div>

<!-- ================= REALTIME DATA POPUP ================= -->
<div class="tag-popup" id="realtimePopup">
  <div class="tag-popup-header" id="realtimePopupHeader">
    <h4>Real-time Data Parameters</h4>
    <i data-lucide="chevron-down" class="chevron" id="realtimePopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="realtimePopupBody">
    <div class="tracker-dropdown-header" id="realtimeGroupHeader">
      <span>Select Group</span>
      <i data-lucide="chevron-down" class="chevron" id="realtimeGroupChevron"></i>
    </div>
    
    <div class="tracker-dropdown collapsible" id="realtimeGroupList"></div>

    <div id="trackerParametersSection" style="display: none;">
      <div style="margin: 15px 0 10px 0; font-weight: 600; color: #374151;">
        Selected Tracker: <span id="selectedTrackerId">-</span>
      </div>
      
      <div id="parametersCheckboxes" class="tracker-dropdown collapsible" style="max-height: 200px;"></div>
      
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
        <button id="saveParametersBtn" style="width: 100%; padding: 8px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
          Save Parameters
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ================= MAIN CONTENT ================= -->
<main>
  <div id="status-message"></div>
  <div class="last-updated"></div>
  
  <div class="map-container">
    <div id="map"></div>
  </div>
  
  <!-- ================= REALTIME DATA TABLE PANEL ================= -->
  <div id="realtimeTablePanel" class="minimized">
    <div id="realtimeTablePanelHeader">
      <h3>Real-time Data Table</h3>
      <i data-lucide="chevron-up" id="realtimeTablePanelChevron" class="rotated"></i>
    </div>
    <div id="realtimeTableContainer" style="display: none;">
      <table id="realtimeDataTable">
        <thead>
          <tr>
            <th>Tracker ID</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
  
  <div id="images-grid"></div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="{{ url_for('static', filename='js/fetchdata.js') }}"></script>

<script>
lucide.createIcons();

/* ================= MOBILE MENU ================= */
const mobileMenuToggle = document.getElementById('mobileMenuToggle');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');

mobileMenuToggle.addEventListener('click', () => {
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
});

overlay.addEventListener('click', () => {
  sidebar.classList.remove('open');
  overlay.classList.remove('active');
});

/* ================= RESPONSIVE HELPERS ================= */
function scrollToTop() {
  document.querySelector('main').scrollTo({ top: 0, behavior: 'smooth' });
}

function closeAllPopups() {
  const popups = document.querySelectorAll('.tag-popup');
  popups.forEach(popup => {
    popup.style.maxHeight = '0';
    popup.classList.add('collapsed');
  });
}

function handleOutsideClick(e) {
  const popups = document.querySelectorAll('.tag-popup');
  let clickedOnPopup = false;
  
  popups.forEach(popup => {
    if (popup.contains(e.target)) {
      clickedOnPopup = true;
    }
  });
  
  if (!clickedOnPopup && !sidebar.contains(e.target) && !mobileMenuToggle.contains(e.target)) {
    closeAllPopups();
  }
}

document.addEventListener('click', handleOutsideClick);

/* ================= POPUP MANAGEMENT ================= */
function makePopupCollapsible(popupId, chevronId) {
  const popup = document.getElementById(popupId);
  const chevron = document.getElementById(chevronId);

  if (!popup || !chevron) return;

  chevron.addEventListener("click", (e) => {
    e.stopPropagation();
    const collapsed = popup.classList.toggle("collapsed");
    chevron.classList.toggle("rotate", !collapsed);
    
    // Close other popups when opening this one
    if (!collapsed) {
      const allPopups = document.querySelectorAll('.tag-popup');
      allPopups.forEach(p => {
        if (p.id !== popupId && !p.classList.contains('collapsed')) {
          p.style.maxHeight = '0';
          p.classList.add('collapsed');
          const otherChevron = p.querySelector('.chevron');
          if (otherChevron) otherChevron.classList.remove('rotate');
        }
      });
      
      // Set max height based on content
      const body = popup.querySelector('.tag-popup-body');
      if (body) {
        const height = body.scrollHeight + 48; // 48px for header
        popup.style.maxHeight = `${Math.min(height, 600)}px`;
      }
    }
  });
}

// Initialize all popups
makePopupCollapsible("tagPopup", "tagPopupChevron");
makePopupCollapsible("groupPopup", "groupPopupChevron");
makePopupCollapsible("realtimePopup", "realtimePopupChevron");

// Group detail popup
document.querySelector("#groupDetailPopup .chevron").addEventListener("click", () => {
  groupDetailPopup.classList.toggle("collapsed");
});

/* ================= SIDEBAR DROPDOWNS ================= */
function toggleMenu(toggleBtn, dropdown, chevron) {
  if (!toggleBtn || !dropdown || !chevron) return;
  
  toggleBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const open = dropdown.style.display === "block";
    dropdown.style.display = open ? "none" : "block";
    chevron.classList.toggle("rotate", !open);
  });
}

toggleMenu(
  document.getElementById("settingsToggle"),
  document.getElementById("settingsDropdown"),
  document.getElementById("settingsChevron")
);

toggleMenu(
  document.getElementById("reportsToggle"),
  document.getElementById("reportsDropdown"),
  document.getElementById("reportsChevron")
);

/* ================= REALTIME TABLE PANEL ================= */
const realtimeTablePanel = document.getElementById('realtimeTablePanel');
const realtimeTablePanelHeader = document.getElementById('realtimeTablePanelHeader');
const realtimeTablePanelChevron = document.getElementById('realtimeTablePanelChevron');
const realtimeTableContainer = document.getElementById('realtimeTableContainer');
const realtimeDataTable = document.getElementById('realtimeDataTable');

// Toggle panel visibility
realtimeTablePanelHeader.addEventListener('click', (e) => {
  e.stopPropagation();
  const isMinimized = realtimeTablePanel.classList.toggle('minimized');
  realtimeTablePanelChevron.classList.toggle('rotated', isMinimized);
  
  if (isMinimized) {
    realtimeTableContainer.style.display = 'none';
  } else {
    realtimeTableContainer.style.display = 'block';
    if (window.realtimeTableData && Object.keys(window.realtimeTableData).length > 0) {
      updateRealtimeTable();
    }
  }
});

// Store real-time table data
window.realtimeTableData = {};
window.realtimeTableHeaders = ['Tracker ID'];

// Function to update the real-time data table
window.updateRealtimeTable = function(trackerId, data) {
  if (trackerId && data) {
    window.realtimeTableData[trackerId] = data;
  }
  
  // Get all selected parameters
  const allSelectedParams = new Set(['Tracker ID']);
  Object.keys(window.realtimeTableData).forEach(tid => {
    const params = window.getRealtimeParameters ? window.getRealtimeParameters(tid) : null;
    if (params) {
      Object.keys(params).forEach(param => {
        if (params[param]) allSelectedParams.add(param);
      });
    }
  });
  
  window.realtimeTableHeaders = Array.from(allSelectedParams);
  
  // Update table headers
  const thead = realtimeDataTable.querySelector('thead');
  const headerRow = thead.querySelector('tr');
  headerRow.innerHTML = '';
  
  window.realtimeTableHeaders.forEach(header => {
    const th = document.createElement('th');
    th.textContent = formatHeaderText(header);
    headerRow.appendChild(th);
  });
  
  // Update table body
  const tbody = realtimeDataTable.querySelector('tbody');
  tbody.innerHTML = '';
  
  if (Object.keys(window.realtimeTableData).length === 0) {
    const noDataRow = document.createElement('tr');
    noDataRow.className = 'no-data-row';
    const td = document.createElement('td');
    td.colSpan = window.realtimeTableHeaders.length;
    td.textContent = 'No real-time data available. Fetch a tracker first.';
    noDataRow.appendChild(td);
    tbody.appendChild(noDataRow);
    return;
  }
  
  Object.keys(window.realtimeTableData).forEach(tid => {
    const row = document.createElement('tr');
    
    window.realtimeTableHeaders.forEach(header => {
      const td = document.createElement('td');
      
      if (header === 'Tracker ID') {
        td.className = 'tracker-id-cell';
        td.textContent = tid;
      } else {
        const params = window.getRealtimeParameters ? window.getRealtimeParameters(tid) : null;
        if (params && params[header] && window.realtimeTableData[tid][header]) {
          td.textContent = formatCellValue(header, window.realtimeTableData[tid][header]);
        } else {
          td.textContent = '-';
          td.style.color = '#9ca3af';
        }
      }
      
      row.appendChild(td);
    });
    
    tbody.appendChild(row);
  });
  
  // Auto-open panel if minimized and has data
  if (realtimeTablePanel.classList.contains('minimized') && Object.keys(window.realtimeTableData).length > 0) {
    realtimeTablePanel.classList.remove('minimized');
    realtimeTablePanelChevron.classList.remove('rotated');
    realtimeTableContainer.style.display = 'block';
  }
};

function formatHeaderText(header) {
  const formatMap = {
    'timestamp': 'Timestamp',
    'latitude': 'Latitude',
    'longitude': 'Longitude',
    'altitude': 'Altitude',
    'uin_no': 'UIN No',
    'application': 'Application',
    'category': 'Category',
    'Tracker ID': 'Tracker ID'
  };
  return formatMap[header] || header;
}

function formatCellValue(header, value) {
  if (header === 'timestamp' && value) {
    try {
      return new Date(value).toLocaleString();
    } catch (e) {
      return value;
    }
  }
  if ((header === 'latitude' || header === 'longitude') && value) {
    return parseFloat(value).toFixed(6);
  }
  if (header === 'altitude' && value) {
    return `${parseFloat(value).toFixed(1)} m`;
  }
  return value || '-';
}

// Initialize table
window.updateRealtimeTable();

/* ================= STORAGE ================= */
const STORAGE_KEY = "saved_trackers";
const GROUP_KEY = "tracker_groups";
const REALTIME_SETTINGS_KEY = "realtime_parameters";
let activeGroup = null;
let selectedTrackerForRealtime = null;

const getSavedTrackers = () => JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
const saveTracker = (id) => {
  const trackers = getSavedTrackers();
  if (!trackers.includes(id)) {
    trackers.push(id);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(trackers));
  }
};

const getGroups = () => JSON.parse(localStorage.getItem(GROUP_KEY)) || {};
const saveGroups = (groups) => localStorage.setItem(GROUP_KEY, JSON.stringify(groups));

/* ================= REALTIME DATA SETTINGS ================= */
const getRealtimeSettings = () => JSON.parse(localStorage.getItem(REALTIME_SETTINGS_KEY)) || {};
const saveRealtimeSettings = (settings) => localStorage.setItem(REALTIME_SETTINGS_KEY, JSON.stringify(settings));

const availableParameters = [
  { id: 'timestamp', label: 'Timestamp', default: true },
  { id: 'latitude', label: 'Latitude', default: true },
  { id: 'longitude', label: 'Longitude', default: true },
  { id: 'altitude', label: 'Altitude', default: true },
  { id: 'uin_no', label: 'UIN No', default: true },
  { id: 'application', label: 'Application', default: true },
  { id: 'category', label: 'Category', default: true }
];

/* ================= TAG POPUP FUNCTIONS ================= */
const tagPopup = document.getElementById("tagPopup");
const trackerList = document.getElementById("trackerList");
const trackerInput = document.getElementById("tracker-id");

document.getElementById("openTagPopup").onclick = (e) => {
  e.stopPropagation();
  tagPopup.style.maxHeight = "600px";
  tagPopup.classList.remove("collapsed");
  document.getElementById("tagPopupChevron").classList.add("rotate");
  renderTrackers();
};

function renderTrackers() {
  trackerList.innerHTML = "";
  getSavedTrackers().forEach(id => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = id;
    div.onclick = () => handleFetch(id);
    trackerList.appendChild(div);
  });
}

function handleFetch(id) {
  if (!id) return;
  trackerInput.value = id;
  saveTracker(id);
  renderTrackers();
  if (typeof fetchDroneData === "function") {
    fetchDroneData();
  }
}

document.getElementById("fetch-btn").onclick = () => handleFetch(trackerInput.value.trim());
document.getElementById("addTrackerBtn").onclick = () => {
  const val = document.getElementById("newTracker").value.trim();
  if (!val) return;
  saveTracker(val);
  renderTrackers();
  document.getElementById("newTracker").value = "";
};

/* ================= GROUP POPUP FUNCTIONS ================= */
const groupPopup = document.getElementById("groupPopup");
const groupList = document.getElementById("groupList");

document.getElementById("openGroupPopup").onclick = (e) => {
  e.stopPropagation();
  groupPopup.style.maxHeight = "600px";
  groupPopup.classList.remove("collapsed");
  document.getElementById("groupPopupChevron").classList.add("rotate");
  renderGroups();
};

function renderGroups() {
  groupList.innerHTML = "";
  const groups = getGroups();
  Object.keys(groups).forEach(groupName => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = groupName;
    div.addEventListener("click", () => {
      openGroupDetail(groupName);
      groupDetailPopup.style.maxHeight = "600px";
      groupDetailPopup.classList.remove("collapsed");
    });
    groupList.appendChild(div);
  });
}

document.getElementById("createGroupBtn").onclick = () => {
  const name = document.getElementById("groupNameInput").value.trim();
  if (!name) return;
  const groups = getGroups();
  if (!groups[name]) groups[name] = [];
  saveGroups(groups);
  document.getElementById("groupNameInput").value = "";
  renderGroups();
};

/* ================= GROUP DETAIL POPUP ================= */
const groupDetailPopup = document.getElementById("groupDetailPopup");
const groupTrackerList = document.getElementById("groupTrackerList");
const groupDetailTitle = document.getElementById("groupDetailTitle");

let groupSettings = JSON.parse(localStorage.getItem('groupSettings')) || {};
const defaultColors = [
  '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', 
  '#EF476F', '#9D4EDD', '#FB5607', '#3A86FF', '#8338EC'
];

function openGroupDetail(groupName) {
  if (window.setActiveGroup) window.setActiveGroup(groupName);
  activeGroup = groupName;
  groupDetailTitle.textContent = groupName;
  const groups = getGroups();
  groupTrackerList.innerHTML = "";
  
  if (!groupSettings[groupName]) groupSettings[groupName] = {};
  
  (groups[groupName] || []).forEach((tid, index) => {
    if (!groupSettings[groupName][tid]) {
      groupSettings[groupName][tid] = {
        visible: true,
        color: defaultColors[index % defaultColors.length]
      };
    }
    
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.dataset.trackerId = tid;
    
    const checkboxContainer = document.createElement("div");
    checkboxContainer.className = "checkbox-container";
    
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "tracker-checkbox";
    checkbox.checked = groupSettings[groupName][tid].visible;
    checkbox.dataset.trackerId = tid;
    
    const colorPicker = document.createElement("input");
    colorPicker.type = "color";
    colorPicker.className = "tracker-color-picker";
    colorPicker.value = groupSettings[groupName][tid].color;
    colorPicker.dataset.trackerId = tid;
    colorPicker.style.display = "none";
    
    const colorPreview = document.createElement("div");
    colorPreview.className = "color-preview";
    colorPreview.style.backgroundColor = groupSettings[groupName][tid].color;
    
    const trackerIdSpan = document.createElement("span");
    trackerIdSpan.className = "tracker-id-text";
    trackerIdSpan.textContent = tid;
    trackerIdSpan.dataset.trackerId = tid;
    
    trackerIdSpan.onclick = () => {
      if (window.handleFetch) window.handleFetch(tid);
    };
    
    checkbox.onchange = (e) => {
      const trackerId = e.target.dataset.trackerId;
      const isVisible = e.target.checked;
      groupSettings[groupName][trackerId].visible = isVisible;
      saveGroupSettings();
      if (window.updateTrackerVisibilityFromGroup) {
        window.updateTrackerVisibilityFromGroup(trackerId, isVisible);
      }
    };
    
    colorPicker.onchange = (e) => {
      const trackerId = e.target.dataset.trackerId;
      const newColor = e.target.value;
      groupSettings[groupName][trackerId].color = newColor;
      saveGroupSettings();
      colorPreview.style.backgroundColor = newColor;
      if (window.updateTrackerColorFromGroup) {
        window.updateTrackerColorFromGroup(trackerId, newColor);
      }
    };
    
    colorPreview.onclick = () => colorPicker.click();
    
    checkboxContainer.appendChild(checkbox);
    checkboxContainer.appendChild(colorPreview);
    div.appendChild(checkboxContainer);
    div.appendChild(colorPicker);
    div.appendChild(trackerIdSpan);
    groupTrackerList.appendChild(div);
  });
  
  saveGroupSettings();
}

function saveGroupSettings() {
  localStorage.setItem('groupSettings', JSON.stringify(groupSettings));
}

document.getElementById("addTrackerToGroupDetailBtn").onclick = () => {
  if (!activeGroup) return;
  const tracker = document.getElementById("groupDetailTrackerInput").value.trim();
  if (!tracker) return;
  const groups = getGroups();
  if (!groups[activeGroup].includes(tracker)) {
    groups[activeGroup].push(tracker);
    saveGroups(groups);
    if (!groupSettings[activeGroup]) groupSettings[activeGroup] = {};
    const index = groups[activeGroup].length - 1;
    groupSettings[activeGroup][tracker] = {
      visible: true,
      color: defaultColors[index % defaultColors.length]
    };
    saveGroupSettings();
  }
  document.getElementById("groupDetailTrackerInput").value = "";
  openGroupDetail(activeGroup);
};

document.getElementById("fetchGroupBtn").onclick = () => {
  if (!activeGroup) {
    alert("Select a group first");
    return;
  }
  const groups = getGroups();
  const trackerIds = groups[activeGroup] || [];
  if (trackerIds.length === 0) {
    alert("No trackers in this group");
    return;
  }
  if (window.fetchGroupTrackers) window.fetchGroupTrackers(trackerIds);
};

/* ================= REALTIME DATA POPUP ================= */
const realtimePopup = document.getElementById("realtimePopup");
const realtimeGroupList = document.getElementById("realtimeGroupList");

document.getElementById("openRealtimePopup").onclick = (e) => {
  e.stopPropagation();
  realtimePopup.style.maxHeight = "600px";
  realtimePopup.classList.remove("collapsed");
  document.getElementById("realtimePopupChevron").classList.add("rotate");
  renderRealtimeGroups();
};

function renderRealtimeGroups() {
  realtimeGroupList.innerHTML = "";
  const groups = getGroups();
  
  if (Object.keys(groups).length === 0) {
    realtimeGroupList.innerHTML = `
      <div style="padding: 20px; text-align: center; color: #6b7280;">
        No groups found. Create groups first.
      </div>
    `;
    return;
  }
  
  Object.keys(groups).forEach(groupName => {
    const groupDiv = document.createElement("div");
    groupDiv.className = "realtime-group-header";
    groupDiv.innerHTML = `
      <i data-lucide="folder" style="width: 16px; height: 16px; margin-right: 8px; color: #6366f1;"></i>
      <span class="realtime-group-name">${groupName}</span>
      <i data-lucide="chevron-right" class="group-expand-btn" style="width: 16px; height: 16px;"></i>
    `;
    
    const trackerList = document.createElement("div");
    trackerList.className = "realtime-tracker-list";
    trackerList.style.display = "none";
    
    groups[groupName].forEach(trackerId => {
      const trackerDiv = document.createElement("div");
      trackerDiv.className = "realtime-tracker-item";
      trackerDiv.dataset.trackerId = trackerId;
      trackerDiv.dataset.groupName = groupName;
      trackerDiv.innerHTML = `
        <i data-lucide="tag" style="width: 14px; height: 14px; margin-right: 8px; color: #6b7280;"></i>
        <span class="realtime-tracker-id">${trackerId}</span>
      `;
      trackerDiv.onclick = (e) => {
        e.stopPropagation();
        showTrackerParameters(trackerId);
      };
      trackerList.appendChild(trackerDiv);
    });
    
    const chevron = groupDiv.querySelector(".group-expand-btn");
    groupDiv.onclick = () => {
      const isExpanded = trackerList.style.display === "block";
      trackerList.style.display = isExpanded ? "none" : "block";
      chevron.classList.toggle("rotated", !isExpanded);
      lucide.createIcons();
    };
    
    realtimeGroupList.appendChild(groupDiv);
    realtimeGroupList.appendChild(trackerList);
  });
  
  lucide.createIcons();
}

function showTrackerParameters(trackerId) {
  selectedTrackerForRealtime = trackerId;
  document.getElementById("selectedTrackerId").textContent = trackerId;
  document.getElementById("trackerParametersSection").style.display = "block";
  
  const parametersContainer = document.getElementById("parametersCheckboxes");
  parametersContainer.innerHTML = "";
  
  const settings = getRealtimeSettings();
  const trackerSettings = settings[trackerId] || {};
  
  availableParameters.forEach(param => {
    const div = document.createElement("div");
    div.className = "parameter-option";
    const checkboxId = `param_${trackerId}_${param.id}`;
    const isChecked = trackerSettings[param.id] !== undefined ? 
                      trackerSettings[param.id] : param.default;
    div.innerHTML = `
      <input type="checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}>
      <label for="${checkboxId}">${param.label}</label>
    `;
    const checkbox = div.querySelector('input');
    checkbox.onchange = () => {};
    parametersContainer.appendChild(div);
  });
}

document.getElementById("saveParametersBtn").onclick = () => {
  if (!selectedTrackerForRealtime) {
    alert("Please select a tracker first");
    return;
  }
  const settings = getRealtimeSettings();
  settings[selectedTrackerForRealtime] = settings[selectedTrackerForRealtime] || {};
  availableParameters.forEach(param => {
    const checkboxId = `param_${selectedTrackerForRealtime}_${param.id}`;
    const checkbox = document.getElementById(checkboxId);
    if (checkbox) settings[selectedTrackerForRealtime][param.id] = checkbox.checked;
  });
  saveRealtimeSettings(settings);
  const btn = document.getElementById("saveParametersBtn");
  const originalText = btn.textContent;
  btn.textContent = "Saved!";
  btn.style.background = "#10b981";
  setTimeout(() => {
    btn.textContent = originalText;
    btn.style.background = "#6366f1";
  }, 1500);
  if (window.realtimeTableData && window.realtimeTableData[selectedTrackerForRealtime]) {
    window.updateRealtimeTable();
  }
};

window.getRealtimeParameters = function(trackerId) {
  const settings = getRealtimeSettings();
  const trackerSettings = settings[trackerId];
  if (!trackerSettings) {
    return availableParameters.reduce((acc, param) => {
      acc[param.id] = param.default;
      return acc;
    }, {});
  }
  return trackerSettings;
};

window.formatRealtimeData = function(data, trackerId) {
  const parameters = window.getRealtimeParameters(trackerId);
  const formatted = { 'Tracker ID': trackerId };
  Object.keys(parameters).forEach(param => {
    if (parameters[param] && data[param] !== undefined) {
      formatted[param] = data[param];
    }
  });
  return formatted;
};

// Make realtime group dropdown collapsible
document.getElementById("realtimeGroupHeader").onclick = () => {
  const chevron = document.getElementById("realtimeGroupChevron");
  const dropdown = document.getElementById("realtimeGroupList");
  const isCollapsed = dropdown.style.display === "none";
  dropdown.style.display = isCollapsed ? "block" : "none";
  chevron.classList.toggle("rotate", isCollapsed);
};

/* ================= WINDOW RESIZE HANDLER ================= */
function handleResize() {
  const isMobile = window.innerWidth <= 768;
  if (!isMobile) {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
  }
}

window.addEventListener('resize', handleResize);
handleResize();

/* ================= INITIALIZATION ================= */
renderTrackers();
renderGroups();

// Auto-open real-time table panel if there's data
window.addEventListener('load', function() {
  setTimeout(() => {
    if (Object.keys(window.realtimeTableData).length > 0) {
      realtimeTablePanel.classList.remove('minimized');
      realtimeTablePanelChevron.classList.remove('rotated');
      realtimeTableContainer.style.display = 'block';
      window.updateRealtimeTable();
    }
  }, 1000);
});

// Close popups when clicking Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeAllPopups();
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
  }
});
</script>

</body>
</html> #}








































{# 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drone Tracker Dashboard</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* ================= BASE STYLES ================= */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      background: #f9fafb;
    }

    /* ================= HEADER ================= */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 3000;
    }

    .logo-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      height: 40px;
      width: 40px;
    }

    .site-name {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
    }

    /* ================= SIDEBAR ================= */
    .sidebar {
      position: fixed;
      top: 70px;
      left: 0;
      bottom: 0;
      width: 160px;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      z-index: 2000;
      overflow-y: auto;
      transition: transform 0.3s ease;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        width: 200px;
      }
      .sidebar.open {
        transform: translateX(0);
      }
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      flex-shrink: 0;
      display: none; /* Hide header as requested */
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    .sidebar-nav {
      padding: 12px 8px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .sidebar-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 14px 10px;
      margin-bottom: 8px;
      cursor: pointer;
      border-radius: 10px;
      transition: background 0.2s ease;
    }

    .sidebar-item:hover {
      background: #f3f4f6;
    }

    .item-top {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .sidebar-icon {
      width: 40px;
      height: 40px;
      color: #6366f1;
    }

    .sidebar-item span {
      font-size: 13px;
      color: #374151;
    }

    .chevron {
      margin-top: 6px;
      transition: transform 0.2s ease;
      color: #6b7280;
    }

    .chevron.rotate {
      transform: rotate(180deg);
    }

    .sidebar-dropdown {
      display: none;
      margin-left: 12px;
      margin-bottom: 10px;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 500;
      color: #4b5563;
      cursor: pointer;
      border-radius: 8px;
    }

    .dropdown-item:hover {
      background: #eef2ff;
    }

    /* ================= MAIN CONTENT ================= */
    main {
      position: fixed;
      top: 70px;
      left: 160px;
      right: 0;
      bottom: 0;
      padding: 15px;
      overflow-y: auto;
      z-index: 1;
      transition: left 0.3s ease;
    }

    @media (max-width: 768px) {
      main {
        left: 0;
      }
    }

    #status-message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }

    .last-updated {
      margin-bottom: 15px;
      font-size: 13px;
      color: #6b7280;
    }

    /* ================= MAP CONTAINER ================= */
    .map-container {
      position: relative;
      height: calc(100vh - 210px);
      min-height: 400px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    #map {
      height: 100%;
      width: 100%;
    }

    /* ================= POPUPS ================= */
    .tag-popup {
      position: fixed;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      z-index: 2500;
      overflow: hidden;
      transition: all 0.3s ease;
      max-height: 0;
      border-left: 4px solid #6366f1;
    }

    @media (max-width: 1024px) {
      .tag-popup {
        left: 50% !important;
        transform: translateX(-50%);
        width: 90% !important;
        max-width: 400px;
      }
    }

    .tag-popup.collapsed {
      max-height: 0 !important;
    }

    .tag-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 16px;
      background: #f3f4f6;
      border-bottom: 1px solid #e5e7eb;
    }

    .tag-popup-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      flex: 1;
    }

    .tag-popup-body {
      padding: 16px;
      display: block;
    }

    .tag-popup.collapsed .tag-popup-body {
      display: none;
    }

    .tag-popup.collapsed .tag-popup-header {
      border-bottom: none;
    }

    .tracker-dropdown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 8px 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 6px;
    }

    .tracker-dropdown.collapsible {
      display: block;
      max-height: 160px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .tracker-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      cursor: pointer;
    }

    .tracker-option:hover {
      background: #eef2ff;
    }

    .tracker-option input[type="checkbox"] {
      transform: scale(1.1);
      cursor: pointer;
    }

    .tracker-option input[type="color"] {
      width: 28px;
      height: 28px;
      border: none;
      padding: 0;
      cursor: pointer;
      border-radius: 4px;
    }

    .tracker-option span {
      flex: 1;
      cursor: pointer;
    }

    .add-tracker {
      padding: 8px;
      display: flex;
      gap: 6px;
      border-top: 1px solid #e5e7eb;
    }

    .tag-input-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .tag-input-row input {
      flex: 1;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
    }

    .tag-input-row button {
      padding: 8px 12px;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .tag-input-row button:hover {
      background: #4f46e5;
    }

    /* Popup positioning */
    #tagPopup {
      left: 170px;
      top: 90px;
      width: 320px;
    }

    #groupPopup {
      left: 170px;
      top: 140px;
      width: 320px;
    }

    #groupDetailPopup {
      left: 510px;
      top: 90px;
      width: 320px;
    }

    #realtimePopup {
      left: 170px;
      top: 190px;
      width: 320px;
    }

    /* ================= REALTIME DATA TABLE PANEL ================= */
    #realtimeTablePanel {
      position: fixed;
      bottom: 15px;
      left: 175px;
      right: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1500;
      transition: all 0.3s ease;
      max-height: 400px;
      overflow: hidden;
    }

    @media (max-width: 768px) {
      #realtimeTablePanel {
        left: 15px;
      }
    }

    #realtimeTablePanel.minimized {
      max-height: 44px;
    }

    #realtimeTablePanelHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
    }

    #realtimeTablePanelHeader h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    #realtimeTablePanelChevron {
      transition: transform 0.3s ease;
    }

    #realtimeTablePanelChevron.rotated {
      transform: rotate(180deg);
    }

    #realtimeTableContainer {
      padding: 15px;
      max-height: 350px;
      overflow-y: auto;
    }

    #realtimeDataTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    #realtimeDataTable th {
      background: #f9fafb;
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 0;
      white-space: nowrap;
    }

    #realtimeDataTable td {
      padding: 10px 12px;
      border-bottom: 1px solid #f3f4f6;
      color: #4b5563;
      white-space: nowrap;
    }

    #realtimeDataTable tr:hover {
      background: #f9fafb;
    }

    .tracker-id-cell {
      font-weight: 600;
      color: #6366f1;
    }

    .no-data-row td {
      text-align: center;
      padding: 30px;
      color: #9ca3af;
      font-style: italic;
    }

    /* ================= IMAGE GRID ================= */
    #images-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding-bottom: 20px;
    }

    .image-container {
      width: calc(25% - 10px);
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }

    @media (max-width: 1200px) {
      .image-container {
        width: calc(33.333% - 10px);
      }
    }

    @media (max-width: 768px) {
      .image-container {
        width: calc(50% - 10px);
      }
    }

    .image-container img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }

    /* ================= REALTIME DATA STYLES ================= */
    .parameter-option {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      cursor: pointer;
    }

    .parameter-option:hover {
      background: #f9fafb;
    }

    .parameter-option input[type="checkbox"] {
      margin-right: 10px;
      cursor: pointer;
      transform: scale(1.1);
    }

    .parameter-option label {
      cursor: pointer;
      flex: 1;
      user-select: none;
    }

    .realtime-tracker-item {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .realtime-tracker-item:hover {
      background: #eef2ff;
    }

    .realtime-tracker-id {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }

    .group-expand-btn {
      margin-left: 8px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .group-expand-btn.rotated {
      transform: rotate(90deg);
    }

    .realtime-group-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      background: #f9fafb;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 5px;
    }

    .realtime-group-header:hover {
      background: #f3f4f6;
    }

    .realtime-group-name {
      flex: 1;
      font-weight: 600;
      color: #374151;
    }

    .realtime-tracker-list {
      margin-left: 15px;
      border-left: 2px solid #e5e7eb;
      padding-left: 10px;
    }

    /* ================= GROUP CONTROLS ================= */
    .group-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .group-control-btn {
      padding: 6px 12px;
      background: rgba(99, 102, 241, 0.8);
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }

    .group-control-btn:hover {
      background: rgba(79, 70, 229, 1);
    }

    /* ================= SCROLLBAR STYLING ================= */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    /* ================= MOBILE MENU TOGGLE ================= */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 4000;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .mobile-menu-toggle {
        display: block;
      }
    }

    /* ================= OVERLAY ================= */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
    }

    .overlay.active {
      display: block;
    }

    /* ================= STATUS MESSAGES ================= */
    .status-loading {
      background: #fef3c7;
      color: #92400e;
    }

    .status-success {
      background: #d1fae5;
      color: #065f46;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* ================= CHECKBOX CONTAINER ================= */
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-preview {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      cursor: pointer;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    /* ================= GROUP TRACKERS LIST ================= */
    .group-trackers {
      margin-top: 8px;
      padding-left: 12px;
      font-size: 13px;
      color: #4b5563;
    }

    .group-trackers div {
      padding: 3px 0;
      cursor: pointer;
    }
    .group-trackers div:hover {
      background: #eef2ff;
      border-radius: 4px;
      padding-left: 6px;
    }

    /* ================= SIMPLIFIED POPUP HEADER ================= */
    .popup-header-simple {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #6366f1;
      color: white;
      cursor: pointer;
    }

    .popup-title {
      font-size: 14px;
      font-weight: 600;
    }
  </style>
</head>

<body>

<button class="mobile-menu-toggle" id="mobileMenuToggle">
  <i data-lucide="menu"></i>
</button>

<header>
  <div class="logo-title">
    <img src="{{ url_for('static', filename='images/logo.svg') }}" class="logo">
    <span class="site-name">DRONE TAG</span>
  </div>
</header>

<div class="overlay" id="overlay"></div>

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar" id="sidebar">
  <nav class="sidebar-nav">
    <div class="sidebar-item" onclick="scrollToTop()">
      <i data-lucide="layout-dashboard" class="sidebar-icon"></i>
      <span>Dashboard</span>
    </div>

    <div class="sidebar-item" id="settingsToggle">
      <div class="item-top">
        <i data-lucide="settings" class="sidebar-icon"></i>
        <span>Settings</span>
      </div>
      <i data-lucide="chevron-down" class="chevron" id="settingsChevron"></i>
    </div>

    <div class="sidebar-dropdown" id="settingsDropdown">
      <div class="dropdown-item" id="openTagPopup">
        <i data-lucide="tag"></i><span>Tag</span>
      </div>
      <div class="dropdown-item">
        <i data-lucide="cpu"></i><span>Sensor</span>
      </div>
      <div class="dropdown-item" id="openRealtimePopup">
        <i data-lucide="activity"></i><span>Real-time Data</span>
      </div>
    </div>

    <div class="sidebar-item" id="reportsToggle">
      <div class="item-top">
        <i data-lucide="file-text" class="sidebar-icon"></i><span>Reports</span>
      </div>
      <i data-lucide="chevron-down" class="chevron" id="reportsChevron"></i>
    </div>

    <div class="sidebar-dropdown" id="reportsDropdown">
      <div class="dropdown-item" id="openGroupPopup">
        <i data-lucide="folder"></i><span>Group Name</span>
      </div>
    </div>
  </nav>
</aside>

<!-- ================= TAG POPUP ================= -->
<div class="tag-popup" id="tagPopup">
  <div class="tag-popup-header" id="tagPopupHeader">
    <h4>Tracker Popup</h4>
    <i data-lucide="chevron-down" class="chevron" id="tagPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="tagPopupBody">
    <div class="tracker-dropdown-header" id="trackerDropdownHeader">
      <span>Available Trackers</span>
      <i data-lucide="chevron-down" class="chevron" id="trackerChevron"></i>
    </div>
    <div class="tracker-dropdown collapsible" id="trackerList"></div>

    <div class="add-tracker">
      <input type="text" id="newTracker" placeholder="Add tracker ID">
      <button id="addTrackerBtn">+</button>
    </div>

    <div class="tag-input-row">
      <input type="text" id="tracker-id" placeholder="Manual Tracker ID">
      <button id="fetch-btn">Fetch</button>
    </div>
  </div>
</div>

<!-- ================= GROUP POPUP ================= -->
<div class="tag-popup" id="groupPopup">
  <div class="tag-popup-header" id="groupPopupHeader">
    <h4>Tracker Groups</h4>
    <i data-lucide="chevron-down" class="chevron" id="groupPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="groupPopupBody">
    <div class="tag-input-row">
      <input type="text" id="groupNameInput" placeholder="Group Name">
      <button id="createGroupBtn">Add Group</button>
    </div>

    <div id="groupList" class="tracker-dropdown collapsible" style="margin-top:10px;"></div>

    <div class="tag-input-row">
      <input type="text" id="groupTrackerInput" placeholder="Tracker ID">
      <button id="addTrackerToGroupBtn">Add</button>
    </div>

    <div class="tag-input-row">
      <button id="fetchGroupBtn" style="width:100%">Fetch Group</button>
    </div>
  </div>
</div>

<!-- ================= GROUP DETAIL POPUP ================= -->
<div class="tag-popup" id="groupDetailPopup">
  <div class="tag-popup-header" id="groupDetailHeader">
    <h4 id="groupDetailTitle">Group</h4>
    <i data-lucide="chevron-down" class="chevron" id="groupDetailChevron"></i>
  </div>

  <div class="tag-popup-body" id="groupDetailBody">
    <!-- Tracker list with checkboxes and color pickers -->
    <div id="groupTrackerList" class="tracker-dropdown collapsible">
      <!-- JS will inject rows -->
    </div>

    <!-- Add tracker to group -->
    <div class="tag-input-row" style="margin-top:10px;">
      <input type="text" id="groupDetailTrackerInput" placeholder="Add Tracker ID" />
      <button id="addTrackerToGroupDetailBtn">Add</button>
    </div>
  </div>
</div>

<!-- ================= REALTIME DATA POPUP ================= -->
<div class="tag-popup" id="realtimePopup">
  <div class="tag-popup-header" id="realtimePopupHeader">
    <h4>Real-time Data Parameters</h4>
    <i data-lucide="chevron-down" class="chevron" id="realtimePopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="realtimePopupBody">
    <!-- Group dropdown -->
    <div class="tracker-dropdown-header" id="realtimeGroupHeader">
      <span>Select Group</span>
      <i data-lucide="chevron-down" class="chevron" id="realtimeGroupChevron"></i>
    </div>
    
    <div class="tracker-dropdown collapsible" id="realtimeGroupList"></div>

    <!-- Tracker parameters section -->
    <div id="trackerParametersSection" style="display: none;">
      <div style="margin: 15px 0 10px 0; font-weight: 600; color: #374151;">
        Selected Tracker: <span id="selectedTrackerId">-</span>
      </div>
      
      <div id="parametersCheckboxes" class="tracker-dropdown collapsible" style="max-height: 200px;">
        <!-- Checkboxes will be added here -->
      </div>
      
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
        <button id="saveParametersBtn" style="width: 100%; padding: 8px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
          Save Parameters
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ================= MAIN CONTENT ================= -->
<main>
  <div id="status-message"></div>
  <div class="last-updated"></div>
  
  <div class="map-container">
    <div id="map"></div>
  </div>
  
  <!-- ================= REALTIME DATA TABLE PANEL ================= -->
  <div id="realtimeTablePanel" class="minimized">
    <div id="realtimeTablePanelHeader">
      <h3>Real-time Data Table</h3>
      <i data-lucide="chevron-up" id="realtimeTablePanelChevron" class="rotated"></i>
    </div>
    <div id="realtimeTableContainer" style="display: none;">
      <table id="realtimeDataTable">
        <thead>
          <tr>
            <th>Tracker ID</th>
            <!-- Dynamic headers will be added here -->
          </tr>
        </thead>
        <tbody>
          <!-- Dynamic rows will be added here -->
        </tbody>
      </table>
    </div>
  </div>
  
  <div id="images-grid"></div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="{{ url_for('static', filename='js/fetchdata.js') }}"></script>

<script>
lucide.createIcons();

/* ================= MOBILE MENU ================= */
const mobileMenuToggle = document.getElementById('mobileMenuToggle');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');

mobileMenuToggle.addEventListener('click', () => {
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
});

overlay.addEventListener('click', () => {
  sidebar.classList.remove('open');
  overlay.classList.remove('active');
});

/* ================= RESPONSIVE HELPERS ================= */
function scrollToTop() {
  document.querySelector('main').scrollTo({ top: 0, behavior: 'smooth' });
}

function closeAllPopups() {
  const popups = document.querySelectorAll('.tag-popup');
  popups.forEach(popup => {
    popup.style.maxHeight = '0';
    popup.classList.add('collapsed');
    const chevron = popup.querySelector('.chevron');
    if (chevron) chevron.classList.remove('rotate');
  });
}

/* ================= POPUP MANAGEMENT ================= */
function makePopupCollapsible(popupId, chevronId) {
  const popup = document.getElementById(popupId);
  const chevron = document.getElementById(chevronId);
  const header = document.getElementById(popupId + 'Header') || popup.querySelector('.tag-popup-header');

  if (!popup || !chevron) return;

  const togglePopup = (e) => {
    if (e) e.stopPropagation();
    const collapsed = popup.classList.toggle("collapsed");
    chevron.classList.toggle("rotate", !collapsed);
    
    if (!collapsed) {
      // Close other popups when opening this one
      const allPopups = document.querySelectorAll('.tag-popup');
      allPopups.forEach(p => {
        if (p.id !== popupId && !p.classList.contains('collapsed')) {
          p.style.maxHeight = '0';
          p.classList.add('collapsed');
          const otherChevron = p.querySelector('.chevron');
          if (otherChevron) otherChevron.classList.remove('rotate');
        }
      });
      
      // Set max height based on content
      const body = popup.querySelector('.tag-popup-body');
      if (body) {
        const height = body.scrollHeight + 48;
        popup.style.maxHeight = `${Math.min(height, 600)}px`;
      }
    } else {
      popup.style.maxHeight = '0';
    }
  };

  chevron.addEventListener("click", togglePopup);
  
  // Also make header clickable
  if (header) {
    header.addEventListener("click", togglePopup);
  }
}

// Initialize all popups
makePopupCollapsible("tagPopup", "tagPopupChevron");
makePopupCollapsible("groupPopup", "groupPopupChevron");
makePopupCollapsible("groupDetailPopup", "groupDetailChevron");
makePopupCollapsible("realtimePopup", "realtimePopupChevron");

/* ================= SIDEBAR DROPDOWNS ================= */
function toggleMenu(toggleBtn, dropdown, chevron) {
  if (!toggleBtn || !dropdown || !chevron) return;
  
  toggleBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const open = dropdown.style.display === "block";
    dropdown.style.display = open ? "none" : "block";
    chevron.classList.toggle("rotate", !open);
  });
}

toggleMenu(
  document.getElementById("settingsToggle"),
  document.getElementById("settingsDropdown"),
  document.getElementById("settingsChevron")
);

toggleMenu(
  document.getElementById("reportsToggle"),
  document.getElementById("reportsDropdown"),
  document.getElementById("reportsChevron")
);

/* ================= REALTIME TABLE PANEL ================= */
const realtimeTablePanel = document.getElementById('realtimeTablePanel');
const realtimeTablePanelHeader = document.getElementById('realtimeTablePanelHeader');
const realtimeTablePanelChevron = document.getElementById('realtimeTablePanelChevron');
const realtimeTableContainer = document.getElementById('realtimeTableContainer');
const realtimeDataTable = document.getElementById('realtimeDataTable');

// Toggle panel visibility
realtimeTablePanelHeader.addEventListener('click', (e) => {
  e.stopPropagation();
  const isMinimized = realtimeTablePanel.classList.toggle('minimized');
  realtimeTablePanelChevron.classList.toggle('rotated', isMinimized);
  
  if (isMinimized) {
    realtimeTableContainer.style.display = 'none';
  } else {
    realtimeTableContainer.style.display = 'block';
    if (window.realtimeTableData && Object.keys(window.realtimeTableData).length > 0) {
      updateRealtimeTable();
    }
  }
});

// Store real-time table data
window.realtimeTableData = {};
window.realtimeTableHeaders = ['Tracker ID'];

// Function to update the real-time data table
window.updateRealtimeTable = function(trackerId, data) {
  if (trackerId && data) {
    window.realtimeTableData[trackerId] = data;
  }
  
  // Get all selected parameters
  const allSelectedParams = new Set(['Tracker ID']);
  Object.keys(window.realtimeTableData).forEach(tid => {
    const params = window.getRealtimeParameters ? window.getRealtimeParameters(tid) : null;
    if (params) {
      Object.keys(params).forEach(param => {
        if (params[param]) allSelectedParams.add(param);
      });
    }
  });
  
  window.realtimeTableHeaders = Array.from(allSelectedParams);
  
  // Update table headers
  const thead = realtimeDataTable.querySelector('thead');
  const headerRow = thead.querySelector('tr');
  headerRow.innerHTML = '';
  
  window.realtimeTableHeaders.forEach(header => {
    const th = document.createElement('th');
    th.textContent = formatHeaderText(header);
    headerRow.appendChild(th);
  });
  
  // Update table body
  const tbody = realtimeDataTable.querySelector('tbody');
  tbody.innerHTML = '';
  
  if (Object.keys(window.realtimeTableData).length === 0) {
    const noDataRow = document.createElement('tr');
    noDataRow.className = 'no-data-row';
    const td = document.createElement('td');
    td.colSpan = window.realtimeTableHeaders.length;
    td.textContent = 'No real-time data available. Fetch a tracker first.';
    noDataRow.appendChild(td);
    tbody.appendChild(noDataRow);
    return;
  }
  
  Object.keys(window.realtimeTableData).forEach(tid => {
    const row = document.createElement('tr');
    
    window.realtimeTableHeaders.forEach(header => {
      const td = document.createElement('td');
      
      if (header === 'Tracker ID') {
        td.className = 'tracker-id-cell';
        td.textContent = tid;
      } else {
        const params = window.getRealtimeParameters ? window.getRealtimeParameters(tid) : null;
        if (params && params[header] && window.realtimeTableData[tid][header]) {
          td.textContent = formatCellValue(header, window.realtimeTableData[tid][header]);
        } else {
          td.textContent = '-';
          td.style.color = '#9ca3af';
        }
      }
      
      row.appendChild(td);
    });
    
    tbody.appendChild(row);
  });
  
  // Auto-open panel if minimized and has data
   if (realtimeTablePanel.classList.contains('minimized') && Object.keys(window.realtimeTableData).length > 0) {
    realtimeTablePanel.classList.remove('minimized');
    realtimeTablePanelChevron.classList.remove('rotated');
    realtimeTableContainer.style.display = 'block';
  }
}; 

function formatHeaderText(header) {
  const formatMap = {
    'timestamp': 'Timestamp',
    'latitude': 'Latitude',
    'longitude': 'Longitude',
    'altitude': 'Altitude',
    'uin_no': 'UIN No',
    'application': 'Application',
    'category': 'Category',
    'Tracker ID': 'Tracker ID'
  };
  return formatMap[header] || header;
}

function formatCellValue(header, value) {
  if (header === 'timestamp' && value) {
    try {
      return new Date(value).toLocaleString();
    } catch (e) {
      return value;
    }
  }
  if ((header === 'latitude' || header === 'longitude') && value) {
    return parseFloat(value).toFixed(6);
  }
  if (header === 'altitude' && value) {
    return `${parseFloat(value).toFixed(1)} m`;
  }
  return value || '-';
}

// Initialize table
window.updateRealtimeTable();

/* ================= STORAGE ================= */
const STORAGE_KEY = "saved_trackers";
const GROUP_KEY = "tracker_groups";
const REALTIME_SETTINGS_KEY = "realtime_parameters";
let activeGroup = null;
let selectedTrackerForRealtime = null;

const getSavedTrackers = () => JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
const saveTracker = (id) => {
  const trackers = getSavedTrackers();
  if (!trackers.includes(id)) {
    trackers.push(id);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(trackers));
  }
};

const getGroups = () => JSON.parse(localStorage.getItem(GROUP_KEY)) || {};
const saveGroups = (groups) => localStorage.setItem(GROUP_KEY, JSON.stringify(groups));

/* ================= REALTIME DATA SETTINGS ================= */
const getRealtimeSettings = () => JSON.parse(localStorage.getItem(REALTIME_SETTINGS_KEY)) || {};
const saveRealtimeSettings = (settings) => localStorage.setItem(REALTIME_SETTINGS_KEY, JSON.stringify(settings));

const availableParameters = [
  { id: 'timestamp', label: 'Timestamp', default: true },
  { id: 'latitude', label: 'Latitude', default: true },
  { id: 'longitude', label: 'Longitude', default: true },
  { id: 'altitude', label: 'Altitude', default: true },
  { id: 'uin_no', label: 'UIN No', default: true },
  { id: 'application', label: 'Application', default: true },
  { id: 'category', label: 'Category', default: true }
];

/* ================= TAG POPUP FUNCTIONS ================= */
const tagPopup = document.getElementById("tagPopup");
const trackerList = document.getElementById("trackerList");
const trackerInput = document.getElementById("tracker-id");

document.getElementById("openTagPopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  tagPopup.style.maxHeight = "600px";
  tagPopup.classList.remove("collapsed");
  document.getElementById("tagPopupChevron").classList.add("rotate");
  renderTrackers();
};

function renderTrackers() {
  trackerList.innerHTML = "";
  getSavedTrackers().forEach(id => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = id;
    div.onclick = () => handleFetch(id);
    trackerList.appendChild(div);
  });
}

function handleFetch(id) {
  if (!id) return;
  trackerInput.value = id;
  saveTracker(id);
  renderTrackers();
  if (typeof fetchDroneData === "function") {
    fetchDroneData();
  }
}

document.getElementById("fetch-btn").onclick = () => handleFetch(trackerInput.value.trim());
document.getElementById("addTrackerBtn").onclick = () => {
  const val = document.getElementById("newTracker").value.trim();
  if (!val) return;
  saveTracker(val);
  renderTrackers();
  document.getElementById("newTracker").value = "";
};

/* ================= GROUP POPUP FUNCTIONS ================= */
const groupPopup = document.getElementById("groupPopup");
const groupList = document.getElementById("groupList");

document.getElementById("openGroupPopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  groupPopup.style.maxHeight = "600px";
  groupPopup.classList.remove("collapsed");
  document.getElementById("groupPopupChevron").classList.add("rotate");
  renderGroups();
};

function renderGroups() {
  groupList.innerHTML = "";
  const groups = getGroups();
  Object.keys(groups).forEach(groupName => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = groupName;
    div.addEventListener("click", () => {
      openGroupDetail(groupName);
      groupDetailPopup.style.maxHeight = "600px";
      groupDetailPopup.classList.remove("collapsed");
    });
    groupList.appendChild(div);
  });
}

document.getElementById("createGroupBtn").onclick = () => {
  const name = document.getElementById("groupNameInput").value.trim();
  if (!name) return;
  const groups = getGroups();
  if (!groups[name]) groups[name] = [];
  saveGroups(groups);
  document.getElementById("groupNameInput").value = "";
  renderGroups();
};

/* ================= GROUP DETAIL POPUP ================= */
const groupDetailPopup = document.getElementById("groupDetailPopup");
const groupTrackerList = document.getElementById("groupTrackerList");
const groupDetailTitle = document.getElementById("groupDetailTitle");

let groupSettings = JSON.parse(localStorage.getItem('groupSettings')) || {};
const defaultColors = [
  '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', 
  '#EF476F', '#9D4EDD', '#FB5607', '#3A86FF', '#8338EC'
];

function openGroupDetail(groupName) {
  if (window.setActiveGroup) window.setActiveGroup(groupName);
  activeGroup = groupName;
  groupDetailTitle.textContent = groupName;
  const groups = getGroups();
  groupTrackerList.innerHTML = "";
  
  if (!groupSettings[groupName]) groupSettings[groupName] = {};
  
  (groups[groupName] || []).forEach((tid, index) => {
    if (!groupSettings[groupName][tid]) {
      groupSettings[groupName][tid] = {
        visible: true,
        color: defaultColors[index % defaultColors.length]
      };
    }
    
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.dataset.trackerId = tid;
    
    const checkboxContainer = document.createElement("div");
    checkboxContainer.className = "checkbox-container";
    
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "tracker-checkbox";
    checkbox.checked = groupSettings[groupName][tid].visible;
    checkbox.dataset.trackerId = tid;
    
    const colorPicker = document.createElement("input");
    colorPicker.type = "color";
    colorPicker.className = "tracker-color-picker";
    colorPicker.value = groupSettings[groupName][tid].color;
    colorPicker.dataset.trackerId = tid;
    colorPicker.style.display = "none";
    
    const colorPreview = document.createElement("div");
    colorPreview.className = "color-preview";
    colorPreview.style.backgroundColor = groupSettings[groupName][tid].color;
    
    const trackerIdSpan = document.createElement("span");
    trackerIdSpan.className = "tracker-id-text";
    trackerIdSpan.textContent = tid;
    trackerIdSpan.dataset.trackerId = tid;
    
    trackerIdSpan.onclick = () => {
      if (window.handleFetch) window.handleFetch(tid);
    };
    
    checkbox.onchange = (e) => {
      const trackerId = e.target.dataset.trackerId;
      const isVisible = e.target.checked;
      groupSettings[groupName][trackerId].visible = isVisible;
      saveGroupSettings();
      if (window.updateTrackerVisibilityFromGroup) {
        window.updateTrackerVisibilityFromGroup(trackerId, isVisible);
      }
    };
    
    colorPicker.onchange = (e) => {
      const trackerId = e.target.dataset.trackerId;
      const newColor = e.target.value;
      groupSettings[groupName][trackerId].color = newColor;
      saveGroupSettings();
      colorPreview.style.backgroundColor = newColor;
      if (window.updateTrackerColorFromGroup) {
        window.updateTrackerColorFromGroup(trackerId, newColor);
      }
    };
    
    colorPreview.onclick = () => colorPicker.click();
    
    checkboxContainer.appendChild(checkbox);
    checkboxContainer.appendChild(colorPreview);
    div.appendChild(checkboxContainer);
    div.appendChild(colorPicker);
    div.appendChild(trackerIdSpan);
    groupTrackerList.appendChild(div);
  });
  
  saveGroupSettings();
}

function saveGroupSettings() {
  localStorage.setItem('groupSettings', JSON.stringify(groupSettings));
}

// Add tracker to group (from group popup)
document.getElementById("addTrackerToGroupBtn").onclick = () => {
  if (!activeGroup) {
    alert("Select a group first");
    return;
  }
  const tracker = document.getElementById("groupTrackerInput").value.trim();
  if (!tracker) return;
  const groups = getGroups();
  if (!groups[activeGroup].includes(tracker)) {
    groups[activeGroup].push(tracker);
    saveGroups(groups);
  }
  document.getElementById("groupTrackerInput").value = "";
  renderGroups();
};

// Add tracker to group (from group detail popup)
document.getElementById("addTrackerToGroupDetailBtn").onclick = () => {
  if (!activeGroup) return;
  const tracker = document.getElementById("groupDetailTrackerInput").value.trim();
  if (!tracker) return;
  const groups = getGroups();
  if (!groups[activeGroup].includes(tracker)) {
    groups[activeGroup].push(tracker);
    saveGroups(groups);
    if (!groupSettings[activeGroup]) groupSettings[activeGroup] = {};
    const index = groups[activeGroup].length - 1;
    groupSettings[activeGroup][tracker] = {
      visible: true,
      color: defaultColors[index % defaultColors.length]
    };
    saveGroupSettings();
  }
  document.getElementById("groupDetailTrackerInput").value = "";
  openGroupDetail(activeGroup);
};

// Fetch group button
document.getElementById("fetchGroupBtn").onclick = () => {
  if (!activeGroup) {
    alert("Select a group first");
    return;
  }
  const groups = getGroups();
  const trackerIds = groups[activeGroup] || [];
  if (trackerIds.length === 0) {
    alert("No trackers in this group");
    return;
  }
  if (window.fetchGroupTrackers) window.fetchGroupTrackers(trackerIds);
};

/* ================= REALTIME DATA POPUP ================= */
const realtimePopup = document.getElementById("realtimePopup");
const realtimeGroupList = document.getElementById("realtimeGroupList");

document.getElementById("openRealtimePopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  realtimePopup.style.maxHeight = "600px";
  realtimePopup.classList.remove("collapsed");
  document.getElementById("realtimePopupChevron").classList.add("rotate");
  renderRealtimeGroups();
};

function renderRealtimeGroups() {
  realtimeGroupList.innerHTML = "";
  const groups = getGroups();
  
  if (Object.keys(groups).length === 0) {
    realtimeGroupList.innerHTML = `
      <div style="padding: 20px; text-align: center; color: #6b7280;">
        No groups found. Create groups first.
      </div>
    `;
    return;
  }
  
  Object.keys(groups).forEach(groupName => {
    const groupDiv = document.createElement("div");
    groupDiv.className = "realtime-group-header";
    groupDiv.innerHTML = `
      <i data-lucide="folder" style="width: 16px; height: 16px; margin-right: 8px; color: #6366f1;"></i>
      <span class="realtime-group-name">${groupName}</span>
      <i data-lucide="chevron-right" class="group-expand-btn" style="width: 16px; height: 16px;"></i>
    `;
    
    const trackerList = document.createElement("div");
    trackerList.className = "realtime-tracker-list";
    trackerList.style.display = "none";
    
    groups[groupName].forEach(trackerId => {
      const trackerDiv = document.createElement("div");
      trackerDiv.className = "realtime-tracker-item";
      trackerDiv.dataset.trackerId = trackerId;
      trackerDiv.dataset.groupName = groupName;
      trackerDiv.innerHTML = `
        <i data-lucide="tag" style="width: 14px; height: 14px; margin-right: 8px; color: #6b7280;"></i>
        <span class="realtime-tracker-id">${trackerId}</span>
      `;
      trackerDiv.onclick = (e) => {
        e.stopPropagation();
        showTrackerParameters(trackerId);
      };
      trackerList.appendChild(trackerDiv);
    });
    
    const chevron = groupDiv.querySelector(".group-expand-btn");
    groupDiv.onclick = () => {
      const isExpanded = trackerList.style.display === "block";
      trackerList.style.display = isExpanded ? "none" : "block";
      chevron.classList.toggle("rotated", !isExpanded);
      lucide.createIcons();
    };
    
    realtimeGroupList.appendChild(groupDiv);
    realtimeGroupList.appendChild(trackerList);
  });
  
  lucide.createIcons();
}

function showTrackerParameters(trackerId) {
  selectedTrackerForRealtime = trackerId;
  document.getElementById("selectedTrackerId").textContent = trackerId;
  document.getElementById("trackerParametersSection").style.display = "block";
  
  const parametersContainer = document.getElementById("parametersCheckboxes");
  parametersContainer.innerHTML = "";
  
  const settings = getRealtimeSettings();
  const trackerSettings = settings[trackerId] || {};
  
  availableParameters.forEach(param => {
    const div = document.createElement("div");
    div.className = "parameter-option";
    const checkboxId = `param_${trackerId}_${param.id}`;
    const isChecked = trackerSettings[param.id] !== undefined ? 
                      trackerSettings[param.id] : param.default;
    div.innerHTML = `
      <input type="checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}>
      <label for="${checkboxId}">${param.label}</label>
    `;
    const checkbox = div.querySelector('input');
    checkbox.onchange = () => {};
    parametersContainer.appendChild(div);
  });
}

document.getElementById("saveParametersBtn").onclick = () => {
  if (!selectedTrackerForRealtime) {
    alert("Please select a tracker first");
    return;
  }
  const settings = getRealtimeSettings();
  settings[selectedTrackerForRealtime] = settings[selectedTrackerForRealtime] || {};
  availableParameters.forEach(param => {
    const checkboxId = `param_${selectedTrackerForRealtime}_${param.id}`;
    const checkbox = document.getElementById(checkboxId);
    if (checkbox) settings[selectedTrackerForRealtime][param.id] = checkbox.checked;
  });
  saveRealtimeSettings(settings);
  const btn = document.getElementById("saveParametersBtn");
  const originalText = btn.textContent;
  btn.textContent = "Saved!";
  btn.style.background = "#10b981";
  setTimeout(() => {
    btn.textContent = originalText;
    btn.style.background = "#6366f1";
  }, 1500);
  if (window.realtimeTableData && window.realtimeTableData[selectedTrackerForRealtime]) {
    window.updateRealtimeTable();
  }
};

window.getRealtimeParameters = function(trackerId) {
  const settings = getRealtimeSettings();
  const trackerSettings = settings[trackerId];
  if (!trackerSettings) {
    return availableParameters.reduce((acc, param) => {
      acc[param.id] = param.default;
      return acc;
    }, {});
  }
  return trackerSettings;
};

window.formatRealtimeData = function(data, trackerId) {
  const parameters = window.getRealtimeParameters(trackerId);
  const formatted = { 'Tracker ID': trackerId };
  Object.keys(parameters).forEach(param => {
    if (parameters[param] && data[param] !== undefined) {
      formatted[param] = data[param];
    }
  });
  return formatted;
};

// Make realtime group dropdown collapsible
document.getElementById("realtimeGroupHeader").onclick = () => {
  const chevron = document.getElementById("realtimeGroupChevron");
  const dropdown = document.getElementById("realtimeGroupList");
  const isCollapsed = dropdown.style.display === "none";
  dropdown.style.display = isCollapsed ? "block" : "none";
  chevron.classList.toggle("rotate", isCollapsed);
};

/* ================= WINDOW RESIZE HANDLER ================= */
function handleResize() {
  const isMobile = window.innerWidth <= 768;
  if (!isMobile) {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
  }
}

window.addEventListener('resize', handleResize);
handleResize();

/* ================= INITIALIZATION ================= */
renderTrackers();
renderGroups();

// Auto-open real-time table panel if there's data
window.addEventListener('load', function() {
  setTimeout(() => {
    if (Object.keys(window.realtimeTableData).length > 0) {
      realtimeTablePanel.classList.remove('minimized');
      realtimeTablePanelChevron.classList.remove('rotated');
      realtimeTableContainer.style.display = 'block';
      window.updateRealtimeTable();
    }
  }, 1000);
});

// Close popups when clicking Escape key or outside
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeAllPopups();
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
  }
});

// Close popups when clicking outside
document.addEventListener('click', (e) => {
  const popups = document.querySelectorAll('.tag-popup');
  const isClickInsidePopup = Array.from(popups).some(popup => popup.contains(e.target));
  const isClickInsideSidebar = sidebar.contains(e.target);
  const isClickOnMobileToggle = mobileMenuToggle.contains(e.target);
  
  if (!isClickInsidePopup && !isClickInsideSidebar && !isClickOnMobileToggle) {
    closeAllPopups();
  }
});
</script>

</body>
</html> #}







































 
{# <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drone Tracker Dashboard</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* ================= BASE STYLES ================= */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      background: #f9fafb;
    }

    /* ================= HEADER ================= */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 3000;
    }

    .logo-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      height: 40px;
      width: 40px;
    }

    .site-name {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
    }

    /* ================= SIDEBAR ================= */
    .sidebar {
      position: fixed;
      top: 70px;
      left: 0;
      bottom: 0;
      width: 160px;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      z-index: 2000;
      overflow-y: auto;
      transition: transform 0.3s ease;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        width: 200px;
      }
      .sidebar.open {
        transform: translateX(0);
      }
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      flex-shrink: 0;
      display: none;
    }

    .sidebar-nav {
      padding: 12px 8px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .sidebar-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 14px 10px;
      margin-bottom: 8px;
      cursor: pointer;
      border-radius: 10px;
      transition: background 0.2s ease;
    }

    .sidebar-item:hover {
      background: #f3f4f6;
    }

    .item-top {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .sidebar-icon {
      width: 40px;
      height: 40px;
      color: #6366f1;
    }

    .sidebar-item span {
      font-size: 13px;
      color: #374151;
    }

    .chevron {
      margin-top: 6px;
      transition: transform 0.2s ease;
      color: #6b7280;
    }

    .chevron.rotate {
      transform: rotate(180deg);
    }

    .sidebar-dropdown {
      display: none;
      margin-left: 12px;
      margin-bottom: 10px;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 500;
      color: #4b5563;
      cursor: pointer;
      border-radius: 8px;
    }

    .dropdown-item:hover {
      background: #eef2ff;
    }

    /* ================= MAIN CONTENT ================= */
    main {
      position: fixed;
      top: 70px;
      left: 160px;
      right: 0;
      bottom: 0;
      padding: 15px;
      overflow-y: auto;
      z-index: 1;
      transition: left 0.3s ease;
    }

    @media (max-width: 768px) {
      main {
        left: 0;
      }
    }

    #status-message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }

    .last-updated {
      margin-bottom: 15px;
      font-size: 13px;
      color: #6b7280;
    }

    /* ================= MAP CONTAINER ================= */
    .map-container {
      position: relative;
      height: calc(100vh - 210px);
      min-height: 400px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    #map {
      height: 100%;
      width: 100%;
    }

    /* ================= POPUPS ================= */
    .tag-popup {
      position: fixed;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      z-index: 2500;
      overflow: hidden;
      transition: all 0.3s ease;
      max-height: 0;
      border-left: 4px solid #6366f1;
    }

    @media (max-width: 1024px) {
      .tag-popup {
        left: 50% !important;
        transform: translateX(-50%);
        width: 90% !important;
        max-width: 400px;
      }
    }

    .tag-popup.collapsed {
      max-height: 0 !important;
    }

    .tag-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 16px;
      background: #f3f4f6;
      border-bottom: 1px solid #e5e7eb;
    }

    .tag-popup-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      flex: 1;
    }

    .tag-popup-body {
      padding: 16px;
      display: block;
    }

    .tag-popup.collapsed .tag-popup-body {
      display: none;
    }

    .tag-popup.collapsed .tag-popup-header {
      border-bottom: none;
    }

    .tracker-dropdown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 8px 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 6px;
    }

    .tracker-dropdown.collapsible {
      display: block;
      max-height: 160px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .tracker-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      cursor: pointer;
    }

    .tracker-option:hover {
      background: #eef2ff;
    }

    .tracker-option input[type="checkbox"] {
      transform: scale(1.1);
      cursor: pointer;
    }

    .tracker-option input[type="color"] {
      width: 28px;
      height: 28px;
      border: none;
      padding: 0;
      cursor: pointer;
      border-radius: 4px;
    }

    .tracker-option span {
      flex: 1;
      cursor: pointer;
    }

    .add-tracker {
      padding: 8px;
      display: flex;
      gap: 6px;
      border-top: 1px solid #e5e7eb;
    }

    .tag-input-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .tag-input-row input {
      flex: 1;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
    }

    .tag-input-row button {
      padding: 8px 12px;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .tag-input-row button:hover {
      background: #4f46e5;
    }

    /* Popup positioning */
    #tagPopup {
      left: 170px;
      top: 90px;
      width: 320px;
    }

    #sensorPopup {
      left: 170px;
      top: 140px;
      width: 320px;
    }

    #groupPopup {
      left: 170px;
      top: 190px;
      width: 320px;
    }

    #groupDetailPopup {
      left: 510px;
      top: 90px;
      width: 320px;
    }

    #realtimePopup {
      left: 170px;
      top: 240px;
      width: 320px;
    }

    /* ================= SENSOR DATA TABLE PANEL ================= */
    #sensorTablePanel {
      position: fixed;
      bottom: 80px;                      /* can move sensor panel up or down */
      left: 175px;
      right: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1500;
      transition: all 0.3s ease;
      max-height: 250px;
      overflow: hidden;
    }

    @media (max-width: 768px) {
      #sensorTablePanel {
        left: 15px;
        bottom: 220px;
      }
    }

    #sensorTablePanel.minimized {
      max-height: 44px;
    }

    #sensorTablePanelHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
    }

    #sensorTablePanelHeader h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    #sensorTablePanelChevron {
      transition: transform 0.3s ease;
    }

    #sensorTablePanelChevron.rotated {
      transform: rotate(180deg);
    }

    #sensorTableContainer {
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    #sensorDataTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    #sensorDataTable th {
      background: #f9fafb;
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 0;
      white-space: nowrap;
    }

    #sensorDataTable td {
      padding: 10px 12px;
      border-bottom: 1px solid #f3f4f6;
      color: #4b5563;
      white-space: nowrap;
    }

    #sensorDataTable tr:hover {
      background: #f9fafb;
    }

    .sensor-id-cell {
      font-weight: 600;
      color: #10b981;
    }

    /* ================= REALTIME DATA TABLE PANEL ================= */
    #realtimeTablePanel {
      position: fixed;
      bottom: 15px;
      left: 175px;
      right: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1500;
      transition: all 0.3s ease;
      max-height: 250px;
      overflow: hidden;
    }

    @media (max-width: 768px) {
      #realtimeTablePanel {
        left: 15px;
      }
    }

    #realtimeTablePanel.minimized {
      max-height: 44px;
    }

    #realtimeTablePanelHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
    }

    #realtimeTablePanelHeader h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    #realtimeTablePanelChevron {
      transition: transform 0.3s ease;
    }

    #realtimeTablePanelChevron.rotated {
      transform: rotate(180deg);
    }

    #realtimeTableContainer {
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    #realtimeDataTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    #realtimeDataTable th {
      background: #f9fafb;
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 0;
      white-space: nowrap;
    }

    #realtimeDataTable td {
      padding: 10px 12px;
      border-bottom: 1px solid #f3f4f6;
      color: #4b5563;
      white-space: nowrap;
    }

    #realtimeDataTable tr:hover {
      background: #f9fafb;
    }

    .tracker-id-cell {
      font-weight: 600;
      color: #6366f1;
    }

    .no-data-row td {
      text-align: center;
      padding: 30px;
      color: #9ca3af;
      font-style: italic;
    }

    /* ================= IMAGE GRID ================= */
    #images-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding-bottom: 20px;
    }

    .image-container {
      width: calc(25% - 10px);
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }

    @media (max-width: 1200px) {
      .image-container {
        width: calc(33.333% - 10px);
      }
    }

    @media (max-width: 768px) {
      .image-container {
        width: calc(50% - 10px);
      }
    }

    .image-container img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }

    /* ================= REALTIME DATA STYLES ================= */
    .parameter-option {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      cursor: pointer;
    }

    .parameter-option:hover {
      background: #f9fafb;
    }

    .parameter-option input[type="checkbox"] {
      margin-right: 10px;
      cursor: pointer;
      transform: scale(1.1);
    }

    .parameter-option label {
      cursor: pointer;
      flex: 1;
      user-select: none;
    }

    .realtime-tracker-item {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .realtime-tracker-item:hover {
      background: #eef2ff;
    }

    .realtime-tracker-id {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }

    .group-expand-btn {
      margin-left: 8px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .group-expand-btn.rotated {
      transform: rotate(90deg);
    }

    .realtime-group-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      background: #f9fafb;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 5px;
    }

    .realtime-group-header:hover {
      background: #f3f4f6;
    }

    .realtime-group-name {
      flex: 1;
      font-weight: 600;
      color: #374151;
    }

    .realtime-tracker-list {
      margin-left: 15px;
      border-left: 2px solid #e5e7eb;
      padding-left: 10px;
    }

    /* ================= GROUP CONTROLS ================= */
    .group-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .group-control-btn {
      padding: 6px 12px;
      background: rgba(99, 102, 241, 0.8);
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }

    .group-control-btn:hover {
      background: rgba(79, 70, 229, 1);
    }

    /* ================= SCROLLBAR STYLING ================= */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    /* ================= MOBILE MENU TOGGLE ================= */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 4000;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .mobile-menu-toggle {
        display: block;
      }
    }

    /* ================= OVERLAY ================= */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
    }

    .overlay.active {
      display: block;
    }

    /* ================= STATUS MESSAGES ================= */
    .status-loading {
      background: #fef3c7;
      color: #92400e;
    }

    .status-success {
      background: #d1fae5;
      color: #065f46;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* ================= CHECKBOX CONTAINER ================= */
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-preview {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      cursor: pointer;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    /* ================= SENSOR POPUP STYLES ================= */
    .sensor-input-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .sensor-input-row input {
      flex: 1;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
    }

    .sensor-input-row button {
      padding: 8px 12px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .sensor-input-row button:hover {
      background: #059669;
    }
  </style>
</head>

<body>

<button class="mobile-menu-toggle" id="mobileMenuToggle">
  <i data-lucide="menu"></i>
</button>

<header>
  <div class="logo-title">
    <img src="{{ url_for('static', filename='images/logo.svg') }}" class="logo">
    <span class="site-name">DRONE TAG</span>
  </div>
</header>

<div class="overlay" id="overlay"></div>

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar" id="sidebar">
  <nav class="sidebar-nav">
    <div class="sidebar-item" onclick="scrollToTop()">
      <i data-lucide="layout-dashboard" class="sidebar-icon"></i>
      <span>Dashboard</span>
    </div>

    <div class="sidebar-item" id="settingsToggle">
      <div class="item-top">
        <i data-lucide="settings" class="sidebar-icon"></i>
        <span>Settings</span>
      </div>
      <i data-lucide="chevron-down" class="chevron" id="settingsChevron"></i>
    </div>

    <div class="sidebar-dropdown" id="settingsDropdown">
      <div class="dropdown-item" id="openTagPopup">
        <i data-lucide="tag"></i><span>Tag</span>
      </div>
      <div class="dropdown-item" id="openSensorPopup">
        <i data-lucide="cpu"></i><span>Sensor</span>
      </div>
      <div class="dropdown-item" id="openRealtimePopup">
        <i data-lucide="activity"></i><span>Real-time Data</span>
      </div>
    </div>

    <div class="sidebar-item" id="reportsToggle">
      <div class="item-top">
        <i data-lucide="file-text" class="sidebar-icon"></i><span>Reports</span>
      </div>
      <i data-lucide="chevron-down" class="chevron" id="reportsChevron"></i>
    </div>

    <div class="sidebar-dropdown" id="reportsDropdown">
      <div class="dropdown-item" id="openGroupPopup">
        <i data-lucide="folder"></i><span>Group Name</span>
      </div>
    </div>
  </nav>
</aside>

<!-- ================= TAG POPUP ================= -->
<div class="tag-popup" id="tagPopup">
  <div class="tag-popup-header" id="tagPopupHeader">
    <h4>Tracker Popup</h4>
    <i data-lucide="chevron-down" class="chevron" id="tagPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="tagPopupBody">
    <div class="tracker-dropdown-header" id="trackerDropdownHeader">
      <span>Available Trackers</span>
      <i data-lucide="chevron-down" class="chevron" id="trackerChevron"></i>
    </div>
    <div class="tracker-dropdown collapsible" id="trackerList"></div>

    <div class="add-tracker">
      <input type="text" id="newTracker" placeholder="Add tracker ID">
      <button id="addTrackerBtn">+</button>
    </div>

    <div class="tag-input-row">
      <input type="text" id="tracker-id" placeholder="Manual Tracker ID">
      <button id="fetch-btn">Fetch</button>
    </div>
  </div>
</div>

<!-- ================= SENSOR POPUP ================= -->
<div class="tag-popup" id="sensorPopup">
  <div class="tag-popup-header" id="sensorPopupHeader">
    <h4>Sensor Data</h4>
    <i data-lucide="chevron-down" class="chevron" id="sensorPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="sensorPopupBody">
    <div class="tracker-dropdown-header" id="sensorDropdownHeader">
      <span>Available Sensors</span>
      <i data-lucide="chevron-down" class="chevron" id="sensorChevron"></i>
    </div>
    <div class="tracker-dropdown collapsible" id="sensorList"></div>

    <div class="add-tracker">
      <input type="text" id="newSensor" placeholder="Add sensor ID">
      <button id="addSensorBtn">+</button>
    </div>

    <div class="sensor-input-row">
      <input type="text" id="sensor-id" placeholder="Manual Sensor ID">
      <button id="fetch-sensor-btn">Fetch Sensor</button>
    </div>
  </div>
</div>

<!-- ================= GROUP POPUP ================= -->
<div class="tag-popup" id="groupPopup">
  <div class="tag-popup-header" id="groupPopupHeader">
    <h4>Tracker Groups</h4>
    <i data-lucide="chevron-down" class="chevron" id="groupPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="groupPopupBody">
    <div class="tag-input-row">
      <input type="text" id="groupNameInput" placeholder="Group Name">
      <button id="createGroupBtn">Add Group</button>
    </div>

    <div id="groupList" class="tracker-dropdown collapsible" style="margin-top:10px;"></div>

    <div class="tag-input-row">
      <input type="text" id="groupTrackerInput" placeholder="Tracker ID">
      <button id="addTrackerToGroupBtn">Add</button>
    </div>

    <div class="tag-input-row">
      <button id="fetchGroupBtn" style="width:100%">Fetch Group</button>
    </div>
  </div>
</div>

<!-- ================= GROUP DETAIL POPUP ================= -->
<div class="tag-popup" id="groupDetailPopup">
  <div class="tag-popup-header" id="groupDetailHeader">
    <h4 id="groupDetailTitle">Group</h4>
    <i data-lucide="chevron-down" class="chevron" id="groupDetailChevron"></i>
  </div>

  <div class="tag-popup-body" id="groupDetailBody">
    <div id="groupTrackerList" class="tracker-dropdown collapsible"></div>

    <div class="tag-input-row" style="margin-top:10px;">
      <input type="text" id="groupDetailTrackerInput" placeholder="Add Tracker ID" />
      <button id="addTrackerToGroupDetailBtn">Add</button>
    </div>
  </div>
</div>

<!-- ================= REALTIME DATA POPUP ================= -->
<div class="tag-popup" id="realtimePopup">
  <div class="tag-popup-header" id="realtimePopupHeader">
    <h4>Real-time Data Parameters</h4>
    <i data-lucide="chevron-down" class="chevron" id="realtimePopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="realtimePopupBody">
    <div class="tracker-dropdown-header" id="realtimeGroupHeader">
      <span>Select Group</span>
      <i data-lucide="chevron-down" class="chevron" id="realtimeGroupChevron"></i>
    </div>
    
    <div class="tracker-dropdown collapsible" id="realtimeGroupList"></div>

    <div id="trackerParametersSection" style="display: none;">
      <div style="margin: 15px 0 10px 0; font-weight: 600; color: #374151;">
        Selected Tracker: <span id="selectedTrackerId">-</span>
      </div>
      
      <div id="parametersCheckboxes" class="tracker-dropdown collapsible" style="max-height: 200px;"></div>
      
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
        <button id="saveParametersBtn" style="width: 100%; padding: 8px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
          Save Parameters
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ================= MAIN CONTENT ================= -->
<main>
  <div id="status-message"></div>
  <div class="last-updated"></div>
  
  <div class="map-container">
    <div id="map"></div>
  </div>
  
 <!-- ================= SENSOR DATA TABLE PANEL ================= -->
<div id="sensorTablePanel" class="minimized">
  <div id="sensorTablePanelHeader">
    <h3>Sensor Data Table</h3>
    <i data-lucide="chevron-up" id="sensorTablePanelChevron" class="rotated"></i>
  </div>
  <div id="sensorTableContainer" style="display: none;">
    <table id="sensorDataTable">
     <thead id="sensorDataTableHeader">
        <tr>
          <th>Sensor ID</th>
          <th>Timestamp</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Moisture</th>
          <th>Temperature</th>
          <th>EC</th>
          <th>pH Value</th>
          <th>Nitrogen</th>
          <th>Phosphorous</th>
          <th>Potassium</th>
          <th>Satellite Fix</th>
        </tr>
      </thead>

      <tbody id="sensorDataTableBody">
        <tr class="no-data-row">
          <td colspan="12">No sensor data available. Fetch a sensor first.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
  
  <!-- ================= REALTIME DATA TABLE PANEL ================= -->
  <div id="realtimeTablePanel" class="minimized">
    <div id="realtimeTablePanelHeader">
      <h3>Tracker Data Table</h3>
      <i data-lucide="chevron-up" id="realtimeTablePanelChevron" class="rotated"></i>
    </div>
    <div id="realtimeTableContainer" style="display: none;">
      <table id="realtimeDataTable">
        <thead>
          <tr>
            <th>Tracker ID</th>
          </tr>
        </thead>
        <tbody>
          <tr class="no-data-row">
            <td>No tracker data available. Fetch a tracker first.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <div id="images-grid"></div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="{{ url_for('static', filename='js/fetchdata.js') }}"></script>

<script>
lucide.createIcons();

/* ================= MOBILE MENU ================= */
const mobileMenuToggle = document.getElementById('mobileMenuToggle');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');

mobileMenuToggle.addEventListener('click', () => {
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
});

overlay.addEventListener('click', () => {
  sidebar.classList.remove('open');
  overlay.classList.remove('active');
});

/* ================= RESPONSIVE HELPERS ================= */
function scrollToTop() {
  document.querySelector('main').scrollTo({ top: 0, behavior: 'smooth' });
}

function closeAllPopups() {
  const popups = document.querySelectorAll('.tag-popup');
  popups.forEach(popup => {
    popup.style.maxHeight = '0';
    popup.classList.add('collapsed');
    const chevron = popup.querySelector('.chevron');
    if (chevron) chevron.classList.remove('rotate');
  });
}

/* ================= POPUP MANAGEMENT ================= */
function makePopupCollapsible(popupId, chevronId) {
  const popup = document.getElementById(popupId);
  const chevron = document.getElementById(chevronId);
  const header = document.getElementById(popupId + 'Header') || popup.querySelector('.tag-popup-header');

  if (!popup || !chevron) return;

  const togglePopup = (e) => {
    if (e) e.stopPropagation();
    const collapsed = popup.classList.toggle("collapsed");
    chevron.classList.toggle("rotate", !collapsed);
    
    if (!collapsed) {
      // Close other popups when opening this one
      const allPopups = document.querySelectorAll('.tag-popup');
      allPopups.forEach(p => {
        if (p.id !== popupId && !p.classList.contains('collapsed')) {
          p.style.maxHeight = '0';
          p.classList.add('collapsed');
          const otherChevron = p.querySelector('.chevron');
          if (otherChevron) otherChevron.classList.remove('rotate');
        }
      });
      
      // Set max height based on content
      const body = popup.querySelector('.tag-popup-body');
      if (body) {
        const height = body.scrollHeight + 48;
        popup.style.maxHeight = `${Math.min(height, 600)}px`;
      }
    } else {
      popup.style.maxHeight = '0';
    }
  };

  chevron.addEventListener("click", togglePopup);
  
  if (header) {
    header.addEventListener("click", togglePopup);
  }
}

// Initialize all popups
makePopupCollapsible("tagPopup", "tagPopupChevron");
makePopupCollapsible("sensorPopup", "sensorPopupChevron");
makePopupCollapsible("groupPopup", "groupPopupChevron");
makePopupCollapsible("groupDetailPopup", "groupDetailChevron");
makePopupCollapsible("realtimePopup", "realtimePopupChevron");

/* ================= SIDEBAR DROPDOWNS ================= */
function toggleMenu(toggleBtn, dropdown, chevron) {
  if (!toggleBtn || !dropdown || !chevron) return;
  
  toggleBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const open = dropdown.style.display === "block";
    dropdown.style.display = open ? "none" : "block";
    chevron.classList.toggle("rotate", !open);
  });
}

toggleMenu(
  document.getElementById("settingsToggle"),
  document.getElementById("settingsDropdown"),
  document.getElementById("settingsChevron")
);

toggleMenu(
  document.getElementById("reportsToggle"),
  document.getElementById("reportsDropdown"),
  document.getElementById("reportsChevron")
);

/* ================= SENSOR POPUP FUNCTIONS ================= */
const sensorPopup = document.getElementById("sensorPopup");
const sensorList = document.getElementById("sensorList");
const sensorInput = document.getElementById("sensor-id");

document.getElementById("openSensorPopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  sensorPopup.style.maxHeight = "600px";
  sensorPopup.classList.remove("collapsed");
  document.getElementById("sensorPopupChevron").classList.add("rotate");
  renderSensors();
};

// Sensor storage
const SENSOR_STORAGE_KEY = "saved_sensors";

const getSavedSensors = () => JSON.parse(localStorage.getItem(SENSOR_STORAGE_KEY)) || [];
const saveSensor = (id) => {
  const sensors = getSavedSensors();
  if (!sensors.includes(id)) {
    sensors.push(id);
    localStorage.setItem(SENSOR_STORAGE_KEY, JSON.stringify(sensors));
  }
};

function renderSensors() {
  sensorList.innerHTML = "";
  getSavedSensors().forEach(id => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = id;
    div.onclick = () => handleFetchSensor(id);
    sensorList.appendChild(div);
  });
}


// In the sensor fetching logic (e.g., handleFetchSensor), ensure fetchSensorData is called safely
function handleFetchSensor(sensorId) {
  if (!sensorId) return;
  sensorInput.value = sensorId;
  saveSensor(sensorId);
  renderSensors();
  if (typeof window.fetchSensorData === 'function') {
    window.fetchSensorData(sensorId);
  } else {
    console.error('fetchSensorData function not available');
  }
}

document.getElementById("fetch-sensor-btn").onclick = () => handleFetchSensor(sensorInput.value.trim());
document.getElementById("addSensorBtn").onclick = () => {
  const val = document.getElementById("newSensor").value.trim();
  if (!val) return;
  saveSensor(val);
  renderSensors();
  document.getElementById("newSensor").value = "";
};

/* ================= SENSOR TABLE PANEL ================= */
const sensorTablePanel = document.getElementById('sensorTablePanel');
const sensorTablePanelHeader = document.getElementById('sensorTablePanelHeader');
const sensorTablePanelChevron = document.getElementById('sensorTablePanelChevron');
const sensorTableContainer = document.getElementById('sensorTableContainer');
const sensorDataTable = document.getElementById('sensorDataTable');

// Toggle panel visibility
sensorTablePanelHeader.addEventListener('click', (e) => {
  e.stopPropagation();
  const isMinimized = sensorTablePanel.classList.toggle('minimized');
  sensorTablePanelChevron.classList.toggle('rotated', isMinimized);
  
  if (isMinimized) {
    sensorTableContainer.style.display = 'none';
  } else {
    sensorTableContainer.style.display = 'block';
  }
});

// Store sensor table data - Array to handle multiple entries for same sensor
window.sensorTableData = {};

// Function to update sensor data table
// Function to update sensor data table
window.updateSensorTable = function(sensorId, sensorReadings) {
  if (sensorId && sensorReadings) {
    // Ensure sensorReadings is an array
    if (!Array.isArray(sensorReadings)) {
      sensorReadings = [sensorReadings];
    }
    
    // Store all readings for this sensor
    if (!window.sensorTableData[sensorId]) {
      window.sensorTableData[sensorId] = [];
    }
    
    // Add new readings to the beginning (most recent first)
    sensorReadings.forEach(reading => {
      // Add timestamp if not present
      if (!reading.timestamp && !reading.Timestamp) {
        reading.timestamp = new Date().toISOString();
      }
      
      // Add sensor ID if not present
      if (!reading.sensorId && !reading.SensorId) {
        reading.sensorId = sensorId;
      }
      
      // Check if this reading already exists (by timestamp or other unique field)
      const exists = window.sensorTableData[sensorId].some(existing => 
        (existing.timestamp && existing.timestamp === reading.timestamp) ||
        (existing.Timestamp && existing.Timestamp === reading.Timestamp)
      );
      
      if (!exists) {
        window.sensorTableData[sensorId].unshift(reading); // Add to beginning
      }
    });
    
    // Keep only last 50 entries per sensor to prevent memory issues
    if (window.sensorTableData[sensorId].length > 50) {
      window.sensorTableData[sensorId] = window.sensorTableData[sensorId].slice(0, 50);
    }
  }
  
  const tbody = document.getElementById('sensorDataTableBody');
  const thead = document.getElementById('sensorDataTableHeader');
  
  // Collect all sensor data from all sensors
  const allSensorData = [];
  Object.keys(window.sensorTableData).forEach(sid => {
    window.sensorTableData[sid].forEach(reading => {
      allSensorData.push(reading);
    });
  });
  
  if (allSensorData.length === 0) {
    tbody.innerHTML = `
      <tr class="no-data-row">
        <td colspan="12">No sensor data available. Fetch a sensor first.</td>
      </tr>
    `;
    return;
  }
  
  // Clear and rebuild table
  tbody.innerHTML = '';
  
  // Show all readings (most recent first), matching header order exactly
  allSensorData.forEach((sensorData) => {
    const row = document.createElement('tr');
    
    // Sensor ID (matches header column 1)
    const idCell = document.createElement('td');
    idCell.className = 'sensor-id-cell';
    idCell.textContent = sensorData.sensorId || sensorData.SensorId || sensorId || 'N/A';
    row.appendChild(idCell);
    
    // Timestamp (matches header column 2)
    const timeCell = document.createElement('td');
    const timestamp = sensorData.timestamp || sensorData.Timestamp;
    if (timestamp) {
      try {
        timeCell.textContent = new Date(timestamp).toLocaleString();
      } catch (e) {
        timeCell.textContent = timestamp;
      }
    } else {
      timeCell.textContent = '-';
    }
    row.appendChild(timeCell);
    
    // Latitude (matches header column 3)
    const latCell = document.createElement('td');
    latCell.textContent = sensorData.Latitude !== undefined ? sensorData.Latitude : '-';
    row.appendChild(latCell);
    
    // Longitude (matches header column 4)
    const lonCell = document.createElement('td');
    lonCell.textContent = sensorData.Longitude !== undefined ? sensorData.Longitude : '-';
    row.appendChild(lonCell);
    
    // Moisture (matches header column 5)
    const moistureCell = document.createElement('td');
    moistureCell.textContent = sensorData.Moisture !== undefined ? sensorData.Moisture : '-';
    row.appendChild(moistureCell);
    
    // Temperature (matches header column 6)
    const tempCell = document.createElement('td');
    tempCell.textContent = sensorData.Temperature !== undefined ? sensorData.Temperature : '-';
    row.appendChild(tempCell);
    
    // EC (matches header column 7)
    const ecCell = document.createElement('td');
    ecCell.textContent = sensorData.EC !== undefined ? sensorData.EC : '-';
    row.appendChild(ecCell);
    
    // pH Value (matches header column 8)
    const phCell = document.createElement('td');
    phCell.textContent = sensorData.PHValue !== undefined ? sensorData.PHValue : '-';
    row.appendChild(phCell);
    
    // Nitrogen (matches header column 9)
    const nitrogenCell = document.createElement('td');
    nitrogenCell.textContent = sensorData.Nitrogen !== undefined ? sensorData.Nitrogen : '-';
    row.appendChild(nitrogenCell);
    
    // Phosphorous (matches header column 10)
    const phosphorousCell = document.createElement('td');
    phosphorousCell.textContent = sensorData.Phosphorous !== undefined ? sensorData.Phosphorous : '-';
    row.appendChild(phosphorousCell);
    
    // Potassium (matches header column 11)
    const potassiumCell = document.createElement('td');
    potassiumCell.textContent = sensorData.Potassium !== undefined ? sensorData.Potassium : '-';
    row.appendChild(potassiumCell);
    
    // Satellite Fix (matches header column 12)
    const satCell = document.createElement('td');
    satCell.textContent = sensorData.SatelliteFix !== undefined ? sensorData.SatelliteFix : '-';
    row.appendChild(satCell);
    
    tbody.appendChild(row);
  });
  
  // Show sensor panel if minimized (to make data visible)
  const sensorPanel = document.getElementById('sensorTablePanel');
  if (sensorPanel && sensorPanel.classList.contains('minimized')) {
    sensorPanel.classList.remove('minimized');
    const chevron = document.getElementById('sensorTablePanelChevron');
    if (chevron) chevron.classList.remove('rotated');
    const container = document.getElementById('sensorTableContainer');
    if (container) container.style.display = 'block';
  }
};

/* ================= REALTIME TABLE PANEL ================= */
const realtimeTablePanel = document.getElementById('realtimeTablePanel');
const realtimeTablePanelHeader = document.getElementById('realtimeTablePanelHeader');
const realtimeTablePanelChevron = document.getElementById('realtimeTablePanelChevron');
const realtimeTableContainer = document.getElementById('realtimeTableContainer');
const realtimeDataTable = document.getElementById('realtimeDataTable');

// Toggle panel visibility
realtimeTablePanelHeader.addEventListener('click', (e) => {
  e.stopPropagation();
  const isMinimized = realtimeTablePanel.classList.toggle('minimized');
  realtimeTablePanelChevron.classList.toggle('rotated', isMinimized);
  
  if (isMinimized) {
    realtimeTableContainer.style.display = 'none';
  } else {
    realtimeTableContainer.style.display = 'block';
  }
});

// Store real-time table data
window.realtimeTableData = {};
window.realtimeTableHeaders = ['Tracker ID'];

// Function to update the real-time data table
window.updateRealtimeTable = function(trackerId, data) {
  if (trackerId && data) {
    window.realtimeTableData[trackerId] = data;
  }
  
  // Get all selected parameters
  const allSelectedParams = new Set(['Tracker ID']);
  Object.keys(window.realtimeTableData).forEach(tid => {
    const params = window.getRealtimeParameters ? window.getRealtimeParameters(tid) : null;
    if (params) {
      Object.keys(params).forEach(param => {
        if (params[param]) allSelectedParams.add(param);
      });
    }
  });
  
  window.realtimeTableHeaders = Array.from(allSelectedParams);
  
  // Update table headers
  const thead = realtimeDataTable.querySelector('thead');
  const headerRow = thead.querySelector('tr');
  headerRow.innerHTML = '';
  
  window.realtimeTableHeaders.forEach(header => {
    const th = document.createElement('th');
    th.textContent = formatHeaderText(header);
    headerRow.appendChild(th);
  });
  
  // Update table body
  const tbody = realtimeDataTable.querySelector('tbody');
  tbody.innerHTML = '';
  
  if (Object.keys(window.realtimeTableData).length === 0) {
    const noDataRow = document.createElement('tr');
    noDataRow.className = 'no-data-row';
    const td = document.createElement('td');
    td.colSpan = window.realtimeTableHeaders.length;
    td.textContent = 'No tracker data available. Fetch a tracker first.';
    noDataRow.appendChild(td);
    tbody.appendChild(noDataRow);
    return;
  }
  
  Object.keys(window.realtimeTableData).forEach(tid => {
    const row = document.createElement('tr');
    
    window.realtimeTableHeaders.forEach(header => {
      const td = document.createElement('td');
      
      if (header === 'Tracker ID') {
        td.className = 'tracker-id-cell';
        td.textContent = tid;
      } else {
        const params = window.getRealtimeParameters ? window.getRealtimeParameters(tid) : null;
        if (params && params[header] && window.realtimeTableData[tid][header]) {
          td.textContent = formatCellValue(header, window.realtimeTableData[tid][header]);
        } else {
          td.textContent = '-';
          td.style.color = '#9ca3af';
        }
      }
      
      row.appendChild(td);
    });
    
    tbody.appendChild(row);
  });
};

function formatHeaderText(header) {
  const formatMap = {
    'timestamp': 'Timestamp',
    'latitude': 'Latitude',
    'longitude': 'Longitude',
    'altitude': 'Altitude',
    'uin_no': 'UIN No',
    'application': 'Application',
    'category': 'Category',
    'Tracker ID': 'Tracker ID'
  };
  return formatMap[header] || header;
}

function formatCellValue(header, value) {
  if (header === 'timestamp' && value) {
    try {
      return new Date(value).toLocaleString();
    } catch (e) {
      return value;
    }
  }
  if ((header === 'latitude' || header === 'longitude') && value) {
    return parseFloat(value).toFixed(6);
  }
  if (header === 'altitude' && value) {
    return `${parseFloat(value).toFixed(1)} m`;
  }
  return value || '-';
}

// Initialize table
window.updateRealtimeTable();

/* ================= STORAGE ================= */
const STORAGE_KEY = "saved_trackers";
const GROUP_KEY = "tracker_groups";
const REALTIME_SETTINGS_KEY = "realtime_parameters";
let activeGroup = null;
let selectedTrackerForRealtime = null;

const getSavedTrackers = () => JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
const saveTracker = (id) => {
  const trackers = getSavedTrackers();
  if (!trackers.includes(id)) {
    trackers.push(id);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(trackers));
  }
};

const getGroups = () => JSON.parse(localStorage.getItem(GROUP_KEY)) || {};
const saveGroups = (groups) => localStorage.setItem(GROUP_KEY, JSON.stringify(groups));

/* ================= REALTIME DATA SETTINGS ================= */
const getRealtimeSettings = () => JSON.parse(localStorage.getItem(REALTIME_SETTINGS_KEY)) || {};
const saveRealtimeSettings = (settings) => localStorage.setItem(REALTIME_SETTINGS_KEY, JSON.stringify(settings));

const availableParameters = [
  { id: 'timestamp', label: 'Timestamp', default: true },
  { id: 'latitude', label: 'Latitude', default: true },
  { id: 'longitude', label: 'Longitude', default: true },
  { id: 'altitude', label: 'Altitude', default: true },
  { id: 'uin_no', label: 'UIN No', default: true },
  { id: 'application', label: 'Application', default: true },
  { id: 'category', label: 'Category', default: true }
];

/* ================= TAG POPUP FUNCTIONS ================= */
const tagPopup = document.getElementById("tagPopup");
const trackerList = document.getElementById("trackerList");
const trackerInput = document.getElementById("tracker-id");

document.getElementById("openTagPopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  tagPopup.style.maxHeight = "600px";
  tagPopup.classList.remove("collapsed");
  document.getElementById("tagPopupChevron").classList.add("rotate");
  renderTrackers();
};

function renderTrackers() {
  trackerList.innerHTML = "";
  getSavedTrackers().forEach(id => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = id;
    div.onclick = () => handleFetch(id);
    trackerList.appendChild(div);
  });
}

function handleFetch(id) {
  if (!id) return;
  trackerInput.value = id;
  saveTracker(id);
  renderTrackers();
  if (typeof fetchDroneData === "function") {
    fetchDroneData(id);
  }
}

document.getElementById("fetch-btn").onclick = () => handleFetch(trackerInput.value.trim());
document.getElementById("addTrackerBtn").onclick = () => {
  const val = document.getElementById("newTracker").value.trim();
  if (!val) return;
  saveTracker(val);
  renderTrackers();
  document.getElementById("newTracker").value = "";
};

/* ================= GROUP POPUP FUNCTIONS ================= */
const groupPopup = document.getElementById("groupPopup");
const groupList = document.getElementById("groupList");

document.getElementById("openGroupPopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  groupPopup.style.maxHeight = "600px";
  groupPopup.classList.remove("collapsed");
  document.getElementById("groupPopupChevron").classList.add("rotate");
  renderGroups();
};

function renderGroups() {
  groupList.innerHTML = "";
  const groups = getGroups();
  Object.keys(groups).forEach(groupName => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = groupName;
    div.addEventListener("click", () => {
      openGroupDetail(groupName);
      groupDetailPopup.style.maxHeight = "600px";
      groupDetailPopup.classList.remove("collapsed");
    });
    groupList.appendChild(div);
  });
}

document.getElementById("createGroupBtn").onclick = () => {
  const name = document.getElementById("groupNameInput").value.trim();
  if (!name) return;
  const groups = getGroups();
  if (!groups[name]) groups[name] = [];
  saveGroups(groups);
  document.getElementById("groupNameInput").value = "";
  renderGroups();
};

/* ================= GROUP DETAIL POPUP ================= */
const groupDetailPopup = document.getElementById("groupDetailPopup");
const groupTrackerList = document.getElementById("groupTrackerList");
const groupDetailTitle = document.getElementById("groupDetailTitle");

let groupSettings = JSON.parse(localStorage.getItem('groupSettings')) || {};
const defaultColors = [
  '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', 
  '#EF476F', '#9D4EDD', '#FB5607', '#3A86FF', '#8338EC'
];

function openGroupDetail(groupName) {
  if (window.setActiveGroup) window.setActiveGroup(groupName);
  activeGroup = groupName;
  groupDetailTitle.textContent = groupName;
  const groups = getGroups();
  groupTrackerList.innerHTML = "";
  
  if (!groupSettings[groupName]) groupSettings[groupName] = {};
  
  (groups[groupName] || []).forEach((tid, index) => {
    if (!groupSettings[groupName][tid]) {
      groupSettings[groupName][tid] = {
        visible: true,
        color: defaultColors[index % defaultColors.length]
      };
    }
    
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.dataset.trackerId = tid;
    
    const checkboxContainer = document.createElement("div");
    checkboxContainer.className = "checkbox-container";
    
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "tracker-checkbox";
    checkbox.checked = groupSettings[groupName][tid].visible;
    checkbox.dataset.trackerId = tid;
    
    const colorPicker = document.createElement("input");
    colorPicker.type = "color";
    colorPicker.className = "tracker-color-picker";
    colorPicker.value = groupSettings[groupName][tid].color;
    colorPicker.dataset.trackerId = tid;
    colorPicker.style.display = "none";
    
    const colorPreview = document.createElement("div");
    colorPreview.className = "color-preview";
    colorPreview.style.backgroundColor = groupSettings[groupName][tid].color;
    
    const trackerIdSpan = document.createElement("span");
    trackerIdSpan.className = "tracker-id-text";
    trackerIdSpan.textContent = tid;
    trackerIdSpan.dataset.trackerId = tid;
    
    trackerIdSpan.onclick = () => {
      if (window.handleFetch) window.handleFetch(tid);
    };
    
    checkbox.onchange = (e) => {
      const trackerId = e.target.dataset.trackerId;
      const isVisible = e.target.checked;
      groupSettings[groupName][trackerId].visible = isVisible;
      saveGroupSettings();
      if (window.updateTrackerVisibilityFromGroup) {
        window.updateTrackerVisibilityFromGroup(trackerId, isVisible);
      }
    };
    
    colorPicker.onchange = (e) => {
      const trackerId = e.target.dataset.trackerId;
      const newColor = e.target.value;
      groupSettings[groupName][trackerId].color = newColor;
      saveGroupSettings();
      colorPreview.style.backgroundColor = newColor;
      if (window.updateTrackerColorFromGroup) {
        window.updateTrackerColorFromGroup(trackerId, newColor);
      }
    };
    
    colorPreview.onclick = () => colorPicker.click();
    
    checkboxContainer.appendChild(checkbox);
    checkboxContainer.appendChild(colorPreview);
    div.appendChild(checkboxContainer);
    div.appendChild(colorPicker);
    div.appendChild(trackerIdSpan);
    groupTrackerList.appendChild(div);
  });
  
  saveGroupSettings();
}

function saveGroupSettings() {
  localStorage.setItem('groupSettings', JSON.stringify(groupSettings));
}

// Add tracker to group (from group popup)
document.getElementById("addTrackerToGroupBtn").onclick = () => {
  if (!activeGroup) {
    alert("Select a group first");
    return;
  }
  const tracker = document.getElementById("groupTrackerInput").value.trim();
  if (!tracker) return;
  const groups = getGroups();
  if (!groups[activeGroup].includes(tracker)) {
    groups[activeGroup].push(tracker);
    saveGroups(groups);
  }
  document.getElementById("groupTrackerInput").value = "";
  renderGroups();
};

// Add tracker to group (from group detail popup)
document.getElementById("addTrackerToGroupDetailBtn").onclick = () => {
  if (!activeGroup) return;
  const tracker = document.getElementById("groupDetailTrackerInput").value.trim();
  if (!tracker) return;
  const groups = getGroups();
  if (!groups[activeGroup].includes(tracker)) {
    groups[activeGroup].push(tracker);
    saveGroups(groups);
    if (!groupSettings[activeGroup]) groupSettings[activeGroup] = {};
    const index = groups[activeGroup].length - 1;
    groupSettings[activeGroup][tracker] = {
      visible: true,
      color: defaultColors[index % defaultColors.length]
    };
    saveGroupSettings();
  }
  document.getElementById("groupDetailTrackerInput").value = "";
  openGroupDetail(activeGroup);
};

// Fetch group button
document.getElementById("fetchGroupBtn").onclick = () => {
  if (!activeGroup) {
    alert("Select a group first");
    return;
  }
  const groups = getGroups();
  const trackerIds = groups[activeGroup] || [];
  if (trackerIds.length === 0) {
    alert("No trackers in this group");
    return;
  }
  if (window.fetchGroupTrackers) window.fetchGroupTrackers(trackerIds);
};


//sensor button listner
fetchBtn?.addEventListener('click', () => {
  const sensorId = sensorInput?.value?.trim();
  if (sensorId && window.fetchSensorData) {
    window.fetchSensorData(sensorId);
  }
});


/* ================= REALTIME DATA POPUP ================= */
const realtimePopup = document.getElementById("realtimePopup");
const realtimeGroupList = document.getElementById("realtimeGroupList");

document.getElementById("openRealtimePopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  realtimePopup.style.maxHeight = "600px";
  realtimePopup.classList.remove("collapsed");
  document.getElementById("realtimePopupChevron").classList.add("rotate");
  renderRealtimeGroups();
};

function renderRealtimeGroups() {
  realtimeGroupList.innerHTML = "";
  const groups = getGroups();
  
  if (Object.keys(groups).length === 0) {
    realtimeGroupList.innerHTML = `
      <div style="padding: 20px; text-align: center; color: #6b7280;">
        No groups found. Create groups first.
      </div>
    `;
    return;
  }
  
  Object.keys(groups).forEach(groupName => {
    const groupDiv = document.createElement("div");
    groupDiv.className = "realtime-group-header";
    groupDiv.innerHTML = `
      <i data-lucide="folder" style="width: 16px; height: 16px; margin-right: 8px; color: #6366f1;"></i>
      <span class="realtime-group-name">${groupName}</span>
      <i data-lucide="chevron-right" class="group-expand-btn" style="width: 16px; height: 16px;"></i>
    `;
    
    const trackerList = document.createElement("div");
    trackerList.className = "realtime-tracker-list";
    trackerList.style.display = "none";
    
    groups[groupName].forEach(trackerId => {
      const trackerDiv = document.createElement("div");
      trackerDiv.className = "realtime-tracker-item";
      trackerDiv.dataset.trackerId = trackerId;
      trackerDiv.dataset.groupName = groupName;
      trackerDiv.innerHTML = `
        <i data-lucide="tag" style="width: 14px; height: 14px; margin-right: 8px; color: #6b7280;"></i>
        <span class="realtime-tracker-id">${trackerId}</span>
      `;
      trackerDiv.onclick = (e) => {
        e.stopPropagation();
        showTrackerParameters(trackerId);
      };
      trackerList.appendChild(trackerDiv);
    });
    
    const chevron = groupDiv.querySelector(".group-expand-btn");
    groupDiv.onclick = () => {
      const isExpanded = trackerList.style.display === "block";
      trackerList.style.display = isExpanded ? "none" : "block";
      chevron.classList.toggle("rotated", !isExpanded);
      lucide.createIcons();
    };
    
    realtimeGroupList.appendChild(groupDiv);
    realtimeGroupList.appendChild(trackerList);
  });
  
  lucide.createIcons();
}

function showTrackerParameters(trackerId) {
  selectedTrackerForRealtime = trackerId;
  document.getElementById("selectedTrackerId").textContent = trackerId;
  document.getElementById("trackerParametersSection").style.display = "block";
  
  const parametersContainer = document.getElementById("parametersCheckboxes");
  parametersContainer.innerHTML = "";
  
  const settings = getRealtimeSettings();
  const trackerSettings = settings[trackerId] || {};
  
  availableParameters.forEach(param => {
    const div = document.createElement("div");
    div.className = "parameter-option";
    const checkboxId = `param_${trackerId}_${param.id}`;
    const isChecked = trackerSettings[param.id] !== undefined ? 
                      trackerSettings[param.id] : param.default;
    div.innerHTML = `
      <input type="checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}>
      <label for="${checkboxId}">${param.label}</label>
    `;
    const checkbox = div.querySelector('input');
    checkbox.onchange = () => {};
    parametersContainer.appendChild(div);
  });
}

document.getElementById("saveParametersBtn").onclick = () => {
  if (!selectedTrackerForRealtime) {
    alert("Please select a tracker first");
    return;
  }
  const settings = getRealtimeSettings();
  settings[selectedTrackerForRealtime] = settings[selectedTrackerForRealtime] || {};
  availableParameters.forEach(param => {
    const checkboxId = `param_${selectedTrackerForRealtime}_${param.id}`;
    const checkbox = document.getElementById(checkboxId);
    if (checkbox) settings[selectedTrackerForRealtime][param.id] = checkbox.checked;
  });
  saveRealtimeSettings(settings);
  const btn = document.getElementById("saveParametersBtn");
  const originalText = btn.textContent;
  btn.textContent = "Saved!";
  btn.style.background = "#10b981";
  setTimeout(() => {
    btn.textContent = originalText;
    btn.style.background = "#6366f1";
  }, 1500);
  if (window.realtimeTableData && window.realtimeTableData[selectedTrackerForRealtime]) {
    window.updateRealtimeTable();
  }
};

window.getRealtimeParameters = function(trackerId) {
  const settings = getRealtimeSettings();
  const trackerSettings = settings[trackerId];
  if (!trackerSettings) {
    return availableParameters.reduce((acc, param) => {
      acc[param.id] = param.default;
      return acc;
    }, {});
  }
  return trackerSettings;
};

window.formatRealtimeData = function(data, trackerId) {
  const parameters = window.getRealtimeParameters(trackerId);
  const formatted = { 'Tracker ID': trackerId };
  Object.keys(parameters).forEach(param => {
    if (parameters[param] && data[param] !== undefined) {
      formatted[param] = data[param];
    }
  });
  return formatted;
};

// Make realtime group dropdown collapsible
document.getElementById("realtimeGroupHeader").onclick = () => {
  const chevron = document.getElementById("realtimeGroupChevron");
  const dropdown = document.getElementById("realtimeGroupList");
  const isCollapsed = dropdown.style.display === "none";
  dropdown.style.display = isCollapsed ? "block" : "none";
  chevron.classList.toggle("rotate", isCollapsed);
};

/* ================= WINDOW RESIZE HANDLER ================= */
function handleResize() {
  const isMobile = window.innerWidth <= 768;
  if (!isMobile) {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
  }
}

window.addEventListener('resize', handleResize);
handleResize();

/* ================= INITIALIZATION ================= */
renderTrackers();
renderSensors();
renderGroups();

// Close popups when clicking Escape key or outside
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeAllPopups();
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
  }
});

// Close popups when clicking outside
document.addEventListener('click', (e) => {
  const popups = document.querySelectorAll('.tag-popup');
  const isClickInsidePopup = Array.from(popups).some(popup => popup.contains(e.target));
  const isClickInsideSidebar = sidebar.contains(e.target);
  const isClickOnMobileToggle = mobileMenuToggle.contains(e.target);
  
  if (!isClickInsidePopup && !isClickInsideSidebar && !isClickOnMobileToggle) {
    closeAllPopups();
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Alt+S for sensor panel
  if (e.altKey && e.key === 's') {
    e.preventDefault();
    const sensorPanel = document.getElementById('sensorTablePanel');
    const sensorHeader = document.getElementById('sensorTablePanelHeader');
    if (sensorPanel && sensorHeader) {
      sensorHeader.click();
    }
  }
  
  // Alt+T for tracker panel
  if (e.altKey && e.key === 't') {
    e.preventDefault();
    const trackerPanel = document.getElementById('realtimeTablePanel');
    const trackerHeader = document.getElementById('realtimeTablePanelHeader');
    if (trackerPanel && trackerHeader) {
      trackerHeader.click();
    }
  }
});
</script>

</body>
</html>  #}
























{# <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drone Tracker Dashboard</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* ================= BASE STYLES ================= */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      background: #f9fafb;
    }

    /* ================= HEADER ================= */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 3000;
    }

    .logo-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      height: 40px;
      width: 40px;
    }

    .site-name {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
    }

    /* ================= SIDEBAR ================= */
    .sidebar {
      position: fixed;
      top: 70px;
      left: 0;
      bottom: 0;
      width: 160px;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      z-index: 2000;
      overflow-y: auto;
      transition: transform 0.3s ease;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        width: 200px;
      }
      .sidebar.open {
        transform: translateX(0);
      }
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      flex-shrink: 0;
      display: none;
    }

    .sidebar-nav {
      padding: 12px 8px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .sidebar-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 14px 10px;
      margin-bottom: 8px;
      cursor: pointer;
      border-radius: 10px;
      transition: background 0.2s ease;
    }

    .sidebar-item:hover {
      background: #f3f4f6;
    }

    .item-top {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .sidebar-icon {
      width: 40px;
      height: 40px;
      color: #6366f1;
    }

    .sidebar-item span {
      font-size: 13px;
      color: #374151;
    }

    .chevron {
      margin-top: 6px;
      transition: transform 0.2s ease;
      color: #6b7280;
    }

    .chevron.rotate {
      transform: rotate(180deg);
    }

    .sidebar-dropdown {
      display: none;
      margin-left: 12px;
      margin-bottom: 10px;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 500;
      color: #4b5563;
      cursor: pointer;
      border-radius: 8px;
    }

    .dropdown-item:hover {
      background: #eef2ff;
    }

    /* ================= MAIN CONTENT ================= */
    main {
      position: fixed;
      top: 70px;
      left: 160px;
      right: 0;
      bottom: 0;
      padding: 15px;
      overflow-y: auto;
      z-index: 1;
      transition: left 0.3s ease;
    }

    @media (max-width: 768px) {
      main {
        left: 0;
      }
    }

    #status-message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }

    .last-updated {
      margin-bottom: 15px;
      font-size: 13px;
      color: #6b7280;
    }

    /* ================= MAP CONTAINER ================= */
    .map-container {
      position: relative;
      height: calc(100vh - 210px);
      min-height: 400px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    #map {
      height: 100%;
      width: 100%;
    }

    /* ================= POPUPS ================= */
    .tag-popup {
      position: fixed;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      z-index: 2500;
      overflow: hidden;
      transition: all 0.3s ease;
      max-height: 0;
      border-left: 4px solid #6366f1;
    }

    @media (max-width: 1024px) {
      .tag-popup {
        left: 50% !important;
        transform: translateX(-50%);
        width: 90% !important;
        max-width: 400px;
      }
    }

    .tag-popup.collapsed {
      max-height = '0' !important;
    }

    .tag-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 16px;
      background: #f3f4f6;
      border-bottom: 1px solid #e5e7eb;
    }

    .tag-popup-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      flex: 1;
    }

    .tag-popup-body {
      padding: 16px;
      display: block;
    }

    .tag-popup.collapsed .tag-popup-body {
      display: none;
    }

    .tag-popup.collapsed .tag-popup-header {
      border-bottom: none;
    }

    .tracker-dropdown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 8px 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 6px;
    }

    .tracker-dropdown.collapsible {
      display: block;
      max-height: 160px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .tracker-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      cursor: pointer;
    }

    .tracker-option:hover {
      background: #eef2ff;
    }

    .tracker-option input[type="checkbox"] {
      transform: scale(1.1);
      cursor: pointer;
    }

    .tracker-option input[type="color"] {
      width: 28px;
      height: 28px;
      border: none;
      padding: 0;
      cursor: pointer;
      border-radius: 4px;
    }

    .tracker-option span {
      flex: 1;
      cursor: pointer;
    }

    .add-tracker {
      padding: 8px;
      display: flex;
      gap: 6px;
      border-top: 1px solid #e5e7eb;
    }

    .tag-input-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .tag-input-row input {
      flex: 1;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
    }

    .tag-input-row button {
      padding: 8px 12px;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .tag-input-row button:hover {
      background: #4f46e5;
    }

    /* Popup positioning */
    #tagPopup {
      left: 170px;
      top: 90px;
      width: 320px;
    }

    #sensorPopup {
      left: 170px;
      top: 140px;
      width: 320px;
    }

    #groupPopup {
      left: 170px;
      top: 190px;
      width: 320px;
    }

    #groupDetailPopup {
      left: 510px;
      top: 90px;
      width: 320px;
    }

    #realtimePopup {
      left: 170px;
      top: 240px;
      width: 320px;
    }

    /* ================= SENSOR DATA TABLE PANEL ================= */
    #sensorTablePanel {
      position: fixed;
      bottom: 80px;
      left: 175px;
      right: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1500;
      transition: all 0.3s ease;
      max-height: 250px;
      overflow: hidden;
    }

    @media (max-width: 768px) {
      #sensorTablePanel {
        left: 15px;
        bottom: 220px;
      }
    }

    #sensorTablePanel.minimized {
      max-height: 44px;
    }

    #sensorTablePanelHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
    }

    #sensorTablePanelHeader h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    #sensorTablePanelChevron {
      transition: transform 0.3s ease;
    }

    #sensorTablePanelChevron.rotated {
      transform: rotate(180deg);
    }

    #sensorTableContainer {
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    #sensorDataTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    #sensorDataTable th {
      background: #f9fafb;
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 0;
      white-space: nowrap;
    }

    #sensorDataTable td {
      padding: 10px 12px;
      border-bottom: 1px solid #f3f4f6;
      color: #4b5563;
      white-space: nowrap;
    }

    #sensorDataTable tr:hover {
      background: #f9fafb;
    }

    .sensor-id-cell {
      font-weight: 600;
      color: #10b981;
    }

    /* ================= REALTIME DATA TABLE PANEL ================= */
    #realtimeTablePanel {
      position: fixed;
      bottom: 15px;
      left: 175px;
      right: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1500;
      transition: all 0.3s ease;
      max-height: 250px;
      overflow: hidden;
    }

    @media (max-width: 768px) {
      #realtimeTablePanel {
        left: 15px;
      }
    }

    #realtimeTablePanel.minimized {
      max-height: 44px;
    }

    #realtimeTablePanelHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
    }

    #realtimeTablePanelHeader h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    #realtimeTablePanelChevron {
      transition: transform 0.3s ease;
    }

    #realtimeTablePanelChevron.rotated {
      transform: rotate(180deg);
    }

    #realtimeTableContainer {
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    #realtimeDataTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    #realtimeDataTable th {
      background: #f9fafb;
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 0;
      white-space: nowrap;
    }

    #realtimeDataTable td {
      padding: 10px 12px;
      border-bottom: 1px solid #f3f4f6;
      color: #4b5563;
      white-space: nowrap;
    }

    #realtimeDataTable tr:hover {
      background: #f9fafb;
    }

    .tracker-id-cell {
      font-weight: 600;
      color: #6366f1;
    }

    .no-data-row td {
      text-align: center;
      padding: 30px;
      color: #9ca3af;
      font-style: italic;
    }

    /* ================= IMAGE GRID ================= */
    #images-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding-bottom: 20px;
    }

    .image-container {
      width: calc(25% - 10px);
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }

    @media (max-width: 1200px) {
      .image-container {
        width: calc(33.333% - 10px);
      }
    }

    @media (max-width: 768px) {
      .image-container {
        width: calc(50% - 10px);
      }
    }

    .image-container img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }

    /* ================= REALTIME DATA STYLES ================= */
    .parameter-option {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      cursor: pointer;
    }

    .parameter-option:hover {
      background: #f9fafb;
    }

    .parameter-option input[type="checkbox"] {
      margin-right: 10px;
      cursor: pointer;
      transform: scale(1.1);
    }

    .parameter-option label {
      cursor: pointer;
      flex: 1;
      user-select: none;
    }

    .realtime-tracker-item {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .realtime-tracker-item:hover {
      background: #eef2ff;
    }

    .realtime-tracker-id {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }

    .group-expand-btn {
      margin-left: 8px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .group-expand-btn.rotated {
      transform: rotate(90deg);
    }

    .realtime-group-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      background: #f9fafb;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 5px;
    }

    .realtime-group-header:hover {
      background: #f3f4f6;
    }

    .realtime-group-name {
      flex: 1;
      font-weight: 600;
      color: #374151;
    }

    .realtime-tracker-list {
      margin-left: 15px;
      border-left: 2px solid #e5e7eb;
      padding-left: 10px;
    }

    /* ================= GROUP CONTROLS ================= */
    .group-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .group-control-btn {
      padding: 6px 12px;
      background: rgba(99, 102, 241, 0.8);
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }

    .group-control-btn:hover {
      background: rgba(79, 70, 229, 1);
    }

    /* ================= SCROLLBAR STYLING ================= */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    /* ================= MOBILE MENU TOGGLE ================= */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 4000;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .mobile-menu-toggle {
        display: block;
      }
    }

    /* ================= OVERLAY ================= */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
    }

    .overlay.active {
      display: block;
    }

    /* ================= STATUS MESSAGES ================= */
    .status-loading {
      background: #fef3c7;
      color: #92400e;
    }

    .status-success {
      background: #d1fae5;
      color: #065f46;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* ================= CHECKBOX CONTAINER ================= */
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-preview {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      cursor: pointer;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    /* ================= SENSOR POPUP STYLES ================= */
    .sensor-input-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .sensor-input-row input {
      flex: 1;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
    }

    .sensor-input-row button {
      padding: 8px 12px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .sensor-input-row button:hover {
      background: #059669;
    }
  </style>
</head>

<body>

<button class="mobile-menu-toggle" id="mobileMenuToggle">
  <i data-lucide="menu"></i>
</button>

<header>
  <div class="logo-title">
    <img src="{{ url_for('static', filename='images/logo.svg') }}" class="logo">
    <span class="site-name">DRONE TAG</span>
  </div>
</header>

<div class="overlay" id="overlay"></div>

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar" id="sidebar">
  <nav class="sidebar-nav">
    <div class="sidebar-item" onclick="scrollToTop()">
      <i data-lucide="layout-dashboard" class="sidebar-icon"></i>
      <span>Dashboard</span>
    </div>

    <div class="sidebar-item" id="settingsToggle">
      <div class="item-top">
        <i data-lucide="settings" class="sidebar-icon"></i>
        <span>Settings</span>
      </div>
      <i data-lucide="chevron-down" class="chevron" id="settingsChevron"></i>
    </div>

    <div class="sidebar-dropdown" id="settingsDropdown">
      <div class="dropdown-item" id="openTagPopup">
        <i data-lucide="tag"></i><span>Tag</span>
      </div>
      <div class="dropdown-item" id="openSensorPopup">
        <i data-lucide="cpu"></i><span>Sensor</span>
      </div>
      <div class="dropdown-item" id="openRealtimePopup">
        <i data-lucide="activity"></i><span>Real-time Data</span>
      </div>
    </div>

    <div class="sidebar-item" id="reportsToggle">
      <div class="item-top">
        <i data-lucide="file-text" class="sidebar-icon"></i><span>Reports</span>
      </div>
      <i data-lucide="chevron-down" class="chevron" id="reportsChevron"></i>
    </div>

    <div class="sidebar-dropdown" id="reportsDropdown">
      <div class="dropdown-item" id="openGroupPopup">
        <i data-lucide="folder"></i><span>Group Name</span>
      </div>
    </div>
  </nav>
</aside>

<!-- ================= TAG POPUP ================= -->
<div class="tag-popup" id="tagPopup">
  <div class="tag-popup-header" id="tagPopupHeader">
    <h4>Tracker Popup</h4>
    <i data-lucide="chevron-down" class="chevron" id="tagPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="tagPopupBody">
    <div class="tracker-dropdown-header" id="trackerDropdownHeader">
      <span>Available Trackers</span>
      <i data-lucide="chevron-down" class="chevron" id="trackerChevron"></i>
    </div>
    <div class="tracker-dropdown collapsible" id="trackerList"></div>

    <div class="add-tracker">
      <input type="text" id="newTracker" placeholder="Add tracker ID">
      <button id="addTrackerBtn">+</button>
    </div>

    <div class="tag-input-row">
      <input type="text" id="tracker-id" placeholder="Manual Tracker ID">
      <button id="fetch-btn">Fetch</button>
    </div>
  </div>
</div>

<!-- ================= SENSOR POPUP ================= -->
<div class="tag-popup" id="sensorPopup">
  <div class="tag-popup-header" id="sensorPopupHeader">
    <h4>Sensor Data</h4>
    <i data-lucide="chevron-down" class="chevron" id="sensorPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="sensorPopupBody">
    <div class="tracker-dropdown-header" id="sensorDropdownHeader">
      <span>Available Sensors</span>
      <i data-lucide="chevron-down" class="chevron" id="sensorChevron"></i>
    </div>
    <div class="tracker-dropdown collapsible" id="sensorList"></div>

    <div class="add-tracker">
      <input type="text" id="newSensor" placeholder="Add sensor ID">
      <button id="addSensorBtn">+</button>
    </div>

    <div class="sensor-input-row">
      <input type="text" id="sensor-id" placeholder="Manual Sensor ID">
      <button id="fetch-sensor-btn">Fetch Sensor</button>
    </div>
  </div>
</div>

<!-- ================= GROUP POPUP ================= -->
<div class="tag-popup" id="groupPopup">
  <div class="tag-popup-header" id="groupPopupHeader">
    <h4>Tracker Groups</h4>
    <i data-lucide="chevron-down" class="chevron" id="groupPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="groupPopupBody">
    <div class="tag-input-row">
      <input type="text" id="groupNameInput" placeholder="Group Name">
      <button id="createGroupBtn">Add Group</button>
    </div>

    <div id="groupList" class="tracker-dropdown collapsible" style="margin-top:10px;"></div>

    <div class="tag-input-row">
      <input type="text" id="groupTrackerInput" placeholder="Tracker ID">
      <button id="addTrackerToGroupBtn">Add</button>
    </div>

    <div class="tag-input-row">
      <button id="fetchGroupBtn" style="width:100%">Fetch Group</button>
    </div>
  </div>
</div>

<!-- ================= GROUP DETAIL POPUP ================= -->
<div class="tag-popup" id="groupDetailPopup">
  <div class="tag-popup-header" id="groupDetailHeader">
    <h4 id="groupDetailTitle">Group</h4>
    <i data-lucide="chevron-down" class="chevron" id="groupDetailChevron"></i>
  </div>

  <div class="tag-popup-body" id="groupDetailBody">
    <div id="groupTrackerList" class="tracker-dropdown collapsible"></div>

    <div class="tag-input-row" style="margin-top:10px;">
      <input type="text" id="groupDetailTrackerInput" placeholder="Add Tracker ID" />
      <button id="addTrackerToGroupDetailBtn">Add</button>
    </div>
  </div>
</div>

<!-- ================= REALTIME DATA POPUP ================= -->
<div class="tag-popup" id="realtimePopup">
  <div class="tag-popup-header" id="realtimePopupHeader">
    <h4>Real-time Data Parameters</h4>
    <i data-lucide="chevron-down" class="chevron" id="realtimePopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="realtimePopupBody">
    <div class="tracker-dropdown-header" id="realtimeGroupHeader">
      <span>Select Group</span>
      <i data-lucide="chevron-down" class="chevron" id="realtimeGroupChevron"></i>
    </div>
    
    <div class="tracker-dropdown collapsible" id="realtimeGroupList"></div>

    <div id="trackerParametersSection" style="display: none;">
      <div style="margin: 15px 0 10px 0; font-weight: 600; color: #374151;">
        Selected Tracker: <span id="selectedTrackerId">-</span>
      </div>
      
      <div id="parametersCheckboxes" class="tracker-dropdown collapsible" style="max-height: 200px;"></div>
      
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
        <button id="saveParametersBtn" style="width: 100%; padding: 8px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
          Save Parameters
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ================= MAIN CONTENT ================= -->
<main>
  <div id="status-message"></div>
  <div class="last-updated"></div>
  
  <div class="map-container">
    <div id="map"></div>
  </div>
  
 <!-- ================= SENSOR DATA TABLE PANEL ================= -->
<div id="sensorTablePanel" class="minimized">
  <div id="sensorTablePanelHeader">
    <h3>Sensor Data Table</h3>
    <i data-lucide="chevron-up" id="sensorTablePanelChevron" class="rotated"></i>
  </div>
  <div id="sensorTableContainer" style="display: none;">
    <table id="sensorDataTable">
     <thead id="sensorDataTableHeader">
        <tr>
          <th>Sensor ID</th>
          <th>Timestamp</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Moisture</th>
          <th>Temperature</th>
          <th>EC</th>
          <th>pH Value</th>
          <th>Nitrogen</th>
          <th>Phosphorous</th>
          <th>Potassium</th>
          <th>Satellite Fix</th>
        </tr>
      </thead>

      <tbody id="sensorDataTableBody">
        <tr class="no-data-row">
          <td colspan="12">No sensor data available. Fetch a sensor first.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
  
  <!-- ================= REALTIME DATA TABLE PANEL ================= -->
  <div id="realtimeTablePanel" class="minimized">
    <div id="realtimeTablePanelHeader">
      <h3>Tracker Data Table</h3>
      <i data-lucide="chevron-up" id="realtimeTablePanelChevron" class="rotated"></i>
    </div>
    <div id="realtimeTableContainer" style="display: none;">
      <table id="realtimeDataTable">
        <thead>
          <tr>
            <th>Tracker ID</th>
          </tr>
        </thead>
        <tbody>
          <tr class="no-data-row">
            <td>No tracker data available. Fetch a tracker first.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <div id="images-grid"></div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="{{ url_for('static', filename='js/fetchdata.js') }}"></script>

<script>
lucide.createIcons();

/* ================= MOBILE MENU ================= */
const mobileMenuToggle = document.getElementById('mobileMenuToggle');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');

mobileMenuToggle.addEventListener('click', () => {
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
});

overlay.addEventListener('click', () => {
  sidebar.classList.remove('open');
  overlay.classList.remove('active');
});

/* ================= RESPONSIVE HELPERS ================= */
function scrollToTop() {
  document.querySelector('main').scrollTo({ top: 0, behavior: 'smooth' });
}

function closeAllPopups() {
  const popups = document.querySelectorAll('.tag-popup');
  popups.forEach(popup => {
    popup.style.maxHeight = '0';
    popup.classList.add('collapsed');
    const chevron = popup.querySelector('.chevron');
    if (chevron) chevron.classList.remove('rotate');
  });
}

/* ================= POPUP MANAGEMENT ================= */
function makePopupCollapsible(popupId, chevronId) {
  const popup = document.getElementById(popupId);
  const chevron = document.getElementById(chevronId);
  const header = document.getElementById(popupId + 'Header') || popup.querySelector('.tag-popup-header');

  if (!popup || !chevron) return;

  const togglePopup = (e) => {
    if (e) e.stopPropagation();
    const collapsed = popup.classList.toggle("collapsed");
    chevron.classList.toggle("rotate", !collapsed);
    
    if (!collapsed) {
      // Close other popups when opening this one
      const allPopups = document.querySelectorAll('.tag-popup');
      allPopups.forEach(p => {
        if (p.id !== popupId && !p.classList.contains('collapsed')) {
          p.style.maxHeight = '0';
          p.classList.add('collapsed');
          const otherChevron = p.querySelector('.chevron');
          if (otherChevron) otherChevron.classList.remove('rotate');
        }
      });
      
      // Set max height based on content
      const body = popup.querySelector('.tag-popup-body');
      if (body) {
        const height = body.scrollHeight + 48;
        popup.style.maxHeight = `${Math.min(height, 600)}px`;
      }
    } else {
      popup.style.maxHeight = '0';
    }
  };

  chevron.addEventListener("click", togglePopup);
  
  if (header) {
    header.addEventListener("click", togglePopup);
  }
}

// Initialize all popups
makePopupCollapsible("tagPopup", "tagPopupChevron");
makePopupCollapsible("sensorPopup", "sensorPopupChevron");
makePopupCollapsible("groupPopup", "groupPopupChevron");
makePopupCollapsible("groupDetailPopup", "groupDetailChevron");
makePopupCollapsible("realtimePopup", "realtimePopupChevron");

/* ================= SIDEBAR DROPDOWNS ================= */
function toggleMenu(toggleBtn, dropdown, chevron) {
  if (!toggleBtn || !dropdown || !chevron) return;
  
  toggleBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const open = dropdown.style.display === "block";
    dropdown.style.display = open ? "none" : "block";
    chevron.classList.toggle("rotate", !open);
  });
}

toggleMenu(
  document.getElementById("settingsToggle"),
  document.getElementById("settingsDropdown"),
  document.getElementById("settingsChevron")
);

toggleMenu(
  document.getElementById("reportsToggle"),
  document.getElementById("reportsDropdown"),
  document.getElementById("reportsChevron")
);

/* ================= SENSOR POPUP FUNCTIONS ================= */
const sensorPopup = document.getElementById("sensorPopup");
const sensorList = document.getElementById("sensorList");
const sensorInput = document.getElementById("sensor-id");

document.getElementById("openSensorPopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  sensorPopup.style.maxHeight = "600px";
  sensorPopup.classList.remove("collapsed");
  document.getElementById("sensorPopupChevron").classList.add("rotate");
  renderSensors();
};

// Sensor storage
const SENSOR_STORAGE_KEY = "saved_sensors";

const getSavedSensors = () => JSON.parse(localStorage.getItem(SENSOR_STORAGE_KEY)) || [];
const saveSensor = (id) => {
  const sensors = getSavedSensors();
  if (!sensors.includes(id)) {
    sensors.push(id);
    localStorage.setItem(SENSOR_STORAGE_KEY, JSON.stringify(sensors));
  }
};

function renderSensors() {
  sensorList.innerHTML = "";
  getSavedSensors().forEach(id => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = id;
    div.onclick = () => handleFetchSensor(id);
    sensorList.appendChild(div);
  });
}


// In the sensor fetching logic (e.g., handleFetchSensor), ensure fetchSensorData is called safely
function handleFetchSensor(sensorId) {
  if (!sensorId) return;
  sensorInput.value = sensorId;
  saveSensor(sensorId);
  renderSensors();
  if (typeof window.fetchSensorData === 'function') {
    window.fetchSensorData(sensorId);
  } else {
    console.error('fetchSensorData function not available');
  }
}

document.getElementById("fetch-sensor-btn").onclick = () => handleFetchSensor(sensorInput.value.trim());
document.getElementById("addSensorBtn").onclick = () => {
  const val = document.getElementById("newSensor").value.trim();
  if (!val) return;
  saveSensor(val);
  renderSensors();
  document.getElementById("newSensor").value = "";
};

/* ================= SENSOR TABLE PANEL ================= */
const sensorTablePanel = document.getElementById('sensorTablePanel');
const sensorTablePanelHeader = document.getElementById('sensorTablePanelHeader');
const sensorTablePanelChevron = document.getElementById('sensorTablePanelChevron');
const sensorTableContainer = document.getElementById('sensorTableContainer');
const sensorDataTable = document.getElementById('sensorDataTable');

// Toggle panel visibility
sensorTablePanelHeader.addEventListener('click', (e) => {
  e.stopPropagation();
  const isMinimized = sensorTablePanel.classList.toggle('minimized');
  sensorTablePanelChevron.classList.toggle('rotated', isMinimized);
  
  if (isMinimized) {
    sensorTableContainer.style.display = 'none';
  } else {
    sensorTableContainer.style.display = 'block';
  }
});

// Store sensor table data - Array to handle multiple entries for same sensor
window.sensorTableData = {};

// UPDATED: Function to update sensor data table with auto-expand feature
window.updateSensorTable = function(sensorId, sensorReadings) {
  console.log('updateSensorTable called with:', sensorId, sensorReadings);
  
  if (sensorId && sensorReadings) {
    // Ensure sensorReadings is an array
    if (!Array.isArray(sensorReadings)) {
      sensorReadings = [sensorReadings];
    }
    
    // Store all readings for this sensor
    if (!window.sensorTableData[sensorId]) {
      window.sensorTableData[sensorId] = [];
    }
    
    // Add new readings to the beginning (most recent first)
    sensorReadings.forEach(reading => {
      // Add timestamp if not present
      if (!reading.timestamp && !reading.Timestamp) {
        reading.timestamp = new Date().toISOString();
      }
      
      // Add sensor ID if not present
      if (!reading.sensorId && !reading.SensorId) {
        reading.sensorId = sensorId;
      }
      
      // Check if this reading already exists (by timestamp or other unique field)
      const exists = window.sensorTableData[sensorId].some(existing => 
        (existing.timestamp && existing.timestamp === reading.timestamp) ||
        (existing.Timestamp && existing.Timestamp === reading.Timestamp)
      );
      
      if (!exists) {
        window.sensorTableData[sensorId].unshift(reading); // Add to beginning
      }
    });
    
    // Keep only last 50 entries per sensor to prevent memory issues
    if (window.sensorTableData[sensorId].length > 50) {
      window.sensorTableData[sensorId] = window.sensorTableData[sensorId].slice(0, 50);
    }
  }
  
  const tbody = document.getElementById('sensorDataTableBody');
  const thead = document.getElementById('sensorDataTableHeader');
  
  // Collect all sensor data from all sensors
  const allSensorData = [];
  Object.keys(window.sensorTableData).forEach(sid => {
    window.sensorTableData[sid].forEach(reading => {
      allSensorData.push(reading);
    });
  });
  
  if (allSensorData.length === 0) {
    tbody.innerHTML = `
      <tr class="no-data-row">
        <td colspan="12">No sensor data available. Fetch a sensor first.</td>
      </tr>
    `;
    return;
  }
  
  // Clear and rebuild table
  tbody.innerHTML = '';
  
  // Show all readings (most recent first), matching header order exactly
  allSensorData.forEach((sensorData) => {
    const row = document.createElement('tr');
    
    // Sensor ID (matches header column 1)
    const idCell = document.createElement('td');
    idCell.className = 'sensor-id-cell';
    idCell.textContent = sensorData.sensor_id || sensorData.sensorId || sensorData.SensorId || sensorId || 'N/A';
    row.appendChild(idCell);
    
    // Timestamp (matches header column 2)
    const timeCell = document.createElement('td');
    const timestamp = sensorData.timestamp || sensorData.Timestamp;
    if (timestamp) {
      try {
        timeCell.textContent = new Date(timestamp).toLocaleString();
      } catch (e) {
        timeCell.textContent = timestamp;
      }
    } else {
      timeCell.textContent = '-';
    }
    row.appendChild(timeCell);
    
    // Latitude (matches header column 3)
    const latCell = document.createElement('td');
    latCell.textContent = sensorData.latitude !== undefined ? sensorData.latitude : 
                         sensorData.Latitude !== undefined ? sensorData.Latitude : '-';
    row.appendChild(latCell);
    
    // Longitude (matches header column 4)
    const lonCell = document.createElement('td');
    lonCell.textContent = sensorData.longitude !== undefined ? sensorData.longitude : 
                         sensorData.Longitude !== undefined ? sensorData.Longitude : '-';
    row.appendChild(lonCell);
    
    // Moisture (matches header column 5)
    const moistureCell = document.createElement('td');
    moistureCell.textContent = sensorData.moisture !== undefined ? sensorData.moisture : 
                              sensorData.Moisture !== undefined ? sensorData.Moisture : '-';
    row.appendChild(moistureCell);
    
    // Temperature (matches header column 6)
    const tempCell = document.createElement('td');
    tempCell.textContent = sensorData.temperature !== undefined ? sensorData.temperature : 
                          sensorData.Temperature !== undefined ? sensorData.Temperature : '-';
    row.appendChild(tempCell);
    
    // EC (matches header column 7)
    const ecCell = document.createElement('td');
    ecCell.textContent = sensorData.ec !== undefined ? sensorData.ec : 
                        sensorData.EC !== undefined ? sensorData.EC : '-';
    row.appendChild(ecCell);
    
    // pH Value (matches header column 8)
    const phCell = document.createElement('td');
    phCell.textContent = sensorData.ph_value !== undefined ? sensorData.ph_value : 
                        sensorData.PHValue !== undefined ? sensorData.PHValue : '-';
    row.appendChild(phCell);
    
    // Nitrogen (matches header column 9)
    const nitrogenCell = document.createElement('td');
    nitrogenCell.textContent = sensorData.nitrogen !== undefined ? sensorData.nitrogen : 
                              sensorData.Nitrogen !== undefined ? sensorData.Nitrogen : '-';
    row.appendChild(nitrogenCell);
    
    // Phosphorous (matches header column 10)
    const phosphorousCell = document.createElement('td');
    phosphorousCell.textContent = sensorData.phosphorous !== undefined ? sensorData.phosphorous : 
                                 sensorData.Phosphorous !== undefined ? sensorData.Phosphorous : '-';
    row.appendChild(phosphorousCell);
    
    // Potassium (matches header column 11)
    const potassiumCell = document.createElement('td');
    potassiumCell.textContent = sensorData.potassium !== undefined ? sensorData.potassium : 
                               sensorData.Potassium !== undefined ? sensorData.Potassium : '-';
    row.appendChild(potassiumCell);
    
    // Satellite Fix (matches header column 12)
    const satCell = document.createElement('td');
    satCell.textContent = sensorData.satellite_fix !== undefined ? sensorData.satellite_fix : 
                         sensorData.SatelliteFix !== undefined ? sensorData.SatelliteFix : '-';
    row.appendChild(satCell);
    
    tbody.appendChild(row);
  });
  
  // AUTO-EXPAND THE SENSOR PANEL WHEN DATA ARRIVES
  const sensorPanel = document.getElementById('sensorTablePanel');
  const sensorContainer = document.getElementById('sensorTableContainer');
  const sensorChevron = document.getElementById('sensorTablePanelChevron');
  
  if (sensorPanel && sensorPanel.classList.contains('minimized')) {
    console.log('Auto-expanding sensor panel...');
    // Expand the panel
    sensorPanel.classList.remove('minimized');
    if (sensorChevron) {
      sensorChevron.classList.remove('rotated');
    }
    if (sensorContainer) {
      sensorContainer.style.display = 'block';
    }
  }
  
  // Scroll the panel into view
  setTimeout(() => {
    if (sensorPanel) {
      sensorPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }, 100);
};

/* ================= REALTIME TABLE PANEL ================= */
const realtimeTablePanel = document.getElementById('realtimeTablePanel');
const realtimeTablePanelHeader = document.getElementById('realtimeTablePanelHeader');
const realtimeTablePanelChevron = document.getElementById('realtimeTablePanelChevron');
const realtimeTableContainer = document.getElementById('realtimeTableContainer');
const realtimeDataTable = document.getElementById('realtimeDataTable');

// Toggle panel visibility
realtimeTablePanelHeader.addEventListener('click', (e) => {
  e.stopPropagation();
  const isMinimized = realtimeTablePanel.classList.toggle('minimized');
  realtimeTablePanelChevron.classList.toggle('rotated', isMinimized);
  
  if (isMinimized) {
    realtimeTableContainer.style.display = 'none';
  } else {
    realtimeTableContainer.style.display = 'block';
  }
});

// Store real-time table data
window.realtimeTableData = {};
window.realtimeTableHeaders = ['Tracker ID'];

// Function to update the real-time data table
window.updateRealtimeTable = function(trackerId, data) {
  if (trackerId && data) {
    window.realtimeTableData[trackerId] = data;
  }
  
  // Get all selected parameters
  const allSelectedParams = new Set(['Tracker ID']);
  Object.keys(window.realtimeTableData).forEach(tid => {
    const params = window.getRealtimeParameters ? window.getRealtimeParameters(tid) : null;
    if (params) {
      Object.keys(params).forEach(param => {
        if (params[param]) allSelectedParams.add(param);
      });
    }
  });
  
  window.realtimeTableHeaders = Array.from(allSelectedParams);
  
  // Update table headers
  const thead = realtimeDataTable.querySelector('thead');
  const headerRow = thead.querySelector('tr');
  headerRow.innerHTML = '';
  
  window.realtimeTableHeaders.forEach(header => {
    const th = document.createElement('th');
    th.textContent = formatHeaderText(header);
    headerRow.appendChild(th);
  });
  
  // Update table body
  const tbody = realtimeDataTable.querySelector('tbody');
  tbody.innerHTML = '';
  
  if (Object.keys(window.realtimeTableData).length === 0) {
    const noDataRow = document.createElement('tr');
    noDataRow.className = 'no-data-row';
    const td = document.createElement('td');
    td.colSpan = window.realtimeTableHeaders.length;
    td.textContent = 'No tracker data available. Fetch a tracker first.';
    noDataRow.appendChild(td);
    tbody.appendChild(noDataRow);
    return;
  }
  
  Object.keys(window.realtimeTableData).forEach(tid => {
    const row = document.createElement('tr');
    
    window.realtimeTableHeaders.forEach(header => {
      const td = document.createElement('td');
      
      if (header === 'Tracker ID') {
        td.className = 'tracker-id-cell';
        td.textContent = tid;
      } else {
        const params = window.getRealtimeParameters ? window.getRealtimeParameters(tid) : null;
        if (params && params[header] && window.realtimeTableData[tid][header]) {
          td.textContent = formatCellValue(header, window.realtimeTableData[tid][header]);
        } else {
          td.textContent = '-';
          td.style.color = '#9ca3af';
        }
      }
      
      row.appendChild(td);
    });
    
    tbody.appendChild(row);
  });
};

function formatHeaderText(header) {
  const formatMap = {
    'timestamp': 'Timestamp',
    'latitude': 'Latitude',
    'longitude': 'Longitude',
    'altitude': 'Altitude',
    'uin_no': 'UIN No',
    'application': 'Application',
    'category': 'Category',
    'Tracker ID': 'Tracker ID'
  };
  return formatMap[header] || header;
}

function formatCellValue(header, value) {
  if (header === 'timestamp' && value) {
    try {
      return new Date(value).toLocaleString();
    } catch (e) {
      return value;
    }
  }
  if ((header === 'latitude' || header === 'longitude') && value) {
    return parseFloat(value).toFixed(6);
  }
  if (header === 'altitude' && value) {
    return `${parseFloat(value).toFixed(1)} m`;
  }
  return value || '-';
}

// Initialize table
window.updateRealtimeTable();

/* ================= STORAGE ================= */
const STORAGE_KEY = "saved_trackers";
const GROUP_KEY = "tracker_groups";
const REALTIME_SETTINGS_KEY = "realtime_parameters";
let activeGroup = null;
let selectedTrackerForRealtime = null;

const getSavedTrackers = () => JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
const saveTracker = (id) => {
  const trackers = getSavedTrackers();
  if (!trackers.includes(id)) {
    trackers.push(id);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(trackers));
  }
};

const getGroups = () => JSON.parse(localStorage.getItem(GROUP_KEY)) || {};
const saveGroups = (groups) => localStorage.setItem(GROUP_KEY, JSON.stringify(groups));

/* ================= REALTIME DATA SETTINGS ================= */
const getRealtimeSettings = () => JSON.parse(localStorage.getItem(REALTIME_SETTINGS_KEY)) || {};
const saveRealtimeSettings = (settings) => localStorage.setItem(REALTIME_SETTINGS_KEY, JSON.stringify(settings));

const availableParameters = [
  { id: 'timestamp', label: 'Timestamp', default: true },
  { id: 'latitude', label: 'Latitude', default: true },
  { id: 'longitude', label: 'Longitude', default: true },
  { id: 'altitude', label: 'Altitude', default: true },
  { id: 'uin_no', label: 'UIN No', default: true },
  { id: 'application', label: 'Application', default: true },
  { id: 'category', label: 'Category', default: true }
];

/* ================= TAG POPUP FUNCTIONS ================= */
const tagPopup = document.getElementById("tagPopup");
const trackerList = document.getElementById("trackerList");
const trackerInput = document.getElementById("tracker-id");

document.getElementById("openTagPopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  tagPopup.style.maxHeight = "600px";
  tagPopup.classList.remove("collapsed");
  document.getElementById("tagPopupChevron").classList.add("rotate");
  renderTrackers();
};

function renderTrackers() {
  trackerList.innerHTML = "";
  getSavedTrackers().forEach(id => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = id;
    div.onclick = () => handleFetch(id);
    trackerList.appendChild(div);
  });
}

function handleFetch(id) {
  if (!id) return;
  trackerInput.value = id;
  saveTracker(id);
  renderTrackers();
  if (window.handleFetch) {
    window.handleFetch(id);
  }
}

document.getElementById("fetch-btn").onclick = () => handleFetch(trackerInput.value.trim());
document.getElementById("addTrackerBtn").onclick = () => {
  const val = document.getElementById("newTracker").value.trim();
  if (!val) return;
  saveTracker(val);
  renderTrackers();
  document.getElementById("newTracker").value = "";
};

/* ================= GROUP POPUP FUNCTIONS ================= */
const groupPopup = document.getElementById("groupPopup");
const groupList = document.getElementById("groupList");

document.getElementById("openGroupPopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  groupPopup.style.maxHeight = "600px";
  groupPopup.classList.remove("collapsed");
  document.getElementById("groupPopupChevron").classList.add("rotate");
  renderGroups();
};

function renderGroups() {
  groupList.innerHTML = "";
  const groups = getGroups();
  Object.keys(groups).forEach(groupName => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = groupName;
    div.addEventListener("click", () => {
      openGroupDetail(groupName);
      groupDetailPopup.style.maxHeight = "600px";
      groupDetailPopup.classList.remove("collapsed");
    });
    groupList.appendChild(div);
  });
}

document.getElementById("createGroupBtn").onclick = () => {
  const name = document.getElementById("groupNameInput").value.trim();
  if (!name) return;
  const groups = getGroups();
  if (!groups[name]) groups[name] = [];
  saveGroups(groups);
  document.getElementById("groupNameInput").value = "";
  renderGroups();
};

/* ================= GROUP DETAIL POPUP ================= */
const groupDetailPopup = document.getElementById("groupDetailPopup");
const groupTrackerList = document.getElementById("groupTrackerList");
const groupDetailTitle = document.getElementById("groupDetailTitle");

let groupSettings = JSON.parse(localStorage.getItem('groupSettings')) || {};
const defaultColors = [
  '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', 
  '#EF476F', '#9D4EDD', '#FB5607', '#3A86FF', '#8338EC'
];

function openGroupDetail(groupName) {
  if (window.setActiveGroup) window.setActiveGroup(groupName);
  activeGroup = groupName;
  groupDetailTitle.textContent = groupName;
  const groups = getGroups();
  groupTrackerList.innerHTML = "";
  
  if (!groupSettings[groupName]) groupSettings[groupName] = {};
  
  (groups[groupName] || []).forEach((tid, index) => {
    if (!groupSettings[groupName][tid]) {
      groupSettings[groupName][tid] = {
        visible: true,
        color: defaultColors[index % defaultColors.length]
      };
    }
    
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.dataset.trackerId = tid;
    
    const checkboxContainer = document.createElement("div");
    checkboxContainer.className = "checkbox-container";
    
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "tracker-checkbox";
    checkbox.checked = groupSettings[groupName][tid].visible;
    checkbox.dataset.trackerId = tid;
    
    const colorPicker = document.createElement("input");
    colorPicker.type = "color";
    colorPicker.className = "tracker-color-picker";
    colorPicker.value = groupSettings[groupName][tid].color;
    colorPicker.dataset.trackerId = tid;
    colorPicker.style.display = "none";
    
    const colorPreview = document.createElement("div");
    colorPreview.className = "color-preview";
    colorPreview.style.backgroundColor = groupSettings[groupName][tid].color;
    
    const trackerIdSpan = document.createElement("span");
    trackerIdSpan.className = "tracker-id-text";
    trackerIdSpan.textContent = tid;
    trackerIdSpan.dataset.trackerId = tid;
    
    trackerIdSpan.onclick = () => {
      if (window.handleFetch) window.handleFetch(tid);
    };
    
    checkbox.onchange = (e) => {
      const trackerId = e.target.dataset.trackerId;
      const isVisible = e.target.checked;
      groupSettings[groupName][trackerId].visible = isVisible;
      saveGroupSettings();
      if (window.updateTrackerVisibilityFromGroup) {
        window.updateTrackerVisibilityFromGroup(trackerId, isVisible);
      }
    };
    
    colorPicker.onchange = (e) => {
      const trackerId = e.target.dataset.trackerId;
      const newColor = e.target.value;
      groupSettings[groupName][trackerId].color = newColor;
      saveGroupSettings();
      colorPreview.style.backgroundColor = newColor;
      if (window.updateTrackerColorFromGroup) {
        window.updateTrackerColorFromGroup(trackerId, newColor);
      }
    };
    
    colorPreview.onclick = () => colorPicker.click();
    
    checkboxContainer.appendChild(checkbox);
    checkboxContainer.appendChild(colorPreview);
    div.appendChild(checkboxContainer);
    div.appendChild(colorPicker);
    div.appendChild(trackerIdSpan);
    groupTrackerList.appendChild(div);
  });
  
  saveGroupSettings();
}

function saveGroupSettings() {
  localStorage.setItem('groupSettings', JSON.stringify(groupSettings));
}

// Add tracker to group (from group popup)
document.getElementById("addTrackerToGroupBtn").onclick = () => {
  if (!activeGroup) {
    alert("Select a group first");
    return;
  }
  const tracker = document.getElementById("groupTrackerInput").value.trim();
  if (!tracker) return;
  const groups = getGroups();
  if (!groups[activeGroup].includes(tracker)) {
    groups[activeGroup].push(tracker);
    saveGroups(groups);
  }
  document.getElementById("groupTrackerInput").value = "";
  renderGroups();
};

// Add tracker to group (from group detail popup)
document.getElementById("addTrackerToGroupDetailBtn").onclick = () => {
  if (!activeGroup) return;
  const tracker = document.getElementById("groupDetailTrackerInput").value.trim();
  if (!tracker) return;
  const groups = getGroups();
  if (!groups[activeGroup].includes(tracker)) {
    groups[activeGroup].push(tracker);
    saveGroups(groups);
    if (!groupSettings[activeGroup]) groupSettings[activeGroup] = {};
    const index = groups[activeGroup].length - 1;
    groupSettings[activeGroup][tracker] = {
      visible: true,
      color: defaultColors[index % defaultColors.length]
    };
    saveGroupSettings();
  }
  document.getElementById("groupDetailTrackerInput").value = "";
  openGroupDetail(activeGroup);
};

// Fetch group button
document.getElementById("fetchGroupBtn").onclick = () => {
  if (!activeGroup) {
    alert("Select a group first");
    return;
  }
  const groups = getGroups();
  const trackerIds = groups[activeGroup] || [];
  if (trackerIds.length === 0) {
    alert("No trackers in this group");
    return;
  }
  if (window.fetchGroupTrackers) window.fetchGroupTrackers(trackerIds);
};

/* ================= REALTIME DATA POPUP ================= */
const realtimePopup = document.getElementById("realtimePopup");
const realtimeGroupList = document.getElementById("realtimeGroupList");

document.getElementById("openRealtimePopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  realtimePopup.style.maxHeight = "600px";
  realtimePopup.classList.remove("collapsed");
  document.getElementById("realtimePopupChevron").classList.add("rotate");
  renderRealtimeGroups();
};

function renderRealtimeGroups() {
  realtimeGroupList.innerHTML = "";
  const groups = getGroups();
  
  if (Object.keys(groups).length === 0) {
    realtimeGroupList.innerHTML = `
      <div style="padding: 20px; text-align: center; color: #6b7280;">
        No groups found. Create groups first.
      </div>
    `;
    return;
  }
  
  Object.keys(groups).forEach(groupName => {
    const groupDiv = document.createElement("div");
    groupDiv.className = "realtime-group-header";
    groupDiv.innerHTML = `
      <i data-lucide="folder" style="width: 16px; height: 16px; margin-right: 8px; color: #6366f1;"></i>
      <span class="realtime-group-name">${groupName}</span>
      <i data-lucide="chevron-right" class="group-expand-btn" style="width: 16px; height: 16px;"></i>
    `;
    
    const trackerList = document.createElement("div");
    trackerList.className = "realtime-tracker-list";
    trackerList.style.display = "none";
    
    groups[groupName].forEach(trackerId => {
      const trackerDiv = document.createElement("div");
      trackerDiv.className = "realtime-tracker-item";
      trackerDiv.dataset.trackerId = trackerId;
      trackerDiv.dataset.groupName = groupName;
      trackerDiv.innerHTML = `
        <i data-lucide="tag" style="width: 14px; height: 14px; margin-right: 8px; color: #6b7280;"></i>
        <span class="realtime-tracker-id">${trackerId}</span>
      `;
      trackerDiv.onclick = (e) => {
        e.stopPropagation();
        showTrackerParameters(trackerId);
      };
      trackerList.appendChild(trackerDiv);
    });
    
    const chevron = groupDiv.querySelector(".group-expand-btn");
    groupDiv.onclick = () => {
      const isExpanded = trackerList.style.display === "block";
      trackerList.style.display = isExpanded ? "none" : "block";
      chevron.classList.toggle("rotated", !isExpanded);
      lucide.createIcons();
    };
    
    realtimeGroupList.appendChild(groupDiv);
    realtimeGroupList.appendChild(trackerList);
  });
  
  lucide.createIcons();
}

function showTrackerParameters(trackerId) {
  selectedTrackerForRealtime = trackerId;
  document.getElementById("selectedTrackerId").textContent = trackerId;
  document.getElementById("trackerParametersSection").style.display = "block";
  
  const parametersContainer = document.getElementById("parametersCheckboxes");
  parametersContainer.innerHTML = "";
  
  const settings = getRealtimeSettings();
  const trackerSettings = settings[trackerId] || {};
  
  availableParameters.forEach(param => {
    const div = document.createElement("div");
    div.className = "parameter-option";
    const checkboxId = `param_${trackerId}_${param.id}`;
    const isChecked = trackerSettings[param.id] !== undefined ? 
                      trackerSettings[param.id] : param.default;
    div.innerHTML = `
      <input type="checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}>
      <label for="${checkboxId}">${param.label}</label>
    `;
    const checkbox = div.querySelector('input');
    checkbox.onchange = () => {};
    parametersContainer.appendChild(div);
  });
}

document.getElementById("saveParametersBtn").onclick = () => {
  if (!selectedTrackerForRealtime) {
    alert("Please select a tracker first");
    return;
  }
  const settings = getRealtimeSettings();
  settings[selectedTrackerForRealtime] = settings[selectedTrackerForRealtime] || {};
  availableParameters.forEach(param => {
    const checkboxId = `param_${selectedTrackerForRealtime}_${param.id}`;
    const checkbox = document.getElementById(checkboxId);
    if (checkbox) settings[selectedTrackerForRealtime][param.id] = checkbox.checked;
  });
  saveRealtimeSettings(settings);
  const btn = document.getElementById("saveParametersBtn");
  const originalText = btn.textContent;
  btn.textContent = "Saved!";
  btn.style.background = "#10b981";
  setTimeout(() => {
    btn.textContent = originalText;
    btn.style.background = "#6366f1";
  }, 1500);
  if (window.realtimeTableData && window.realtimeTableData[selectedTrackerForRealtime]) {
    window.updateRealtimeTable();
  }
};

window.getRealtimeParameters = function(trackerId) {
  const settings = getRealtimeSettings();
  const trackerSettings = settings[trackerId];
  if (!trackerSettings) {
    return availableParameters.reduce((acc, param) => {
      acc[param.id] = param.default;
      return acc;
    }, {});
  }
  return trackerSettings;
};

window.formatRealtimeData = function(data, trackerId) {
  const parameters = window.getRealtimeParameters(trackerId);
  const formatted = { 'Tracker ID': trackerId };
  Object.keys(parameters).forEach(param => {
    if (parameters[param] && data[param] !== undefined) {
      formatted[param] = data[param];
    }
  });
  return formatted;
};

// Make realtime group dropdown collapsible
document.getElementById("realtimeGroupHeader").onclick = () => {
  const chevron = document.getElementById("realtimeGroupChevron");
  const dropdown = document.getElementById("realtimeGroupList");
  const isCollapsed = dropdown.style.display === "none";
  dropdown.style.display = isCollapsed ? "block" : "none";
  chevron.classList.toggle("rotate", isCollapsed);
};

/* ================= WINDOW RESIZE HANDLER ================= */
function handleResize() {
  const isMobile = window.innerWidth <= 768;
  if (!isMobile) {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
  }
}

window.addEventListener('resize', handleResize);
handleResize();

/* ================= INITIALIZATION ================= */
renderTrackers();
renderSensors();
renderGroups();

// Close popups when clicking Escape key or outside
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeAllPopups();
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
  }
});

// Close popups when clicking outside
document.addEventListener('click', (e) => {
  const popups = document.querySelectorAll('.tag-popup');
  const isClickInsidePopup = Array.from(popups).some(popup => popup.contains(e.target));
  const isClickInsideSidebar = sidebar.contains(e.target);
  const isClickOnMobileToggle = mobileMenuToggle.contains(e.target);
  
  if (!isClickInsidePopup && !isClickInsideSidebar && !isClickOnMobileToggle) {
    closeAllPopups();
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Alt+S for sensor panel
  if (e.altKey && e.key === 's') {
    e.preventDefault();
    const sensorPanel = document.getElementById('sensorTablePanel');
    const sensorHeader = document.getElementById('sensorTablePanelHeader');
    if (sensorPanel && sensorHeader) {
      sensorHeader.click();
    }
  }
  
  // Alt+T for tracker panel
  if (e.altKey && e.key === 't') {
    e.preventDefault();
    const trackerPanel = document.getElementById('realtimeTablePanel');
    const trackerHeader = document.getElementById('realtimeTablePanelHeader');
    if (trackerPanel && trackerHeader) {
      trackerHeader.click();
    }
  }
});

/* ================= TEST FUNCTION ================= */
function testSensorDisplay() {
  console.log('Testing sensor display...');
  
  // Create test data
  const testData = [{
    sensor_id: '123',
    timestamp: new Date().toLocaleString(),
    latitude: 23.027015,
    longitude: 72.567448,
    moisture: 33.49,
    temperature: 25.5,
    ec: 3.93,
    ph_value: 6.5,
    nitrogen: 36.71,
    phosphorous: 28.9,
    potassium: 32.1,
    satellite_fix: 'GPS'
  }];
  
  // Update table
  if (window.updateSensorTable) {
    window.updateSensorTable('123', testData);
    console.log('Test data added to table');
  } else {
    console.error('updateSensorTable function not found');
  }
}

// Initialize sensor panel on page load
document.addEventListener('DOMContentLoaded', function() {
  console.log('Dashboard initialized');
  
  // Test sensor display after 1 second
  setTimeout(testSensorDisplay, 1000);
  
  // Check if there's already data in the sensor table
  const tbody = document.getElementById('sensorDataTableBody');
  const sensorPanel = document.getElementById('sensorTablePanel');
  const sensorContainer = document.getElementById('sensorTableContainer');
  const sensorChevron = document.getElementById('sensorTablePanelChevron');
  
  // Check if the table has data (more than one row and not the no-data row)
  if (tbody && tbody.children.length > 0 && 
      !tbody.querySelector('.no-data-row')) {
    // Expand panel if there's data
    if (sensorPanel && sensorPanel.classList.contains('minimized')) {
      sensorPanel.classList.remove('minimized');
      if (sensorChevron) {
        sensorChevron.classList.remove('rotated');
      }
      if (sensorContainer) {
        sensorContainer.style.display = 'block';
      }
    }
  }
});
</script>

</body>
</html> #}


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drone Tracker Dashboard</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* ================= BASE STYLES ================= */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      background: #f9fafb;
    }

    /* ================= HEADER ================= */
    header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 70px;
  background: #ffffff;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  align-items: center;
  justify-content: space-between; /* Key */
  padding: 0 20px;
  z-index: 3000;
}

/* Left logo */
.header-left {
  display: flex;
  align-items: center;
}

.logo {
  height: 60px;
  width: 60px;
}

/* Center title */
.header-center {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
  gap: 10px;
}

.site-name {
  font-size: 30px;
  font-weight: 700;
  color: #3973f0ff;
}

/* Drone image */
.Drone-photo {
  height: 70px;
  width: 117px;
  border-radius: 8px;
  object-fit: cover;
  border: 2px solid #e5e7eb;
}



    /* ================= SIDEBAR ================= */
    .sidebar {
      position: fixed;
      top: 70px;
      left: 0;
      bottom: 0;
      width: 160px;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      z-index: 2000;
      overflow-y: auto;
      transition: transform 0.3s ease;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        width: 200px;
      }
      .sidebar.open {
        transform: translateX(0);
      }
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      flex-shrink: 0;
      display: none;
    }

    .sidebar-nav {
      padding: 12px 8px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .sidebar-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 14px 10px;
      margin-bottom: 8px;
      cursor: pointer;
      border-radius: 10px;
      transition: background 0.2s ease;
    }

    .sidebar-item:hover {
      background: #f3f4f6;
    }

    .item-top {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

      /* .sidebar-icon {
      width: 40px;
      height: 40px;
      color: #6366f1;
    } */

.sidebar-icon {
  width: 115px;
  height: 68px;
  color: #6366f1;
  border: 2px solid #6366f1;
  border-radius: 8px; /* slight rounding */
  display: flex;
  align-items: center;
  justify-content: center;
}




.sidebar-item:hover .sidebar-icon {
  border-color: #4f46e5;
  color: #4f46e5;
  background: #eef2ff;
}



    .sidebar-item span {
      font-size: 13px;
      color: #374151;
    }

    .chevron {
      margin-top: 6px;
      transition: transform 0.2s ease;
      color: #6b7280;
    }

    .chevron.rotate {
      transform: rotate(180deg);
    }

    .sidebar-dropdown {
      display: none;
      margin-left: 12px;
      margin-bottom: 10px;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 500;
      color: #4b5563;
      cursor: pointer;
      border-radius: 8px;
    }

    .dropdown-item:hover {
      background: #eef2ff;
    }

    /* ================= MAIN CONTENT ================= */
    main {
      position: fixed;
      top: 70px;
      left: 160px;
      right: 0;
      bottom: 0;
      padding: 15px;
      overflow-y: auto;
      z-index: 1;
      transition: left 0.3s ease;
    }

    @media (max-width: 768px) {
      main {
        left: 0;
      }
    }

    #status-message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }

    .last-updated {
      margin-bottom: 15px;
      font-size: 13px;
      color: #6b7280;
    }

    /* ================= MAP CONTAINER ================= */
    .map-container {
      position: relative;
      height: calc(100vh - 210px);
      min-height: 400px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    #map {
      height: 100%;
      width: 100%;
    }

    /* ================= POPUPS ================= */
    .tag-popup {
      position: fixed;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      z-index: 2500;
      overflow: hidden;
      transition: all 0.3s ease;
      max-height: 0;
      border-left: 4px solid #6366f1;
    }

    @media (max-width: 1024px) {
      .tag-popup {
        left: 50% !important;
        transform: translateX(-50%);
        width: 90% !important;
        max-width: 400px;
      }
    }

    .tag-popup.collapsed {
      max-height: 0 !important;
    }

    .tag-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 16px;
      background: #f3f4f6;
      border-bottom: 1px solid #e5e7eb;
    }

    .tag-popup-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      flex: 1;
    }

    .tag-popup-body {
      padding: 16px;
      display: block;
    }

    .tag-popup.collapsed .tag-popup-body {
      display: none;
    }

    .tag-popup.collapsed .tag-popup-header {
      border-bottom: none;
    }

    .tracker-dropdown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 8px 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 6px;
    }

    .tracker-dropdown.collapsible {
      display: block;
      max-height: 160px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .tracker-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      cursor: pointer;
    }

    .tracker-option:hover {
      background: #eef2ff;
    }

    .tracker-option input[type="checkbox"] {
      transform: scale(1.1);
      cursor: pointer;
    }

    .tracker-option input[type="color"] {
      width: 28px;
      height: 28px;
      border: none;
      padding: 0;
      cursor: pointer;
      border-radius: 4px;
    }

    .tracker-option span {
      flex: 1;
      cursor: pointer;
    }

    .add-tracker {
      padding: 8px;
      display: flex;
      gap: 6px;
      border-top: 1px solid #e5e7eb;
    }

    .tag-input-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .tag-input-row input {
      flex: 1;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
    }

    .tag-input-row button {
      padding: 8px 12px;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .tag-input-row button:hover {
      background: #4f46e5;
    }

    /* Popup positioning */
    #tagPopup {
      left: 170px;
      top: 90px;
      width: 320px;
    }

    #sensorPopup {
      left: 170px;
      top: 140px;
      width: 320px;
    }

    #groupPopup {
      left: 170px;
      top: 190px;
      width: 320px;
    }

    #groupDetailPopup {
      left: 510px;
      top: 90px;
      width: 320px;
    }

    #realtimePopup {
      left: 170px;
      top: 240px;
      width: 320px;
    }

    /* ================= SENSOR DATA TABLE PANEL ================= */
    #sensorTablePanel {
      position: fixed;
      bottom: 80px;                      /* can move sensor panel up or down */
      left: 175px;
      right: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1500;
      transition: all 0.3s ease;
      max-height: 250px;
      overflow: hidden;
    }

    @media (max-width: 768px) {
      #sensorTablePanel {
        left: 15px;
        bottom: 220px;
      }
    }

    #sensorTablePanel.minimized {
      max-height: 44px;
    }

    #sensorTablePanelHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
    }

    #sensorTablePanelHeader h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    #sensorTablePanelChevron {
      transition: transform 0.3s ease;
    }

    #sensorTablePanelChevron.rotated {
      transform: rotate(180deg);
    }

    #sensorTableContainer {
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    #sensorDataTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    #sensorDataTable th {
      background: #f9fafb;
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 0;
      white-space: nowrap;
    }

    #sensorDataTable td {
      padding: 10px 12px;
      border-bottom: 1px solid #f3f4f6;
      color: #4b5563;
      white-space: nowrap;
    }

    #sensorDataTable tr:hover {
      background: #f9fafb;
    }

    .sensor-id-cell {
      font-weight: 600;
      color: #10b981;
    }

    /* ================= REALTIME DATA TABLE PANEL ================= */
    #realtimeTablePanel {
      position: fixed;
      bottom: 15px;
      left: 175px;
      right: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1500;
      transition: all 0.3s ease;
      max-height: 250px;
      overflow: hidden;
    }

    @media (max-width: 768px) {
      #realtimeTablePanel {
        left: 15px;
      }
    }

    #realtimeTablePanel.minimized {
      max-height: 44px;
    }

    #realtimeTablePanelHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
    }

    #realtimeTablePanelHeader h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    #realtimeTablePanelChevron {
      transition: transform 0.3s ease;
    }

    #realtimeTablePanelChevron.rotated {
      transform: rotate(180deg);
    }

    #realtimeTableContainer {
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    #realtimeDataTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    #realtimeDataTable th {
      background: #f9fafb;
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 0;
      white-space: nowrap;
    }

    #realtimeDataTable td {
      padding: 10px 12px;
      border-bottom: 1px solid #f3f4f6;
      color: #4b5563;
      white-space: nowrap;
    }

    #realtimeDataTable tr:hover {
      background: #f9fafb;
    }

    .tracker-id-cell {
      font-weight: 600;
      color: #6366f1;
    }

    .no-data-row td {
      text-align: center;
      padding: 30px;
      color: #9ca3af;
      font-style: italic;
    }

    /* ================= IMAGE GRID ================= */
    #images-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      padding-bottom: 20px;
    }

    .image-container {
      width: calc(25% - 10px);
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }

    @media (max-width: 1200px) {
      .image-container {
        width: calc(33.333% - 10px);
      }
    }

    @media (max-width: 768px) {
      .image-container {
        width: calc(50% - 10px);
      }
    }

    .image-container img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }

    /* ================= REALTIME DATA STYLES ================= */
    .parameter-option {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      cursor: pointer;
    }

    .parameter-option:hover {
      background: #f9fafb;
    }

    .parameter-option input[type="checkbox"] {
      margin-right: 10px;
      cursor: pointer;
      transform: scale(1.1);
    }

    .parameter-option label {
      cursor: pointer;
      flex: 1;
      user-select: none;
    }

    .realtime-tracker-item {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .realtime-tracker-item:hover {
      background: #eef2ff;
    }

    .realtime-tracker-id {
      flex: 1;
      font-size: 14px;
      color: #374151;
    }

    .group-expand-btn {
      margin-left: 8px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .group-expand-btn.rotated {
      transform: rotate(90deg);
    }

    .realtime-group-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      background: #f9fafb;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 5px;
    }

    .realtime-group-header:hover {
      background: #f3f4f6;
    }

    .realtime-group-name {
      flex: 1;
      font-weight: 600;
      color: #374151;
    }

    .realtime-tracker-list {
      margin-left: 15px;
      border-left: 2px solid #e5e7eb;
      padding-left: 10px;
    }

    /* ================= GROUP CONTROLS ================= */
    .group-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .group-control-btn {
      padding: 6px 12px;
      background: rgba(99, 102, 241, 0.8);
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }

    .group-control-btn:hover {
      background: rgba(79, 70, 229, 1);
    }

    /* ================= SCROLLBAR STYLING ================= */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    /* ================= MOBILE MENU TOGGLE ================= */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 4000;
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .mobile-menu-toggle {
        display: block;
      }
    }

    /* ================= OVERLAY ================= */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
    }

    .overlay.active {
      display: block;
    }

    /* ================= STATUS MESSAGES ================= */
    .status-loading {
      background: #fef3c7;
      color: #92400e;
    }

    .status-success {
      background: #d1fae5;
      color: #065f46;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    /* ================= CHECKBOX CONTAINER ================= */
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-preview {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      cursor: pointer;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    /* ================= SENSOR POPUP STYLES ================= */
    .sensor-input-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .sensor-input-row input {
      flex: 1;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
    }

    .sensor-input-row button {
      padding: 8px 12px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .sensor-input-row button:hover {
      background: #059669;
    }
  </style>
</head>

<body>

<button class="mobile-menu-toggle" id="mobileMenuToggle">
  <i data-lucide="menu"></i>
</button>

<header>
  <div class="header-left">
    <img src="{{ url_for('static', filename='images/logo.svg') }}" class="logo">
  </div>

  <div class="header-center">
    <span class="site-name">DRONE TAG</span>
    <img src="/static/images/Drone.png" class="Drone-photo">
  </div>

  <div class="header-right"></div>
</header>


<div class="overlay" id="overlay"></div>

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar" id="sidebar">
  <nav class="sidebar-nav">
    <div class="sidebar-item" onclick="scrollToTop()">
      <i data-lucide="layout-dashboard" class="sidebar-icon"></i>
      <span>Dashboard</span>
    </div>

    <div class="sidebar-item" id="settingsToggle">
      <div class="item-top">
        <i data-lucide="settings" class="sidebar-icon"></i>
        <span>Settings</span>
      </div>
      <i data-lucide="chevron-down" class="chevron" id="settingsChevron"></i>
    </div>

    <div class="sidebar-dropdown" id="settingsDropdown">
      <div class="dropdown-item" id="openTagPopup">
        <i data-lucide="tag"></i><span>Tag</span>
      </div>
      <div class="dropdown-item" id="openSensorPopup">
        <i data-lucide="cpu"></i><span>Sensor</span>
      </div>
      <div class="dropdown-item" id="openRealtimePopup">
        <i data-lucide="activity"></i><span>Real-time Data</span>
      </div>
    </div>

    <div class="sidebar-item" id="reportsToggle">
      <div class="item-top">
        <i data-lucide="file-text" class="sidebar-icon"></i><span>Reports</span>
      </div>
      <i data-lucide="chevron-down" class="chevron" id="reportsChevron"></i>
    </div>

    <div class="sidebar-dropdown" id="reportsDropdown">
      <div class="dropdown-item" id="openGroupPopup">
        <i data-lucide="folder"></i><span>Group Name</span>
      </div>
    </div>
  </nav>
</aside>

<!-- ================= TAG POPUP ================= -->
<div class="tag-popup" id="tagPopup">
  <div class="tag-popup-header" id="tagPopupHeader">
    <h4>Tracker Popup</h4>
    <i data-lucide="chevron-down" class="chevron" id="tagPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="tagPopupBody">
    <div class="tracker-dropdown-header" id="trackerDropdownHeader">
      <span>Available Trackers</span>
      <i data-lucide="chevron-down" class="chevron" id="trackerChevron"></i>
    </div>
    <div class="tracker-dropdown collapsible" id="trackerList"></div>

    <div class="add-tracker">
      <input type="text" id="newTracker" placeholder="Add tracker ID">
      <button id="addTrackerBtn">+</button>
    </div>

    <div class="tag-input-row">
      <input type="text" id="tracker-id" placeholder="Manual Tracker ID">
      <button id="fetch-btn">Fetch</button>
    </div>
  </div>
</div>

<!-- ================= SENSOR POPUP ================= -->
<div class="tag-popup" id="sensorPopup">
  <div class="tag-popup-header" id="sensorPopupHeader">
    <h4>Sensor Data</h4>
    <i data-lucide="chevron-down" class="chevron" id="sensorPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="sensorPopupBody">
    <div class="tracker-dropdown-header" id="sensorDropdownHeader">
      <span>Available Sensors</span>
      <i data-lucide="chevron-down" class="chevron" id="sensorChevron"></i>
    </div>
    <div class="tracker-dropdown collapsible" id="sensorList"></div>

    <div class="add-tracker">
      <input type="text" id="newSensor" placeholder="Add sensor ID">
      <button id="addSensorBtn">+</button>
    </div>

    <div class="sensor-input-row">
      <input type="text" id="sensor-id" placeholder="Manual Sensor ID">
      <button id="fetch-sensor-btn">Fetch Sensor</button>
    </div>
  </div>
</div>

<!-- ================= GROUP POPUP ================= -->
<div class="tag-popup" id="groupPopup">
  <div class="tag-popup-header" id="groupPopupHeader">
    <h4>Tracker Groups</h4>
    <i data-lucide="chevron-down" class="chevron" id="groupPopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="groupPopupBody">
    <div class="tag-input-row">
      <input type="text" id="groupNameInput" placeholder="Group Name">
      <button id="createGroupBtn">Add Group</button>
    </div>

    <div id="groupList" class="tracker-dropdown collapsible" style="margin-top:10px;"></div>

    <div class="tag-input-row">
      <input type="text" id="groupTrackerInput" placeholder="Tracker ID">
      <button id="addTrackerToGroupBtn">Add</button>
    </div>

    <div class="tag-input-row">
      <button id="fetchGroupBtn" style="width:100%">Fetch Group</button>
    </div>
  </div>
</div>

<!-- ================= GROUP DETAIL POPUP ================= -->
<div class="tag-popup" id="groupDetailPopup">
  <div class="tag-popup-header" id="groupDetailHeader">
    <h4 id="groupDetailTitle">Group</h4>
    <i data-lucide="chevron-down" class="chevron" id="groupDetailChevron"></i>
  </div>

  <div class="tag-popup-body" id="groupDetailBody">
    <div id="groupTrackerList" class="tracker-dropdown collapsible"></div>

    <div class="tag-input-row" style="margin-top:10px;">
      <input type="text" id="groupDetailTrackerInput" placeholder="Add Tracker ID" />
      <button id="addTrackerToGroupDetailBtn">Add</button>
    </div>
  </div>
</div>

<!-- ================= REALTIME DATA POPUP ================= -->
<div class="tag-popup" id="realtimePopup">
  <div class="tag-popup-header" id="realtimePopupHeader">
    <h4>Real-time Data Parameters</h4>
    <i data-lucide="chevron-down" class="chevron" id="realtimePopupChevron"></i>
  </div>

  <div class="tag-popup-body" id="realtimePopupBody">
    <div class="tracker-dropdown-header" id="realtimeGroupHeader">
      <span>Select Group</span>
      <i data-lucide="chevron-down" class="chevron" id="realtimeGroupChevron"></i>
    </div>
    
    <div class="tracker-dropdown collapsible" id="realtimeGroupList"></div>

    <div id="trackerParametersSection" style="display: none;">
      <div style="margin: 15px 0 10px 0; font-weight: 600; color: #374151;">
        Selected Tracker: <span id="selectedTrackerId">-</span>
      </div>
      
      <div id="parametersCheckboxes" class="tracker-dropdown collapsible" style="max-height: 200px;"></div>
      
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
        <button id="saveParametersBtn" style="width: 100%; padding: 8px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
          Save Parameters
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ================= MAIN CONTENT ================= -->
<main>
  <div id="status-message"></div>
  <div class="last-updated"></div>
  
  <div class="map-container">
    <div id="map"></div>
  </div>
  
 <!-- ================= SENSOR DATA TABLE PANEL ================= -->
<div id="sensorTablePanel" class="minimized">
  <div id="sensorTablePanelHeader">
    <h3>Sensor Data Table</h3>
    <i data-lucide="chevron-up" id="sensorTablePanelChevron" class="rotated"></i>
  </div>
  <div id="sensorTableContainer" style="display: none;">
    <table id="sensorDataTable">
      <thead id="sensorDataTableHeader">
        <tr>
          <th>Sensor ID</th>
          <th>Timestamp</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Moisture</th>
          <th>Temperature</th>
          <th>EC</th>
          <th>pH Value</th>
          <th>Nitrogen</th>
          <th>Phosphorous</th>
          <th>Potassium</th>
          <th>Satellite Fix</th>
        </tr>
      </thead>
      <tbody id="sensorDataTableBody">
        <tr class="no-data-row">
          <td colspan="12">No sensor data available. Fetch a sensor first.</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
  
  <!-- ================= REALTIME DATA TABLE PANEL ================= -->
  <div id="realtimeTablePanel" class="minimized">
    <div id="realtimeTablePanelHeader">
      <h3>Tracker Data Table</h3>
      <i data-lucide="chevron-up" id="realtimeTablePanelChevron" class="rotated"></i>
    </div>
    <div id="realtimeTableContainer" style="display: none;">
      <table id="realtimeDataTable">
        <thead>
          <tr>
            <th>Tracker ID</th>
          </tr>
        </thead>
        <tbody>
          <tr class="no-data-row">
            <td>No tracker data available. Fetch a tracker first.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <div id="images-grid"></div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="{{ url_for('static', filename='js/fetchdata.js') }}"></script>

<script>
lucide.createIcons();

/* ================= MOBILE MENU ================= */
const mobileMenuToggle = document.getElementById('mobileMenuToggle');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');

mobileMenuToggle.addEventListener('click', () => {
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
});

overlay.addEventListener('click', () => {
  sidebar.classList.remove('open');
  overlay.classList.remove('active');
});

/* ================= RESPONSIVE HELPERS ================= */
function scrollToTop() {
  document.querySelector('main').scrollTo({ top: 0, behavior: 'smooth' });
}

function closeAllPopups() {
  const popups = document.querySelectorAll('.tag-popup');
  popups.forEach(popup => {
    popup.style.maxHeight = '0';
    popup.classList.add('collapsed');
    const chevron = popup.querySelector('.chevron');
    if (chevron) chevron.classList.remove('rotate');
  });
}

/* ================= POPUP MANAGEMENT ================= */
function makePopupCollapsible(popupId, chevronId) {
  const popup = document.getElementById(popupId);
  const chevron = document.getElementById(chevronId);
  const header = document.getElementById(popupId + 'Header') || popup.querySelector('.tag-popup-header');

  if (!popup || !chevron) return;

  const togglePopup = (e) => {
    if (e) e.stopPropagation();
    const collapsed = popup.classList.toggle("collapsed");
    chevron.classList.toggle("rotate", !collapsed);
    
    if (!collapsed) {
      // Close other popups when opening this one
      const allPopups = document.querySelectorAll('.tag-popup');
      allPopups.forEach(p => {
        if (p.id !== popupId && !p.classList.contains('collapsed')) {
          p.style.maxHeight = '0';
          p.classList.add('collapsed');
          const otherChevron = p.querySelector('.chevron');
          if (otherChevron) otherChevron.classList.remove('rotate');
        }
      });
      
      // Set max height based on content
      const body = popup.querySelector('.tag-popup-body');
      if (body) {
        const height = body.scrollHeight + 48;
        popup.style.maxHeight = `${Math.min(height, 600)}px`;
      }
    } else {
      popup.style.maxHeight = '0';
    }
  };

  chevron.addEventListener("click", togglePopup);
  
  if (header) {
    header.addEventListener("click", togglePopup);
  }
}

// Initialize all popups
makePopupCollapsible("tagPopup", "tagPopupChevron");
makePopupCollapsible("sensorPopup", "sensorPopupChevron");
makePopupCollapsible("groupPopup", "groupPopupChevron");
makePopupCollapsible("groupDetailPopup", "groupDetailChevron");
makePopupCollapsible("realtimePopup", "realtimePopupChevron");

/* ================= SIDEBAR DROPDOWNS ================= */
function toggleMenu(toggleBtn, dropdown, chevron) {
  if (!toggleBtn || !dropdown || !chevron) return;
  
  toggleBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const open = dropdown.style.display === "block";
    dropdown.style.display = open ? "none" : "block";
    chevron.classList.toggle("rotate", !open);
  });
}

toggleMenu(
  document.getElementById("settingsToggle"),
  document.getElementById("settingsDropdown"),
  document.getElementById("settingsChevron")
);

toggleMenu(
  document.getElementById("reportsToggle"),
  document.getElementById("reportsDropdown"),
  document.getElementById("reportsChevron")
);

/* ================= SENSOR POPUP FUNCTIONS ================= */
const sensorPopup = document.getElementById("sensorPopup");
const sensorList = document.getElementById("sensorList");
const sensorInput = document.getElementById("sensor-id");

document.getElementById("openSensorPopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  sensorPopup.style.maxHeight = "600px";
  sensorPopup.classList.remove("collapsed");
  document.getElementById("sensorPopupChevron").classList.add("rotate");
  renderSensors();
};

// Sensor storage
const SENSOR_STORAGE_KEY = "saved_sensors";

const getSavedSensors = () => JSON.parse(localStorage.getItem(SENSOR_STORAGE_KEY)) || [];
const saveSensor = (id) => {
  const sensors = getSavedSensors();
  if (!sensors.includes(id)) {
    sensors.push(id);
    localStorage.setItem(SENSOR_STORAGE_KEY, JSON.stringify(sensors));
  }
};

function renderSensors() {
  sensorList.innerHTML = "";
  getSavedSensors().forEach(id => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = id;
    div.onclick = () => handleFetchSensor(id);
    sensorList.appendChild(div);
  });
}

function handleFetchSensor(sensorId) {
  if (!sensorId) return;
  sensorInput.value = sensorId;
  saveSensor(sensorId);
  renderSensors();
  if (window.fetchSensorData) {
    window.fetchSensorData(sensorId);
  }
}

document.getElementById("fetch-sensor-btn").onclick = () => handleFetchSensor(sensorInput.value.trim());
document.getElementById("addSensorBtn").onclick = () => {
  const val = document.getElementById("newSensor").value.trim();
  if (!val) return;
  saveSensor(val);
  renderSensors();
  document.getElementById("newSensor").value = "";
};

/* ================= SENSOR TABLE PANEL ================= */
const sensorTablePanel = document.getElementById('sensorTablePanel');
const sensorTablePanelHeader = document.getElementById('sensorTablePanelHeader');
const sensorTablePanelChevron = document.getElementById('sensorTablePanelChevron');
const sensorTableContainer = document.getElementById('sensorTableContainer');
const sensorDataTable = document.getElementById('sensorDataTable');

// Toggle panel visibility
sensorTablePanelHeader.addEventListener('click', (e) => {
  e.stopPropagation();
  const isMinimized = sensorTablePanel.classList.toggle('minimized');
  sensorTablePanelChevron.classList.toggle('rotated', isMinimized);
  
  if (isMinimized) {
    sensorTableContainer.style.display = 'none';
  } else {
    sensorTableContainer.style.display = 'block';
  }
});

// Store sensor table data - Array to handle multiple entries for same sensor
window.sensorTableData = {};

// Function to update sensor data table
window.updateSensorTable = function(sensorId, sensorReadings) {
  if (sensorId && sensorReadings) {
    // Ensure sensorReadings is an array
    if (!Array.isArray(sensorReadings)) {
      sensorReadings = [sensorReadings];
    }
    
    // Store all readings for this sensor
    if (!window.sensorTableData[sensorId]) {
      window.sensorTableData[sensorId] = [];
    }
    
    // Add new readings to the beginning (most recent first)
    sensorReadings.forEach(reading => {
      // Add timestamp if not present
      if (!reading.timestamp && !reading.Timestamp) {
        reading.timestamp = new Date().toISOString();
      }
      
      // Add sensor ID if not present
      if (!reading.sensorId && !reading.SensorId) {
        reading.sensorId = sensorId;
      }
      
      // Check if this reading already exists (by Id or timestamp)
      const exists = window.sensorTableData[sensorId].some(existing => 
        (existing.Id && existing.Id === reading.Id) || 
        (existing.timestamp && existing.timestamp === reading.timestamp) ||
        (existing.Timestamp && existing.Timestamp === reading.Timestamp)
      );
      
      if (!exists) {
        window.sensorTableData[sensorId].unshift(reading); // Add to beginning
      }
    });
    
    // Keep only last 50 entries per sensor to prevent memory issues
    if (window.sensorTableData[sensorId].length > 50) {
      window.sensorTableData[sensorId] = window.sensorTableData[sensorId].slice(0, 50);
    }
  }
  
  const tbody = document.getElementById('sensorDataTableBody');
  const thead = document.getElementById('sensorDataTableHeader');
  
  // Collect all sensor data from all sensors
  const allSensorData = [];
  Object.keys(window.sensorTableData).forEach(sid => {
    window.sensorTableData[sid].forEach(reading => {
      allSensorData.push(reading);
    });
  });
  
  if (allSensorData.length === 0) {
    tbody.innerHTML = `
      <tr class="no-data-row">
        <td colspan="12">No sensor data available. Fetch a sensor first.</td>
      </tr>
    `;
    return;
  }
  
  // Clear and rebuild table
  tbody.innerHTML = '';
  
  // Show all readings (most recent first)
  allSensorData.forEach((sensorData, index) => {
    const row = document.createElement('tr');
    
    // Sensor ID
    const idCell = document.createElement('td');
    idCell.className = 'sensor-id-cell';
    idCell.textContent = sensorData.sensorId || sensorData.SensorId || sensorId || 'N/A';
    row.appendChild(idCell);
    
    // Timestamp
    const timeCell = document.createElement('td');
    const timestamp = sensorData.timestamp || sensorData.Timestamp;
    if (timestamp) {
      try {
        timeCell.textContent = new Date(timestamp).toLocaleString();
      } catch (e) {
        timeCell.textContent = timestamp;
      }
    } else {
      timeCell.textContent = '-';
    }
    row.appendChild(timeCell);
    
    // EC
    const ecCell = document.createElement('td');
    ecCell.textContent = sensorData.EC !== undefined ? sensorData.EC : '-';
    row.appendChild(ecCell);
    
    // Moisture
    const moistureCell = document.createElement('td');
    moistureCell.textContent = sensorData.Moisture !== undefined ? sensorData.Moisture : '-';
    row.appendChild(moistureCell);
    
    // Nitrogen
    const nitrogenCell = document.createElement('td');
    nitrogenCell.textContent = sensorData.Nitrogen !== undefined ? sensorData.Nitrogen : '-';
    row.appendChild(nitrogenCell);
    
    // Phosphorous
    const phosphorousCell = document.createElement('td');
    phosphorousCell.textContent = sensorData.Phosphorous !== undefined ? sensorData.Phosphorous : '-';
    row.appendChild(phosphorousCell);
    
    // PH Value
    const phCell = document.createElement('td');
    phCell.textContent = sensorData.PHValue !== undefined ? sensorData.PHValue : '-';
    row.appendChild(phCell);
    
    // Potassium
    const potassiumCell = document.createElement('td');
    potassiumCell.textContent = sensorData.Potassium !== undefined ? sensorData.Potassium : '-';
    row.appendChild(potassiumCell);
    
    // Temperature
    const tempCell = document.createElement('td');
    tempCell.textContent = sensorData.Temperature !== undefined ? sensorData.Temperature : '-';
    row.appendChild(tempCell);
    
    // Id (if available)
    const recordIdCell = document.createElement('td');
    recordIdCell.textContent = sensorData.Id !== undefined ? sensorData.Id : '-';
    recordIdCell.style.color = '#9ca3af';
    recordIdCell.style.fontSize = '11px';
    row.appendChild(recordIdCell);
    
    // Latitude
    const latCell = document.createElement('td');
    latCell.textContent = sensorData.Latitude !== undefined ? sensorData.Latitude : '-';
    row.appendChild(latCell);
    
    // Longitude
    const lonCell = document.createElement('td');
    lonCell.textContent = sensorData.Longitude !== undefined ? sensorData.Longitude : '-';
    row.appendChild(lonCell);
    
    // Satellite Fix
    const satCell = document.createElement('td');
    satCell.textContent = sensorData.SatelliteFix !== undefined ? sensorData.SatelliteFix : '-';
    row.appendChild(satCell);
    
    tbody.appendChild(row);
  });
  
  // Show sensor panel if minimized
  const sensorPanel = document.getElementById('sensorTablePanel');
  if (sensorPanel && sensorPanel.classList.contains('minimized')) {
    sensorPanel.classList.remove('minimized');
    const chevron = document.getElementById('sensorTablePanelChevron');
    if (chevron) chevron.classList.remove('rotated');
    const container = document.getElementById('sensorTableContainer');
    if (container) container.style.display = 'block';
  }
};

/* ================= REALTIME TABLE PANEL ================= */
const realtimeTablePanel = document.getElementById('realtimeTablePanel');
const realtimeTablePanelHeader = document.getElementById('realtimeTablePanelHeader');
const realtimeTablePanelChevron = document.getElementById('realtimeTablePanelChevron');
const realtimeTableContainer = document.getElementById('realtimeTableContainer');
const realtimeDataTable = document.getElementById('realtimeDataTable');

// Toggle panel visibility
realtimeTablePanelHeader.addEventListener('click', (e) => {
  e.stopPropagation();
  const isMinimized = realtimeTablePanel.classList.toggle('minimized');
  realtimeTablePanelChevron.classList.toggle('rotated', isMinimized);
  
  if (isMinimized) {
    realtimeTableContainer.style.display = 'none';
  } else {
    realtimeTableContainer.style.display = 'block';
  }
});

// Store real-time table data
window.realtimeTableData = {};
window.realtimeTableHeaders = ['Tracker ID'];

// Function to update the real-time data table
window.updateRealtimeTable = function(trackerId, data) {
  if (trackerId && data) {
    window.realtimeTableData[trackerId] = data;
  }
  
  // Get all selected parameters
  const allSelectedParams = new Set(['Tracker ID']);
  Object.keys(window.realtimeTableData).forEach(tid => {
    const params = window.getRealtimeParameters ? window.getRealtimeParameters(tid) : null;
    if (params) {
      Object.keys(params).forEach(param => {
        if (params[param]) allSelectedParams.add(param);
      });
    }
  });
  
  window.realtimeTableHeaders = Array.from(allSelectedParams);
  
  // Update table headers
  const thead = realtimeDataTable.querySelector('thead');
  const headerRow = thead.querySelector('tr');
  headerRow.innerHTML = '';
  
  window.realtimeTableHeaders.forEach(header => {
    const th = document.createElement('th');
    th.textContent = formatHeaderText(header);
    headerRow.appendChild(th);
  });
  
  // Update table body
  const tbody = realtimeDataTable.querySelector('tbody');
  tbody.innerHTML = '';
  
  if (Object.keys(window.realtimeTableData).length === 0) {
    const noDataRow = document.createElement('tr');
    noDataRow.className = 'no-data-row';
    const td = document.createElement('td');
    td.colSpan = window.realtimeTableHeaders.length;
    td.textContent = 'No tracker data available. Fetch a tracker first.';
    noDataRow.appendChild(td);
    tbody.appendChild(noDataRow);
    return;
  }
  
  Object.keys(window.realtimeTableData).forEach(tid => {
    const row = document.createElement('tr');
    
    window.realtimeTableHeaders.forEach(header => {
      const td = document.createElement('td');
      
      if (header === 'Tracker ID') {
        td.className = 'tracker-id-cell';
        td.textContent = tid;
      } else {
        const params = window.getRealtimeParameters ? window.getRealtimeParameters(tid) : null;
        if (params && params[header] && window.realtimeTableData[tid][header]) {
          td.textContent = formatCellValue(header, window.realtimeTableData[tid][header]);
        } else {
          td.textContent = '-';
          td.style.color = '#9ca3af';
        }
      }
      
      row.appendChild(td);
    });
    
    tbody.appendChild(row);
  });
};

function formatHeaderText(header) {
  const formatMap = {
    'timestamp': 'Timestamp',
    'latitude': 'Latitude',
    'longitude': 'Longitude',
    'altitude': 'Altitude',
    'uin_no': 'UIN No',
    'application': 'Application',
    'category': 'Category',
    'Tracker ID': 'Tracker ID'
  };
  return formatMap[header] || header;
}

function formatCellValue(header, value) {
  if (header === 'timestamp' && value) {
    try {
      return new Date(value).toLocaleString();
    } catch (e) {
      return value;
    }
  }
  if ((header === 'latitude' || header === 'longitude') && value) {
    return parseFloat(value).toFixed(6);
  }
  if (header === 'altitude' && value) {
    return `${parseFloat(value).toFixed(1)} m`;
  }
  return value || '-';
}

// Initialize table
window.updateRealtimeTable();

/* ================= STORAGE ================= */
const STORAGE_KEY = "saved_trackers";
const GROUP_KEY = "tracker_groups";
const REALTIME_SETTINGS_KEY = "realtime_parameters";
let activeGroup = null;
let selectedTrackerForRealtime = null;

const getSavedTrackers = () => JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
const saveTracker = (id) => {
  const trackers = getSavedTrackers();
  if (!trackers.includes(id)) {
    trackers.push(id);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(trackers));
  }
};

const getGroups = () => JSON.parse(localStorage.getItem(GROUP_KEY)) || {};
const saveGroups = (groups) => localStorage.setItem(GROUP_KEY, JSON.stringify(groups));

/* ================= REALTIME DATA SETTINGS ================= */
const getRealtimeSettings = () => JSON.parse(localStorage.getItem(REALTIME_SETTINGS_KEY)) || {};
const saveRealtimeSettings = (settings) => localStorage.setItem(REALTIME_SETTINGS_KEY, JSON.stringify(settings));

const availableParameters = [
  { id: 'timestamp', label: 'Timestamp', default: true },
  { id: 'latitude', label: 'Latitude', default: true },
  { id: 'longitude', label: 'Longitude', default: true },
  { id: 'altitude', label: 'Altitude', default: true },
  { id: 'uin_no', label: 'UIN No', default: true },
  { id: 'application', label: 'Application', default: true },
  { id: 'category', label: 'Category', default: true }
];

/* ================= TAG POPUP FUNCTIONS ================= */
const tagPopup = document.getElementById("tagPopup");
const trackerList = document.getElementById("trackerList");
const trackerInput = document.getElementById("tracker-id");

document.getElementById("openTagPopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  tagPopup.style.maxHeight = "600px";
  tagPopup.classList.remove("collapsed");
  document.getElementById("tagPopupChevron").classList.add("rotate");
  renderTrackers();
};

function renderTrackers() {
  trackerList.innerHTML = "";
  getSavedTrackers().forEach(id => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = id;
    div.onclick = () => handleFetch(id);
    trackerList.appendChild(div);
  });
}

function handleFetch(id) {
  if (!id) return;
  trackerInput.value = id;
  saveTracker(id);
  renderTrackers();
  if (typeof fetchDroneData === "function") {
    fetchDroneData(id);
  }
}

document.getElementById("fetch-btn").onclick = () => handleFetch(trackerInput.value.trim());
document.getElementById("addTrackerBtn").onclick = () => {
  const val = document.getElementById("newTracker").value.trim();
  if (!val) return;
  saveTracker(val);
  renderTrackers();
  document.getElementById("newTracker").value = "";
};

/* ================= GROUP POPUP FUNCTIONS ================= */
const groupPopup = document.getElementById("groupPopup");
const groupList = document.getElementById("groupList");

document.getElementById("openGroupPopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  groupPopup.style.maxHeight = "600px";
  groupPopup.classList.remove("collapsed");
  document.getElementById("groupPopupChevron").classList.add("rotate");
  renderGroups();
};

function renderGroups() {
  groupList.innerHTML = "";
  const groups = getGroups();
  Object.keys(groups).forEach(groupName => {
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.textContent = groupName;
    div.addEventListener("click", () => {
      openGroupDetail(groupName);
      groupDetailPopup.style.maxHeight = "600px";
      groupDetailPopup.classList.remove("collapsed");
    });
    groupList.appendChild(div);
  });
}

document.getElementById("createGroupBtn").onclick = () => {
  const name = document.getElementById("groupNameInput").value.trim();
  if (!name) return;
  const groups = getGroups();
  if (!groups[name]) groups[name] = [];
  saveGroups(groups);
  document.getElementById("groupNameInput").value = "";
  renderGroups();
};

/* ================= GROUP DETAIL POPUP ================= */
const groupDetailPopup = document.getElementById("groupDetailPopup");
const groupTrackerList = document.getElementById("groupTrackerList");
const groupDetailTitle = document.getElementById("groupDetailTitle");

let groupSettings = JSON.parse(localStorage.getItem('groupSettings')) || {};
const defaultColors = [
  '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', 
  '#EF476F', '#9D4EDD', '#FB5607', '#3A86FF', '#8338EC'
];

function openGroupDetail(groupName) {
  if (window.setActiveGroup) window.setActiveGroup(groupName);
  activeGroup = groupName;
  groupDetailTitle.textContent = groupName;
  const groups = getGroups();
  groupTrackerList.innerHTML = "";
  
  if (!groupSettings[groupName]) groupSettings[groupName] = {};
  
  (groups[groupName] || []).forEach((tid, index) => {
    if (!groupSettings[groupName][tid]) {
      groupSettings[groupName][tid] = {
        visible: true,
        color: defaultColors[index % defaultColors.length]
      };
    }
    
    const div = document.createElement("div");
    div.className = "tracker-option";
    div.dataset.trackerId = tid;
    
    const checkboxContainer = document.createElement("div");
    checkboxContainer.className = "checkbox-container";
    
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "tracker-checkbox";
    checkbox.checked = groupSettings[groupName][tid].visible;
    checkbox.dataset.trackerId = tid;
    
    const colorPicker = document.createElement("input");
    colorPicker.type = "color";
    colorPicker.className = "tracker-color-picker";
    colorPicker.value = groupSettings[groupName][tid].color;
    colorPicker.dataset.trackerId = tid;
    colorPicker.style.display = "none";
    
    const colorPreview = document.createElement("div");
    colorPreview.className = "color-preview";
    colorPreview.style.backgroundColor = groupSettings[groupName][tid].color;
    
    const trackerIdSpan = document.createElement("span");
    trackerIdSpan.className = "tracker-id-text";
    trackerIdSpan.textContent = tid;
    trackerIdSpan.dataset.trackerId = tid;
    
    trackerIdSpan.onclick = () => {
      if (window.handleFetch) window.handleFetch(tid);
    };
    
    checkbox.onchange = (e) => {
      const trackerId = e.target.dataset.trackerId;
      const isVisible = e.target.checked;
      groupSettings[groupName][trackerId].visible = isVisible;
      saveGroupSettings();
      if (window.updateTrackerVisibilityFromGroup) {
        window.updateTrackerVisibilityFromGroup(trackerId, isVisible);
      }
    };
    
    colorPicker.onchange = (e) => {
      const trackerId = e.target.dataset.trackerId;
      const newColor = e.target.value;
      groupSettings[groupName][trackerId].color = newColor;
      saveGroupSettings();
      colorPreview.style.backgroundColor = newColor;
      if (window.updateTrackerColorFromGroup) {
        window.updateTrackerColorFromGroup(trackerId, newColor);
      }
    };
    
    colorPreview.onclick = () => colorPicker.click();
    
    checkboxContainer.appendChild(checkbox);
    checkboxContainer.appendChild(colorPreview);
    div.appendChild(checkboxContainer);
    div.appendChild(colorPicker);
    div.appendChild(trackerIdSpan);
    groupTrackerList.appendChild(div);
  });
  
  saveGroupSettings();
}

function saveGroupSettings() {
  localStorage.setItem('groupSettings', JSON.stringify(groupSettings));
}

// Add tracker to group (from group popup)
document.getElementById("addTrackerToGroupBtn").onclick = () => {
  if (!activeGroup) {
    alert("Select a group first");
    return;
  }
  const tracker = document.getElementById("groupTrackerInput").value.trim();
  if (!tracker) return;
  const groups = getGroups();
  if (!groups[activeGroup].includes(tracker)) {
    groups[activeGroup].push(tracker);
    saveGroups(groups);
  }
  document.getElementById("groupTrackerInput").value = "";
  renderGroups();
};

// Add tracker to group (from group detail popup)
document.getElementById("addTrackerToGroupDetailBtn").onclick = () => {
  if (!activeGroup) return;
  const tracker = document.getElementById("groupDetailTrackerInput").value.trim();
  if (!tracker) return;
  const groups = getGroups();
  if (!groups[activeGroup].includes(tracker)) {
    groups[activeGroup].push(tracker);
    saveGroups(groups);
    if (!groupSettings[activeGroup]) groupSettings[activeGroup] = {};
    const index = groups[activeGroup].length - 1;
    groupSettings[activeGroup][tracker] = {
      visible: true,
      color: defaultColors[index % defaultColors.length]
    };
    saveGroupSettings();
  }
  document.getElementById("groupDetailTrackerInput").value = "";
  openGroupDetail(activeGroup);
};

// Fetch group button
document.getElementById("fetchGroupBtn").onclick = () => {
  if (!activeGroup) {
    alert("Select a group first");
    return;
  }
  const groups = getGroups();
  const trackerIds = groups[activeGroup] || [];
  if (trackerIds.length === 0) {
    alert("No trackers in this group");
    return;
  }
  if (window.fetchGroupTrackers) window.fetchGroupTrackers(trackerIds);
};

/* ================= REALTIME DATA POPUP ================= */
const realtimePopup = document.getElementById("realtimePopup");
const realtimeGroupList = document.getElementById("realtimeGroupList");

document.getElementById("openRealtimePopup").onclick = (e) => {
  e.stopPropagation();
  closeAllPopups();
  realtimePopup.style.maxHeight = "600px";
  realtimePopup.classList.remove("collapsed");
  document.getElementById("realtimePopupChevron").classList.add("rotate");
  renderRealtimeGroups();
};

function renderRealtimeGroups() {
  realtimeGroupList.innerHTML = "";
  const groups = getGroups();
  
  if (Object.keys(groups).length === 0) {
    realtimeGroupList.innerHTML = `
      <div style="padding: 20px; text-align: center; color: #6b7280;">
        No groups found. Create groups first.
      </div>
    `;
    return;
  }
  
  Object.keys(groups).forEach(groupName => {
    const groupDiv = document.createElement("div");
    groupDiv.className = "realtime-group-header";
    groupDiv.innerHTML = `
      <i data-lucide="folder" style="width: 16px; height: 16px; margin-right: 8px; color: #6366f1;"></i>
      <span class="realtime-group-name">${groupName}</span>
      <i data-lucide="chevron-right" class="group-expand-btn" style="width: 16px; height: 16px;"></i>
    `;
    
    const trackerList = document.createElement("div");
    trackerList.className = "realtime-tracker-list";
    trackerList.style.display = "none";
    
    groups[groupName].forEach(trackerId => {
      const trackerDiv = document.createElement("div");
      trackerDiv.className = "realtime-tracker-item";
      trackerDiv.dataset.trackerId = trackerId;
      trackerDiv.dataset.groupName = groupName;
      trackerDiv.innerHTML = `
        <i data-lucide="tag" style="width: 14px; height: 14px; margin-right: 8px; color: #6b7280;"></i>
        <span class="realtime-tracker-id">${trackerId}</span>
      `;
      trackerDiv.onclick = (e) => {
        e.stopPropagation();
        showTrackerParameters(trackerId);
      };
      trackerList.appendChild(trackerDiv);
    });
    
    const chevron = groupDiv.querySelector(".group-expand-btn");
    groupDiv.onclick = () => {
      const isExpanded = trackerList.style.display === "block";
      trackerList.style.display = isExpanded ? "none" : "block";
      chevron.classList.toggle("rotated", !isExpanded);
      lucide.createIcons();
    };
    
    realtimeGroupList.appendChild(groupDiv);
    realtimeGroupList.appendChild(trackerList);
  });
  
  lucide.createIcons();
}

function showTrackerParameters(trackerId) {
  selectedTrackerForRealtime = trackerId;
  document.getElementById("selectedTrackerId").textContent = trackerId;
  document.getElementById("trackerParametersSection").style.display = "block";
  
  const parametersContainer = document.getElementById("parametersCheckboxes");
  parametersContainer.innerHTML = "";
  
  const settings = getRealtimeSettings();
  const trackerSettings = settings[trackerId] || {};
  
  availableParameters.forEach(param => {
    const div = document.createElement("div");
    div.className = "parameter-option";
    const checkboxId = `param_${trackerId}_${param.id}`;
    const isChecked = trackerSettings[param.id] !== undefined ? 
                      trackerSettings[param.id] : param.default;
    div.innerHTML = `
      <input type="checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}>
      <label for="${checkboxId}">${param.label}</label>
    `;
    const checkbox = div.querySelector('input');
    checkbox.onchange = () => {};
    parametersContainer.appendChild(div);
  });
}

document.getElementById("saveParametersBtn").onclick = () => {
  if (!selectedTrackerForRealtime) {
    alert("Please select a tracker first");
    return;
  }
  const settings = getRealtimeSettings();
  settings[selectedTrackerForRealtime] = settings[selectedTrackerForRealtime] || {};
  availableParameters.forEach(param => {
    const checkboxId = `param_${selectedTrackerForRealtime}_${param.id}`;
    const checkbox = document.getElementById(checkboxId);
    if (checkbox) settings[selectedTrackerForRealtime][param.id] = checkbox.checked;
  });
  saveRealtimeSettings(settings);
  const btn = document.getElementById("saveParametersBtn");
  const originalText = btn.textContent;
  btn.textContent = "Saved!";
  btn.style.background = "#10b981";
  setTimeout(() => {
    btn.textContent = originalText;
    btn.style.background = "#6366f1";
  }, 1500);
  if (window.realtimeTableData && window.realtimeTableData[selectedTrackerForRealtime]) {
    window.updateRealtimeTable();
  }
};

window.getRealtimeParameters = function(trackerId) {
  const settings = getRealtimeSettings();
  const trackerSettings = settings[trackerId];
  if (!trackerSettings) {
    return availableParameters.reduce((acc, param) => {
      acc[param.id] = param.default;
      return acc;
    }, {});
  }
  return trackerSettings;
};

window.formatRealtimeData = function(data, trackerId) {
  const parameters = window.getRealtimeParameters(trackerId);
  const formatted = { 'Tracker ID': trackerId };
  Object.keys(parameters).forEach(param => {
    if (parameters[param] && data[param] !== undefined) {
      formatted[param] = data[param];
    }
  });
  return formatted;
};

// Make realtime group dropdown collapsible
document.getElementById("realtimeGroupHeader").onclick = () => {
  const chevron = document.getElementById("realtimeGroupChevron");
  const dropdown = document.getElementById("realtimeGroupList");
  const isCollapsed = dropdown.style.display === "none";
  dropdown.style.display = isCollapsed ? "block" : "none";
  chevron.classList.toggle("rotate", isCollapsed);
};

/* ================= WINDOW RESIZE HANDLER ================= */
function handleResize() {
  const isMobile = window.innerWidth <= 768;
  if (!isMobile) {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
  }
}

window.addEventListener('resize', handleResize);
handleResize();

/* ================= INITIALIZATION ================= */
renderTrackers();
renderSensors();
renderGroups();

// Close popups when clicking Escape key or outside
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeAllPopups();
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
  }
});

// Close popups when clicking outside
document.addEventListener('click', (e) => {
  const popups = document.querySelectorAll('.tag-popup');
  const isClickInsidePopup = Array.from(popups).some(popup => popup.contains(e.target));
  const isClickInsideSidebar = sidebar.contains(e.target);
  const isClickOnMobileToggle = mobileMenuToggle.contains(e.target);
  
  if (!isClickInsidePopup && !isClickInsideSidebar && !isClickOnMobileToggle) {
    closeAllPopups();
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  // Alt+S for sensor panel
  if (e.altKey && e.key === 's') {
    e.preventDefault();
    const sensorPanel = document.getElementById('sensorTablePanel');
    const sensorHeader = document.getElementById('sensorTablePanelHeader');
    if (sensorPanel && sensorHeader) {
      sensorHeader.click();
    }
  }
  
  // Alt+T for tracker panel
  if (e.altKey && e.key === 't') {
    e.preventDefault();
    const trackerPanel = document.getElementById('realtimeTablePanel');
    const trackerHeader = document.getElementById('realtimeTablePanelHeader');
    if (trackerPanel && trackerHeader) {
      trackerHeader.click();
    }
  }
});
</script>

</body>
</html>